<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STORE-SIGHT</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Firebase SDK (ES Module) -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where,
            orderBy,
            serverTimestamp,
            runTransaction,
            writeBatch,
            getDocs,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- GLOBAL VARIABLES ---
        let db, auth;
        let currentUserId, currentUserEmail, currentUserRole;
        let currentUserProfile = null;
        let lastRequestCache = null;
        
        // Data Caches
        let inventoryCache = [];
        let localRequestCache = []; // Renamed from localCartCache
        let userRolesCache = []; // Cache for dashboard

        // Listeners
        let unsubscribePublicInventory = () => {};
        let unsubscribeInventory = () => {};
        let unsubscribeRequestList = () => {}; // Renamed
        let unsubscribeUserRequests = () => {}; // Renamed
        let unsubscribeManagerRequests = () => {}; // Renamed
        let unsubscribeUserRoles = () => {};
        let unsubscribeActivityLog = () => {};
        let unsubscribeDashboardLogs = () => {};

        // --- USER'S FIREBASE CONFIG ---
        // This config is public. For a real app, you'd secure this.
        const firebaseConfig = {
          apiKey: "AIzaSyDmCSYXnlcXfxt-MvoEkGs0ilVW-E2_Ex4",
          authDomain: "hubli-store.firebaseapp.com",
          projectId: "hubli-store",
          storageBucket: "hubli-store.firebasestorage.app",
          messagingSenderId: "324782981287",
          appId: "1:324782981287:web:10f6b46d6a5f222a155b82",
          measurementId: "G-FRFB45079Q"
        };
        
        const appId = firebaseConfig.projectId; // Using "hubli-store"
        // --- END OF CONFIG ---


        // --- DATABASE PATHS ---
        const getInventoryCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
        const getUserRolesCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'user_roles');
        const getRequestsCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'orders'); // "orders" collection in DB
        const getActivityLogCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'activity_log');
        const getUserRequestListCollection = (userId) => collection(db, 'artifacts', appId, 'users', userId, 'cart'); // "cart" collection in DB
        
        // Helper function for logging all actions
        async function logActivity(action, details = {}) {
            try {
                const user = currentUserProfile?.name || currentUserEmail || "System";
                await addDoc(getActivityLogCollection(), {
                    timestamp: serverTimestamp(),
                    action: action,
                    user: user,
                    userId: currentUserId || null,
                    details: details // e.g., { itemId: "...", newName: "..." }
                });
            } catch (error) {
                console.error("Failed to log activity:", error);
            }
        }

        // --- 1. INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Error'); // Keep console clean
                
                // Start public listener *before* auth
                setupPublicInventoryListener(); 
                
                setupAuthListener();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                const publicError = document.getElementById('public-inventory-error');
                if (publicError) {
                    publicError.textContent = "Error connecting to inventory services. Please refresh.";
                    publicError.classList.remove('hidden');
                }
            }
        }
        
        // --- UPDATED PUBLIC LISTENER (WITH FILTERS) ---
        function setupPublicInventoryListener() {
            // --- NEW: Attach listeners here ---
            const categoryFilter = document.getElementById('public-category-filter');
            const searchFilter = document.getElementById('public-search-filter');
            
            let publicInventoryCache = []; // Cache for public view
            
            const reRenderPublic = () => {
                if(publicInventoryCache.length > 0) {
                    renderPublicInventory(publicInventoryCache);
                }
            };
            
            if (categoryFilter) {
                categoryFilter.addEventListener('input', reRenderPublic);
            }
            if (searchFilter) {
                searchFilter.addEventListener('input', reRenderPublic);
            }
            // --- End of new listener attachment ---
            
            const inventoryQuery = query(getInventoryCollection(), orderBy('name'));
            unsubscribePublicInventory = onSnapshot(inventoryQuery, (snapshot) => {
                publicInventoryCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Update cache
                renderPublicInventory(publicInventoryCache); // Initial render
                
                // Find the most recent update time
                let lastUpdate = null;
                publicInventoryCache.forEach(item => {
                    const addTime = item.lastAddition?.date?.toDate();
                    const withdrawTime = item.lastWithdrawal?.date?.toDate();
                    if (addTime && (!lastUpdate || addTime > lastUpdate)) lastUpdate = addTime;
                    if (withdrawTime && (!lastUpdate || withdrawTime > lastUpdate)) lastUpdate = withdrawTime;
                });
                
                const updateEl = document.getElementById('last-update-time');
                if (updateEl) {
                    updateEl.textContent = lastUpdate ? `Last inventory update: ${lastUpdate.toLocaleString()}` : `Inventory up-to-date.`;
                }

            }, (error) => {
                console.error("Public inventory listener error:", error);
                const publicError = document.getElementById('public-inventory-error');
                if (publicError) {
                    publicError.textContent = "Could not load inventory. Check connection or contact admin.";
                    publicError.classList.remove('hidden');
                }
            });
        }

        // --- 2. AUTHENTICATION & PROFILE ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                unsubscribeAll(); // Unsubscribe auth-only listeners
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    await checkUserRoleAndProfile(user);
                } else {
                    currentUserId = null;
                    currentUserEmail = null;
                    currentUserRole = null;
                    currentUserProfile = null;
                    showView('public-view'); // Default to public view on logout
                }
            });
        }

        async function checkUserRoleAndProfile(user) {
            const userId = user.uid;
            const userRoleRef = doc(getUserRolesCollection(), userId);
            const userDoc = await getDoc(userRoleRef);

            if (userDoc.exists()) {
                const data = userDoc.data();
                currentUserRole = data.role; // 'user', 'manager', or 'superuser'
                currentUserProfile = {
                    name: data.name || '',
                    empId: data.empId || '',
                    designation: data.designation || '',
                    email: data.email || user.email,
                    status: data.status || 'pending'
                };
                
                // --- Robust Status Check ---
                
                // 1. Suspended? Stop immediately.
                if (currentUserProfile.status === 'suspended') {
                    showView('suspended-view');
                    return;
                }
                
                // 2. Profile incomplete? Force setup.
                if (!currentUserProfile.name) {
                    renderProfilePage(true); // 'true' for isFirstTime setup
                    showView('profile-setup-view');
                    return;
                }
                
                // 3. Profile complete, but pending? Force wait.
                // (Managers/Superusers skip this check)
                if (currentUserProfile.status === 'pending' && currentUserRole === 'user') {
                    showView('pending-view');
                    return;
                }
                
                // 4. Active user, or manager/superuser? Let them in.
                if (currentUserProfile.status === 'active' || currentUserRole === 'manager' || currentUserRole === 'superuser') {
                    showView('app-container');
                    document.getElementById('user-id-display').textContent = `User: ${currentUserProfile.name} (Emp ID: ${currentUserProfile.empId})`;
                    document.getElementById('user-role-display').textContent = `Role: ${currentUserRole}`;
                    setupUIForRole(currentUserRole);
                    attachDataListeners(currentUserRole, userId);
                    return;
                }

                // Fallback (shouldn't be reached)
                console.warn("Unhandled user state:", currentUserProfile);
                showView('public-view');
                
            } else {
                // New user: Create a default 'user' role, force profile setup, and set status to 'pending'
                const emailEmpId = user.email.split('@')[0].split('-')[1] || null;

                currentUserRole = 'user';
                await setDoc(userRoleRef, { 
                    role: 'user', 
                    status: 'pending', // All new users are pending
                    created: serverTimestamp(),
                    userId: userId,
                    email: user.email,
                    name: "", 
                    empId: emailEmpId, // Save the Employee ID
                    designation: ""
                });
                await logActivity("User Registered", { email: user.email, empId: emailEmpId });
                // Recurse to trigger profile setup
                await checkUserRoleAndProfile(user);
            }
        }

        async function handleProfileUpdate(isFirstTime) {
            const name = document.getElementById('profile-name').value.trim();
            const empId = document.getElementById('profile-empId').value.trim(); // This is read-only, but we get it
            const designation = document.getElementById('profile-designation').value.trim();
            
            if (!name || !empId || !designation) {
                showToast("Please fill in all profile fields.", true);
                return;
            }
            
            const userRoleRef = doc(getUserRolesCollection(), currentUserId);
            try {
                await updateDoc(userRoleRef, {
                    name: name,
                    empId: empId,
                    designation: designation
                    // Status remains 'pending'
                });
                
                if (isFirstTime) {
                    await logActivity("Profile Completed", { name: name });
                }

                currentUserProfile = { ...currentUserProfile, name, empId, designation };
                showToast("Profile updated successfully!");
                
                await checkUserRoleAndProfile(auth.currentUser);

            } catch (error) {
                console.error("Profile update error:", error);
                showToast("Failed to update profile.", true);
            }
        }
        
        async function handleRegister() {
            const empId = document.getElementById('register-empid').value.trim();
            const pin = document.getElementById('register-pin').value.trim();
            
            if (!empId || !pin) {
                showAuthError("Please enter both Employee ID and PIN.");
                return;
            }
            if (!/^\d{4}$/.test(pin)) {
                showAuthError("PIN must be exactly 4 digits.");
                return;
            }

            // --- FIX FOR 6-CHAR PASSWORD ---
            // user-12345@hubli-store.app
            const email = `user-${empId}@hubli-store.app`;
            // PIN-1234
            const password = `PIN-${pin}`; // Add prefix
            
            try {
                showAuthLoading(true);
                await createUserWithEmailAndPassword(auth, email, password);
                showAuthLoading(false);
                showAuthError("");
            } catch (error) {
                console.error("Registration Error:", error);
                showAuthError(getFriendlyAuthError(error));
                showAuthLoading(false);
            }
        }

        async function handleLogin() {
            const empId = document.getElementById('login-empid').value.trim();
            const pin = document.getElementById('login-pin').value.trim();
            
            if (!empId || !pin) {
                showAuthError("Please enter both Employee ID and PIN.");
                return;
            }
            
            // --- FIX FOR 6-CHAR PASSWORD ---
            const email = `user-${empId}@hubli-store.app`;
            const password = `PIN-${pin}`; // Add prefix

            try {
                showAuthLoading(true);
                await signInWithEmailAndPassword(auth, email, password);
                showAuthLoading(false);
                showAuthError("");
            } catch (error) {
                console.error("Login Error:", error);
                showAuthError(getFriendlyAuthError(error));
                showAuthLoading(false);
            }
        }

        async function handleLogout() {
            await signOut(auth);
            // Auth listener will automatically route to public-view
        }
        
        function getFriendlyAuthError(error) {
            switch (error.code) {
                case 'auth/invalid-email': return 'Please enter a valid Employee ID.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Invalid Employee ID or PIN.';
                case 'auth/email-already-in-use': return 'This Employee ID is already registered.';
                case 'auth/weak-password': return 'PIN must be at least 4 digits.';
                default: return 'An error occurred. Please try again.';
            }
        }

        // --- 3. UI & VIEW MANAGEMENT ---
        function showView(viewId) {
            ['loading-view', 'public-view', 'login-view', 'app-container', 'profile-setup-view', 'pending-view', 'suspended-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        function toggleAuthForms(showRegister) {
            document.getElementById('login-form').classList.toggle('hidden', showRegister);
            document.getElementById('register-form').classList.toggle('hidden', !showRegister);
            showAuthError("");
        }
        
        function showAuthError(message) {
            const errorEl = document.getElementById('auth-error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.toggle('hidden', !message);
            }
        }

        function showAuthLoading(isLoading) {
            document.getElementById('login-button').disabled = isLoading;
            document.getElementById('register-button').disabled = isLoading;
            document.getElementById('login-spinner').classList.toggle('hidden', !isLoading);
            document.getElementById('register-spinner').classList.toggle('hidden', !isLoading);
        }

        function setupUIForRole(role) {
            const isManagerOrSuper = (role === 'manager' || role === 'superuser');
            
            // Hide all main interfaces first
            document.getElementById('user-interface').classList.add('hidden');
            document.getElementById('manager-interface').classList.add('hidden');
            document.getElementById('request-summary-page').classList.add('hidden');
            document.getElementById('user-profile-page').classList.add('hidden');
            
            // Show/hide superuser-only tabs
            document.getElementById('bulk-import-nav-btn').classList.toggle('hidden', role !== 'superuser');

            if (isManagerOrSuper) {
                document.getElementById('manager-interface').classList.remove('hidden');
                document.getElementById('manager-nav').classList.remove('hidden');
                document.getElementById('user-nav').classList.add('hidden');
                showManagerTab('dashboard-tab');
            } else {
                document.getElementById('user-interface').classList.remove('hidden');
                document.getElementById('manager-nav').classList.add('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                showUserPage('user-inventory-page');
            }
        }
        
        function showUserPage(pageId) {
            // Hide all user pages
            ['user-inventory-page', 'user-request-page', 'user-checkout-page', 'user-requests-page', 'user-profile-page'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            // Show the target user page
            const targetEl = document.getElementById(pageId);
            if (targetEl) targetEl.classList.remove('hidden');
            
            // Set active tab style
            document.querySelectorAll('#user-nav button').forEach(btn => {
                if (btn.getAttribute('data-page') === pageId) {
                    btn.classList.add('bg-red-100', 'text-red-700');
                    btn.classList.remove('text-gray-700', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-red-100', 'text-red-700');
                    btn.classList.add('text-gray-700', 'hover:bg-gray-100');
                }
            });

            if (pageId === 'user-checkout-page') renderCheckoutPage();
            if (pageId === 'user-profile-page') renderProfilePage(false);
        }

        function showManagerTab(tabId) {
            // Hide all manager tabs
            ['dashboard-tab', 'inventory-mgt-tab', 'user-mgt-tab', 'manager-requests-tab', 'activity-log-tab', 'user-profile-page', 'bulk-import-tab'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            // Also hide the summary page when changing tabs
            document.getElementById('request-summary-page').classList.add('hidden');
            
            // Set active tab style
            document.querySelectorAll('#manager-nav button').forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.replace('bg-gray-700', 'bg-red-700');
                    btn.classList.remove('hover:bg-red-600');
                } else {
                    btn.classList.replace('bg-red-700', 'bg-gray-700');
                    btn.classList.add('hover:bg-red-600');
                }
            });
            
            // Show the target manager tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) targetTab.classList.remove('hidden');

            if (tabId === 'user-profile-page') renderProfilePage(false);
            if (tabId === 'dashboard-tab') renderDashboard(); // Re-render dashboard on view
        }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-message');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.remove('hidden', 'opacity-0');
            toast.classList.toggle('bg-red-600', isError);
            toast.classList.toggle('bg-green-600', !isError);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500);
            }, 3000);
        }
        
        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => {
                onConfirm();
                closeConfirmationModal();
            };
            
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }
        
        function closeItemHistoryModal() {
            document.getElementById('item-history-modal').classList.add('hidden');
        }


        // --- 4. DATA LISTENERS ---
        function attachDataListeners(role, userId) {
            const isManagerOrSuper = (role === 'manager' || role === 'superuser');
            
            // 1. Listen to Inventory (all auth'd users)
            const inventoryQuery = query(getInventoryCollection(), orderBy('name'));
            unsubscribeInventory = onSnapshot(inventoryQuery, (snapshot) => {
                inventoryCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (role === 'user') {
                    renderUserInventory(inventoryCache);
                    renderUserRequestList(localRequestCache, inventoryCache); // Re-render list with fresh names
                }
                if (isManagerOrSuper) {
                    renderManagerInventory(inventoryCache);
                    if (document.getElementById('dashboard-tab').offsetParent) {
                        renderDashboard(); // Re-render dashboard if it's visible
                    }
                }
            }, (error) => console.error("Inventory listener error:", error));

            // 2. Listen to User Request List (only for regular users)
            if (role === 'user') {
                const requestListQuery = query(getUserRequestListCollection(userId));
                unsubscribeRequestList = onSnapshot(requestListQuery, (snapshot) => {
                    localRequestCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserRequestList(localRequestCache, inventoryCache);
                }, (error) => console.error("Request list listener error:", error));
            }
            
            // 3. Listen to User Requests (only for regular users)
            if (role === 'user') {
                const userRequestsQuery = query(getRequestsCollection(), where('userId', '==', userId), orderBy('createdAt', 'desc'));
                unsubscribeUserRequests = onSnapshot(userRequestsQuery, (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserRequests(requests);
                }, (error) => {
                    console.error("User requests listener error:", error);
                    // --- BUGFIX: Show error in UI if index is missing ---
                    const list = document.getElementById('user-requests-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-600 font-medium">Error loading history. The database may be missing a required index. Please contact your administrator.</p>
                        <p class="text-sm text-gray-600">Admin: See Step 6 in the setup guide to create the 'orders' index.</p>`;
                    }
                });
            }

            // 4. Listen to User Roles, All Requests, Activity Log (only for managers/supers)
            if (isManagerOrSuper) {
                // User Roles
                const usersQuery = query(getUserRolesCollection(), orderBy('created', 'desc'));
                unsubscribeUserRoles = onSnapshot(usersQuery, (snapshot) => {
                    userRolesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserRoles(userRolesCache);
                    if (document.getElementById('dashboard-tab').offsetParent) {
                        renderDashboard(); // Re-render dashboard for pending user count
                    }
                }, (error) => console.error("User roles listener error:", error));
                
                // All Requests
                const allRequestsQuery = query(getRequestsCollection(), orderBy('createdAt', 'desc'));
                unsubscribeManagerRequests = onSnapshot(allRequestsQuery, (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderManagerRequests(requests);
                }, (error) => console.error("Manager requests listener error:", error));
                
                // Full Activity Log
                const logQuery = query(getActivityLogCollection(), orderBy('timestamp', 'desc'), limit(50));
                unsubscribeActivityLog = onSnapshot(logQuery, (snapshot) => {
                    const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderActivityLog(logs);
                }, (error) => console.error("Activity log listener error:", error));
                
                // Dashboard Activity Log (just 5 items)
                const dashLogQuery = query(getActivityLogCollection(), orderBy('timestamp', 'desc'), limit(5));
                unsubscribeDashboardLogs = onSnapshot(dashLogQuery, (snapshot) => {
                    if (document.getElementById('dashboard-tab').offsetParent) {
                        renderDashboardRecentActivity(snapshot.docs);
                    }
                }, (error) => console.error("Dashboard log listener error:", error));
            }
        }

        function unsubscribeAll() {
            unsubscribeInventory();
            unsubscribeRequestList();
            unsubscribeUserRequests();
            unsubscribeManagerRequests();
            unsubscribeUserRoles();
            unsubscribeActivityLog();
            unsubscribeDashboardLogs();
        }

        // --- 5. REGULAR USER: ACTIONS & RENDERING ---
        async function handleAddToRequest(itemId, itemName, maxStock) { // Renamed
            if (maxStock <= 0) {
                showToast("Item is out of stock.", true);
                return;
            }
            
            const requestItemRef = doc(getUserRequestListCollection(currentUserId), itemId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const requestItemDoc = await transaction.get(requestItemRef);
                    
                    if (requestItemDoc.exists()) {
                        const newQuantity = requestItemDoc.data().quantity + 1;
                        if (newQuantity > maxStock) {
                            throw new Error("Cannot add more than available stock.");
                        }
                        transaction.update(requestItemRef, { quantity: newQuantity });
                    } else {
                        // Find full item data
                        const inventoryItem = inventoryCache.find(item => item.id === itemId);
                        transaction.set(requestItemRef, {
                            productId: itemId,
                            productName: inventoryItem.name, // Use full name
                            itemCode: inventoryItem.itemCode,
                            category: inventoryItem.category,
                            quantity: 1,
                            addedAt: serverTimestamp()
                        });
                    }
                });
                showToast("Item added to request list!");
            } catch (error) {
                console.error("Add to list error:", error.message);
                showToast(error.message || "Could not add item.", true);
            }
        }

        async function handleUpdateRequestQuantity(itemId, newQuantity) { // Renamed
            const requestItemRef = doc(getUserRequestListCollection(currentUserId), itemId);
            if (newQuantity <= 0) {
                await deleteDoc(requestItemRef);
                showToast("Item removed from list.");
            } else {
                const inventoryItem = inventoryCache.find(item => item.id === itemId);
                if (inventoryItem && newQuantity > inventoryItem.stock) {
                    showToast("Cannot add more than available stock.", true);
                } else {
                    await updateDoc(requestItemRef, { quantity: newQuantity });
                    showToast("List updated.");
                }
            }
        }

        async function handleRemoveFromRequest(itemId) { // Renamed
            const requestItemRef = doc(getUserRequestListCollection(currentUserId), itemId);
            await deleteDoc(requestItemRef);
            showToast("Item removed from list.");
        }

        async function handleSubmitRequest() { // Renamed
            const checkoutButton = document.getElementById('confirm-request-btn');
            checkoutButton.disabled = true;
            checkoutButton.textContent = "Submitting...";

            const supervisorName = document.getElementById('supervisor-name').value.trim();
            if (!supervisorName) {
                showToast("Please enter the supervisor's name.", true);
                checkoutButton.disabled = false;
                checkoutButton.textContent = "Confirm Request";
                return;
            }
            
            let newRequestData;
            let requestId;
            const logPromises = []; // For the item-specific logs

            try {
                // --- ATOMIC TRANSACTION ---
                await runTransaction(db, async (transaction) => {
                    // --- 1. READ PHASE ---
                    
                    // 1a. Read all request list items
                    const listSnapshot = await getDocs(query(getUserRequestListCollection(currentUserId)));
                    const listItems = listSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (listItems.length === 0) {
                        throw new Error("Your request list is empty.");
                    }

                    // 1b. Read all inventory items in the list
                    const inventoryDocs = new Map();
                    const readPromises = listItems.map(item => {
                        const itemRef = doc(getInventoryCollection(), item.productId);
                        return transaction.get(itemRef).then(doc => inventoryDocs.set(item.productId, doc));
                    });
                    await Promise.all(readPromises);

                    // --- 2. VALIDATION PHASE (In-Memory) ---
                    const itemsWithDetails = [];
                    for (const item of listItems) {
                        const inventoryDoc = inventoryDocs.get(item.productId);
                        if (!inventoryDoc || !inventoryDoc.exists()) {
                            throw new Error(`Item "${item.productName}" is no longer available.`);
                        }
                        
                        const inventoryData = inventoryDoc.data();
                        
                        // --- NEW: Check if hidden ---
                        if (inventoryData.isHidden) {
                            throw new Error(`Item "${inventoryData.name}" is currently unavailable.`);
                        }
                        
                        if (inventoryData.stock < item.quantity) {
                            throw new Error(`Not enough stock for "${inventoryData.name}". Only ${inventoryData.stock} left.`);
                        }
                        
                        itemsWithDetails.push({
                            ...item,
                            remarks: document.getElementById(`remarks-${item.id}`).value.trim()
                        });
                    }

                    // --- 3. WRITE PHASE (All writes at the end) ---
                    
                    // 3a. Prepare the new request
                    const newRequestRef = doc(getRequestsCollection()); // Auto-generate ID
                    requestId = newRequestRef.id; // Store ID for logging
                    newRequestData = {
                        userId: currentUserId,
                        userProfile: currentUserProfile,
                        status: "pending",
                        createdAt: serverTimestamp(),
                        supervisorName: supervisorName,
                        items: itemsWithDetails // Now includes full item details from cart
                    };
                    
                    // 3b. Write 1: Create the new request
                    transaction.set(newRequestRef, newRequestData);

                    const withdrawalTime = serverTimestamp();
                    const withdrawalUser = currentUserProfile.name;

                    // 3c. Write 2: Update all inventory items
                    for (const item of itemsWithDetails) {
                        const itemRef = doc(getInventoryCollection(), item.productId);
                        const currentStock = inventoryDocs.get(item.productId).data().stock;
                        const newStock = currentStock - item.quantity;
                        
                        transaction.update(itemRef, { 
                            stock: newStock,
                            lastWithdrawal: {
                                qty: item.quantity,
                                date: withdrawalTime,
                                user: withdrawalUser
                            }
                        });
                        
                        // --- BUGFIX: Prepare item-specific log ---
                        logPromises.push(logActivity("Item Withdrawn", {
                            requestId: requestId,
                            itemId: item.productId,
                            itemName: item.productName,
                            quantity: item.quantity,
                            newStock: newStock
                        }));
                    }
                    
                    // 3d. Write 3: Delete all request list items
                    for (const listDoc of listSnapshot.docs) {
                        transaction.delete(listDoc.ref);
                    }
                });
                // --- TRANSACTION END ---

                // --- POST-TRANSACTION SUCCESS ---
                // Log the main request
                logPromises.push(logActivity("Request Placed", { requestId: requestId, items: newRequestData.items.length }));
                // Log all item withdrawals
                await Promise.all(logPromises);
                
                showToast("Request submitted successfully!");
                
                lastRequestCache = { id: requestId, ...newRequestData }; // Save for summary page
                
                // --- NEW NAVIGATION ---
                renderRequestSummaryPage(lastRequestCache, true); // true = just created
                document.getElementById('user-interface').classList.add('hidden'); // Hide user UI
                document.getElementById('request-summary-page').classList.remove('hidden'); // Show summary
                
                // Add back button
                document.getElementById('summary-back-btn-container').innerHTML = `
                    <button id="summary-back-to-shop" class="w-full bg-red-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-700">
                        Back to Browse
                    </button>
                `;
                document.getElementById('summary-back-to-shop').onclick = () => {
                    document.getElementById('request-summary-page').classList.add('hidden');
                    document.getElementById('user-interface').classList.remove('hidden');
                    showUserPage('user-inventory-page');
                };
                
            } catch (error) {
                console.error("Request submission error: ", error);
                showToast(error.message || "Failed to submit request.", true);
            } finally {
                checkoutButton.disabled = false;
                checkoutButton.textContent = "Confirm Request";
            }
        }
        
        async function handleCopySummary() {
            if (!lastRequestCache) return;
            
            const { id, createdAt, supervisorName, userProfile, items } = lastRequestCache;
            
            let summaryText = `** STORE-SIGHT: Withdrawal Slip **\n\n`;
            summaryText += `Request ID: ${id}\n`;
            summaryText += `Date: ${new Date().toLocaleString()}\n`;
            summaryText += `Status: Pending\n\n`;
            
            summaryText += `**Requested By:**\n`;
            summaryText += `Name: ${userProfile.name}\n`;
            summaryText += `Employee ID: ${userProfile.empId}\n`;
            summaryText += `Designation: ${userProfile.designation}\n\n`;
            
            summaryText += `**Withdrawal Supervised By:**\n${supervisorName}\n\n`;
            
            summaryText += `**Items Requested (${items.length}):**\n`;
            summaryText += `---------------------------------\n`;
            
            items.forEach((item, index) => {
                const currentName = item.productName; // Use name from cart
                const itemCode = item.itemCode;
                
                summaryText += `${index + 1}. ${currentName} (${itemCode})\n`;
                summaryText += `   Qty: ${item.quantity}\n`;
                if (item.remarks) {
                    summaryText += `   Remarks: ${item.remarks}\n`;
                }
                summaryText += `\n`;
            });
            
            const textArea = document.createElement("textarea");
            textArea.value = summaryText;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("Summary copied to clipboard!");
            } catch (err) {
                showToast("Could not copy summary.", true);
            }
            document.body.removeChild(textArea);
        }

        // --- REGULAR USER: RENDER ---
        
        // --- UPDATED PUBLIC INVENTORY RENDER (Search Only, Simple Scroll) ---
        function renderPublicInventory(inventory) {
            const list = document.getElementById('public-inventory-list');
            const errorEl = document.getElementById('public-inventory-error');
            if (!list || !errorEl) return;
            
            // --- START UPDATED FILTER LOGIC (Search Only) ---
            const searchFilterEl = document.getElementById('public-search-filter');
            const searchTerm = searchFilterEl ? searchFilterEl.value.toLowerCase() : '';

            // --- NEW: Filter out hidden items ---
            const visibleInventory = inventory.filter(item => !item.isHidden);

            // Now, filter the visible items
            const filteredAndVisibleInventory = visibleInventory.filter(item => {
                const searchMatch = item.name.toLowerCase().includes(searchTerm) || (item.itemCode || '').toLowerCase().includes(searchTerm);
                return searchMatch;
            });
            // --- END UPDATED FILTER LOGIC ---
            
            list.innerHTML = ''; // Clear previous
            errorEl.classList.add('hidden');
            
            if (filteredAndVisibleInventory.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No items match your search.</p>';
                return;
            }
            
            // --- Group by category ---
            const categoryGroups = filteredAndVisibleInventory.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            // 2. Get sorted category names
            const sortedCategories = Object.keys(categoryGroups).sort();
            let html = '';

            // 3. Render by category
            for (const categoryName of sortedCategories) {
                const items = categoryGroups[categoryName];
                
                // Add category header
                html += `<h3 class="text-2xl font-bold text-gray-700 mt-6 mb-3 border-b-2 border-gray-200 pb-2">${categoryName}</h3>`;
                
                // Add items for this category
                items.forEach(item => {
                    const inStock = item.stock > 0;
                    
                    // --- Logic for Last Update ---
                    const addDate = item.lastAddition?.date?.toDate();
                    const withdrawDate = item.lastWithdrawal?.date?.toDate();
                    let lastUpdateHtml = '<p class="text-sm text-gray-500">No recent activity.</p>';
                    
                    if (addDate && (!withdrawDate || addDate > withdrawDate)) {
                        lastUpdateHtml = `<p class="text-sm text-gray-700">Last Update: <span class="font-medium text-green-700">Added ${item.lastAddition.qty}</span> by ${item.lastAddition.user} on ${addDate.toLocaleString()}</p>`;
                    } else if (withdrawDate) {
                        lastUpdateHtml = `<p class="text-sm text-gray-700">Last Update: <span class="font-medium text-red-700">Retrieved ${item.lastWithdrawal.qty}</span> by ${item.lastWithdrawal.user} on ${withdrawDate.toLocaleString()}</p>`;
                    }
                    // --- End of Logic ---

                    html += `
                        <div class="bg-white p-4 rounded-lg border">
                            <div class="flex flex-col md:flex-row justify-between md:items-start">
                                <!-- Left Side: Item Name and Last Update -->
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold text-gray-800">${item.name} <span class="text-sm font-normal text-gray-500">(${item.itemCode || 'N/A'})</span></h3>
                                    <p class="text-sm font-medium text-gray-600">${item.category || 'Uncategorized'}</p>
                                    ${lastUpdateHtml} 
                                </div>
                                <!-- Right Side: Stock and Status -->
                                <div class="mt-2 md:mt-0 md:ml-4 text-left md:text-right">
                                    <p class="text-2xl font-bold text-gray-900">${item.stock} <span class="text-sm font-normal text-gray-600">in stock</span></p>
                                    <p class="mt-1">
                                        ${inStock ? `<span class="font-medium text-green-700">In Stock</span>` : '<span class="font-medium text-red-600">Out of Stock</span>'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } // End category loop
            
            // --- NEW: Simplified render ---
            list.innerHTML = html;
        }
        
        function renderProfilePage(isFirstTime = false) {
            const container = document.getElementById('user-profile-page');
            const setupContainer = document.getElementById('profile-setup-view');

            const targetContainer = isFirstTime ? setupContainer : container;
            if (!targetContainer) return;
            
            const title = isFirstTime ? "Welcome! Let's set up your profile." : "My Profile";
            const buttonText = isFirstTime ? "Save and Continue" : "Update Profile";
            
            const name = currentUserProfile?.name || '';
            const empId = currentUserProfile?.empId || '';
            const designation = currentUserProfile?.designation || '';
            const email = currentUserEmail || '';
            
            targetContainer.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-lg max-w-2xl mx-auto border">
                    <h2 class="text-3xl font-bold mb-5 text-red-800 border-b-2 border-red-200 pb-2">${title}</h2>
                    ${isFirstTime ? '<p class="text-gray-600 mb-6">Please complete your profile to continue. Your account will be pending approval from a manager.</p>' : ''}
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Login Email (Auto-generated)</label>
                            <input type="email" value="${email}" disabled class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-100 sm:text-sm">
                        </div>
                        <div>
                            <label for="profile-empId" class="block text-sm font-medium text-gray-700">Employee ID</label>
                            <input type="text" id="profile-empId" value="${empId}" disabled class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-100 sm:text-sm">
                        </div>
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="profile-name" value="${name}" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm">
                        </div>
                        <div>
                            <label for="profile-designation" class="block text-sm font-medium text-gray-700">Designation</label>
                            <input type="text" id="profile-designation" value="${designation}" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm">
                        </div>
                        
                        <button id="update-profile-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700">
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('update-profile-btn').onclick = () => handleProfileUpdate(isFirstTime);
        }
        
        // --- UPDATED: RENDER USER INVENTORY WITH FILTERS ---
        function renderUserInventory(inventory) {
            const list = document.getElementById('user-inventory-list');
            if (!list) return;

            // --- START NEW FILTER LOGIC ---
            const categoryFilterEl = document.getElementById('user-category-filter');
            const searchFilterEl = document.getElementById('user-search-filter');
            
            // --- FIX: Correctly default to "ALL" ---
            const currentCategoryValue = categoryFilterEl ? categoryFilterEl.value : 'ALL';
            const selectedCategory = currentCategoryValue || 'ALL'; // Default to 'ALL' if ""
            const searchTerm = searchFilterEl ? searchFilterEl.value.toLowerCase() : '';

            // Populate Category Filter (only from visible items)
            const allVisibleItems = inventory.filter(item => !item.isHidden);
            const categories = ['ALL', ...new Set(allVisibleItems.map(item => item.category || 'Uncategorized'))];
            
            if (categoryFilterEl) {
                // --- FIX: Cleaned up dropdown population logic ---
                // Check if options are different before re-rendering to avoid flicker/losing focus
                if (categoryFilterEl.options.length !== categories.length) {
                     categoryFilterEl.innerHTML = categories.sort().map(cat => 
                        `<option value="${cat}">${cat}</option>`
                     ).join('');
                }
                // Always set the value *after* populating, defaulting to "ALL"
                categoryFilterEl.value = selectedCategory;
            }

            // Now, filter the visible items
            const filteredAndVisibleInventory = allVisibleItems.filter(item => {
                const categoryMatch = (selectedCategory === 'ALL') || (item.category || 'Uncategorized') === selectedCategory;
                const searchMatch = item.name.toLowerCase().includes(searchTerm) || (item.itemCode || '').toLowerCase().includes(searchTerm);
                return categoryMatch && searchMatch;
            });
            // --- END NEW FILTER LOGIC ---
            
            list.innerHTML = '';
            if (filteredAndVisibleInventory.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No items match your filters.</p>';
                return;
            }

            filteredAndVisibleInventory.forEach(item => {
                const inStock = item.stock > 0;
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${item.name} <span class="text-sm font-normal text-gray-500">(${item.itemCode || 'N/A'})</span></h3>
                            <p class="text-sm text-gray-600">${item.category || 'Uncategorized'}</p>
                            <p class="text-gray-600 mt-1">
                                ${inStock ? `Stock: <span class="font-medium text-green-700">${item.stock}</span>` : '<span class="font-medium text-red-600">Out of Stock</span>'}
                            </p>
                        </div>
                        <button 
                            onclick="handleAddToRequest('${item.id}', '${item.name}', ${item.stock})" 
                            class="add-to-request-btn ${inStock ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-300 cursor-not-allowed'} text-white font-bold py-2 px-4 rounded-lg"
                            ${!inStock ? 'disabled' : ''}
                        >
                            Add to List
                        </button>
                    </div>
                `;
            });
        }

        function renderUserRequestList(requestList, inventory) { // Renamed
            const list = document.getElementById('request-items-list');
            const totalSpan = document.getElementById('request-total');
            const checkoutBtn = document.getElementById('go-to-checkout-btn');
            
            if (!list || !totalSpan || !checkoutBtn) return;
            
            list.innerHTML = '';
            let totalItems = 0;

            if (requestList.length === 0) {
                list.innerHTML = '<p class="text-gray-500">Your request list is empty.</p>';
                checkoutBtn.disabled = true;
                checkoutBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                checkoutBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            } else {
                requestList.forEach(item => {
                    totalItems += item.quantity;
                    const currentName = item.productName; // Use name from cart
                    
                    list.innerHTML += `
                        <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">${currentName} <span class="text-sm font-normal text-gray-500">(${item.itemCode || 'N/A'})</span></h4>
                                <p class="text-sm text-gray-600">${item.category || 'Uncategorized'}</p>
                                <div class="flex items-center gap-2 mt-2">
                                    <button onclick="handleUpdateRequestQuantity('${item.id}', ${item.quantity - 1})" class="bg-gray-200 w-7 h-7 rounded-full font-bold text-lg text-gray-700 flex items-center justify-center hover:bg-gray-300">-</button>
                                    <span class="text-lg w-8 text-center">${item.quantity}</span>
                                    <button onclick="handleUpdateRequestQuantity('${item.id}', ${item.quantity + 1})" class="bg-gray-200 w-7 h-7 rounded-full font-bold text-lg text-gray-700 flex items-center justify-center hover:bg-gray-300">+</button>
                                </div>
                            </div>
                            <button onclick="handleRemoveFromRequest('${item.id}')" class="text-red-500 hover:text-red-700 font-medium">
                                Remove
                            </button>
                        </div>
                    `;
                });
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                checkoutBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            }
            
            totalSpan.textContent = `${totalItems} items`;
        }
        
        function renderCheckoutPage() {
            const list = document.getElementById('checkout-items-list');
            list.innerHTML = '';
            document.getElementById('supervisor-name').value = '';
            
            if (localRequestCache.length === 0) {
                 list.innerHTML = '<p class="text-gray-500">Your list is empty. <a href="#" onclick="showUserPage(\'user-inventory-page\'); return false;" class="text-red-500">Browse items</a>.</p>';
                 document.getElementById('confirm-request-btn').disabled = true;
                 return;
            }
            
            document.getElementById('confirm-request-btn').disabled = false;
            localRequestCache.forEach(item => {
                const currentName = item.productName; // Use name from cart
                
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border space-y-4" id="item-form-${item.id}">
                        <h4 class="text-lg font-semibold text-gray-800">${currentName} (Qty: ${item.quantity})</h4>
                        <p class="text-sm text-gray-600">${item.category || 'Uncategorized'} (${item.itemCode || 'N/A'})</p>
                        <div>
                            <label for="remarks-${item.id}" class="block text-sm font-medium text-gray-700">Remarks:</label>
                            <input type="text" id="remarks-${item.id}" class="checkout-remarks-input mt-1 block w-full rounded-lg border-gray-300 sm:text-sm" placeholder="Optional">
                        </div>
                    </div>
                `;
            });
        }
        
        function renderRequestSummaryPage(request, justCreated) { // Renamed
            const list = document.getElementById('request-summary-details');
            const titleEl = document.getElementById('request-summary-title');
            if (!request || !titleEl) {
                list.innerHTML = '<p class="text-gray-600">Could not find request details.</p>';
                return;
            }
            
            // --- BUGFIX: Set title based on context ---
            if (justCreated) {
                titleEl.textContent = 'Request Placed Successfully!';
                titleEl.className = 'text-2xl font-semibold mb-4 text-green-600';
            } else {
                titleEl.textContent = ''; // Title is now on the slip itself
                titleEl.className = '';
            }
            
            document.getElementById('copy-summary-btn').classList.toggle('hidden', !justCreated);
            const requestDate = request.createdAt?.toDate ? request.createdAt.toDate().toLocaleString() : 'Just now';
            
            let itemsHtml = '';
            request.items.forEach((item, index) => {
                const currentName = item.productName;
                
                itemsHtml += `
                    <tr class="border-b">
                        <td class="p-2">${index + 1}</td>
                        <td class="p-2">${currentName} (${item.itemCode})</td>
                        <td class="p-2 text-center">${item.quantity}</td>
                        <td class="p-2">${item.remarks || 'N/A'}</td>
                    </tr>
                `;
            });
            
            list.innerHTML = `
                <div class="space-y-4 font-mono text-sm text-gray-800">
                    <p><strong>Request ID:</strong> ${request.id}</p>
                    <p><strong>Date:</strong> ${requestDate}</p>
                    <hr>
                    <p><strong>Requested By:</strong></p>
                    <div class="pl-4">
                        <p>${request.userProfile.name}</p>
                        <p>ID: ${request.userProfile.empId}</p>
                        <p>Designation: ${request.userProfile.designation}</p>
                    </div>
                    <hr>
                    <p><strong>Supervised By:</strong></p>
                    <div class="pl-4">
                        <p>${request.supervisorName}</p>
                    </div>
                    <hr>
                    <p><strong>Items (${request.items.length}):</strong></p>
                    <table class="w-full border-collapse border mt-2">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border text-left">#</th>
                                <th class="p-2 border text-left">Item (Code)</th>
                                <th class="p-2 border text-center">Qty</th>
                                <th class="p-2 border text-left">Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderUserRequests(requests) { // Renamed
            const list = document.getElementById('user-requests-list');
            if (!list) return;
            list.innerHTML = '';
            
            if (requests.length === 0) {
                list.innerHTML = '<p class="text-gray-500">You have not placed any requests yet.</p>';
                return;
            }
            
            requests.forEach(request => {
                const totalItems = request.items.reduce((sum, item) => sum + item.quantity, 0);
                const requestDate = request.createdAt?.toDate ? request.createdAt.toDate().toLocaleDateString() : 'Pending';
                
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-800 font-mono">ID: ${request.id}</h3>
                                <p class="text-gray-600">Date: ${requestDate}</p>
                                <p class="text-gray-600">Total Items: ${totalItems}</p>
                            </div>
                            <button onclick="viewRequestDetails('${request.id}')" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">
                                View
                            </button>
                        </div>
                    </div>
                `;
            });
            
            window.viewRequestDetails = async (requestId) => {
                const requestRef = doc(getRequestsCollection(), requestId);
                const requestDoc = await getDoc(requestRef);
                if (requestDoc.exists()) {
                    lastRequestCache = { id: requestDoc.id, ...requestDoc.data() };
                    renderRequestSummaryPage(lastRequestCache, false); // false = not just created
                    
                    // --- NEW NAVIGATION ---
                    document.getElementById('user-interface').classList.add('hidden');
                    document.getElementById('request-summary-page').classList.remove('hidden');
                    
                    // Add back button
                    document.getElementById('summary-back-btn-container').innerHTML = `
                        <button id="summary-back-to-user" class="w-full bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-700">
                            Back to My Requests
                        </button>
                    `;
                    document.getElementById('summary-back-to-user').onclick = () => {
                        document.getElementById('request-summary-page').classList.add('hidden');
                        document.getElementById('user-interface').classList.remove('hidden');
                        showUserPage('user-requests-page');
                    };
                    
                } else {
                    showToast("Request not found.", true);
                }
            };
        }

        // --- 6. MANAGER: ACTIONS & RENDERING ---
        
        function renderDashboard() {
            const kpiPending = document.getElementById('kpi-pending-users');
            const kpiLowStock = document.getElementById('kpi-low-stock');
            const kpiTotalItems = document.getElementById('kpi-total-items');
            
            if (!kpiPending || !kpiLowStock || !kpiTotalItems) return;
            
            // 1. Render KPIs from cache
            const pendingUsers = userRolesCache.filter(user => user.status === 'pending').length;
            const lowStockItems = inventoryCache.filter(item => item.stock <= item.lowStockThreshold && !item.isHidden).length; // Don't count hidden low stock
            const totalItems = inventoryCache.length;
            
            kpiPending.textContent = pendingUsers;
            kpiLowStock.textContent = lowStockItems;
            kpiTotalItems.textContent = totalItems;
            kpiPending.classList.toggle('text-red-500', pendingUsers > 0);
            kpiLowStock.classList.toggle('text-red-500', lowStockItems > 0);
            
            // 2. Render Pending Users List
            const pendingList = document.getElementById('dashboard-pending-list');
            const pendingUsersToShow = userRolesCache.filter(user => user.status === 'pending').slice(0, 5);
            pendingList.innerHTML = '';
            if (pendingUsersToShow.length === 0) {
                pendingList.innerHTML = '<p class="text-sm text-gray-500">No users pending approval.</p>';
            } else {
                pendingUsersToShow.forEach(user => {
                    pendingList.innerHTML += `
                        <div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-100">
                            <div>
                                <p class="font-semibold text-gray-800">${user.name || 'Profile Not Setup'}</p>
                                <p class="text-sm text-gray-600">${user.email}</p>
                            </div>
                            <button onclick="handleApproveUser('${user.id}', '${user.name}')" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-lg font-semibold text-sm">
                                Approve
                            </button>
                        </div>
                    `;
                });
            }
            
            // 3. Render Low Stock List
            const lowStockList = document.getElementById('dashboard-low-stock-list');
            const lowStockItemsToShow = inventoryCache.filter(item => item.stock <= item.lowStockThreshold && !item.isHidden).slice(0, 5); // Don't show hidden
            lowStockList.innerHTML = '';
            if (lowStockItemsToShow.length === 0) {
                lowStockList.innerHTML = '<p class="text-sm text-gray-500">All stock levels look good!</p>';
            } else {
                lowStockItemsToShow.forEach(item => {
                    lowStockList.innerHTML += `
                        <div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-100">
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm font-bold text-red-600">Stock: ${item.stock}</p>
                            </div>
                            <button onclick="handleOpenAddStockModal('${item.id}', '${item.name}', ${item.stock})" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-lg font-semibold text-sm">
                                Add Stock
                            </button>
                        </div>
                    `;
                });
            }
        }
        
        function renderDashboardRecentActivity(logDocs) {
            const list = document.getElementById('dashboard-recent-activity');
            if (!list) return;
            list.innerHTML = '';
            if (logDocs.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500">No recent activity.</p>';
                return;
            }
            logDocs.forEach(doc => {
                const log = doc.data();
                const time = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : 'Just now';
                list.innerHTML += `
                    <div class="p-2 border-b border-gray-200">
                        <p class="font-semibold text-gray-800 text-sm">${log.action}</p>
                        <p class="text-xs text-gray-600">By: ${log.user} | ${time}</p>
                    </div>
                `;
            });
        }

        // --- UPDATED: RENDER MANAGER INVENTORY WITH FILTERS ---
        function renderManagerInventory(inventory) {
            const list = document.getElementById('manager-inventory-list');
            if (!list) return;

            // --- START NEW FILTER LOGIC ---
            const categoryFilterEl = document.getElementById('manager-category-filter');
            const searchFilterEl = document.getElementById('manager-search-filter');
            
            const currentCategoryValue = categoryFilterEl ? categoryFilterEl.value : 'ALL';
            const selectedCategory = currentCategoryValue || 'ALL'; // Default to 'ALL' if ""
            const searchTerm = searchFilterEl ? searchFilterEl.value.toLowerCase() : '';

            // Populate Category Filter (from ALL items, hidden or not)
            const categories = ['ALL', ...new Set(inventory.map(item => item.category || 'Uncategorized'))];
            
            if (categoryFilterEl) {
                if (categoryFilterEl.options.length !== categories.length) {
                     categoryFilterEl.innerHTML = categories.sort().map(cat => 
                        `<option value="${cat}">${cat}</option>`
                     ).join('');
                }
                 // Always set the value *after* populating, defaulting to "ALL"
                categoryFilterEl.value = selectedCategory;
            }

            // Filter the inventory
            const filteredInventory = inventory.filter(item => {
                const categoryMatch = (selectedCategory === 'ALL') || (item.category || 'Uncategorized') === selectedCategory;
                const searchMatch = item.name.toLowerCase().includes(searchTerm) || (item.itemCode || '').toLowerCase().includes(searchTerm);
                return categoryMatch && searchMatch;
            });
            // --- END NEW FILTER LOGIC ---

            list.innerHTML = '';
            
            if (filteredInventory.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No items match your filters.</p>';
                return;
            }

            // 1. Group by category
            const categoryGroups = filteredInventory.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            // 2. Get sorted category names
            const sortedCategories = Object.keys(categoryGroups).sort();
            let html = '';

            // 3. Render by category
            for (const categoryName of sortedCategories) {
                const items = categoryGroups[categoryName];
                
                // Check if *all* items in this category are hidden (for the button text)
                const allHidden = items.every(item => item.isHidden);
                
                html += `
                    <div class="mb-8">
                        <div class="flex justify-between items-center bg-gray-200 p-3 rounded-lg mb-4">
                            <h3 class="text-2xl font-bold text-gray-700">${categoryName}</h3>
                            <button onclick="handleToggleCategory('${categoryName}', ${!allHidden})" class="text-sm font-semibold ${allHidden ? 'bg-green-500' : 'bg-yellow-500'} text-white py-2 px-3 rounded-lg hover:opacity-80">
                                ${allHidden ? 'Show Category' : 'Hide Category'}
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                `;
                
                // 4. Render the new simplified card for each item
                items.forEach(item => {
                    const isHidden = item.isHidden || false;
                    let superuserDeleteBtn = '';
                    if (currentUserRole === 'superuser') {
                        superuserDeleteBtn = `
                            <button onclick="handleDeleteItem('${item.id}', '${item.name}')" class="text-red-500 hover:text-red-700 font-semibold text-sm">
                                Delete Item
                            </button>
                        `;
                    }
                    
                    html += `
                        <div class="bg-white p-4 rounded-lg border ${isHidden ? 'opacity-60 bg-gray-50' : ''}">
                            <!-- Top row: Name and Edit Button -->
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">${item.name} ${isHidden ? '<span class="text-sm text-red-600">(Hidden)</span>' : ''}</h3>
                                    <p class="text-sm text-gray-600">${item.category} | <span class="font-mono">${item.itemCode || 'N/A'}</span></p>
                                    <p class="text-xs text-gray-500">Threshold: ${item.lowStockThreshold}</p>
                                </div>
                                <button onclick="handleOpenEditModal('${item.id}')" class="text-gray-500 hover:text-red-600 p-1 rounded-full">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                            </div>
                            
                            <p class="font-bold text-2xl ${item.stock <= item.lowStockThreshold ? 'text-red-600' : 'text-gray-800'} mb-4">Stock: ${item.stock}</p>
                            
                            <!-- Bottom row: Add Stock and History -->
                            <div class="flex flex-wrap items-center gap-3">
                                <input type="number" id="add-stock-qty-${item.id}" class="p-2 border border-gray-300 rounded-lg w-24" placeholder="Qty">
                                <button onclick="handleQuickAddStock('${item.id}', ${item.stock})" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 font-semibold">
                                    Add Stock
                                </button>
                                <button onclick="handleViewItemHistory('${item.id}', '${item.name}')" title="View History" class="bg-gray-200 text-gray-800 p-2.5 rounded-lg hover:bg-gray-300">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>
                            </div>
                            
                            <!-- Superuser Delete -->
                            ${superuserDeleteBtn ? `<div class="mt-3 text-right">${superuserDeleteBtn}</div>` : ''}
                        </div>
                    `;
                });

                html += `</div></div>`; // Close space-y-4 and category div
            }
            
            list.innerHTML = html; // Set the concatenated HTML
        }
        
        function renderUserRoles(users) {
            const list = document.getElementById('user-roles-list');
            if (!list) return;
            list.innerHTML = '';
            
            users.forEach(user => {
                const isCurrentUser = user.id === currentUserId;
                let statusBadge = '';
                switch (user.status) {
                    case 'active': statusBadge = '<span class="text-xs font-medium px-2 py-1 bg-green-100 text-green-800 rounded-full">Active</span>'; break;
                    case 'pending': statusBadge = '<span class="text-xs font-medium px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">Pending</span>'; break;
                    case 'suspended': statusBadge = '<span class="text-xs font-medium px-2 py-1 bg-red-100 text-red-800 rounded-full">Suspended</span>'; break;
                    default: statusBadge = `<span class="text-xs font-medium px-2 py-1 bg-gray-100 text-gray-800 rounded-full">${user.status || 'Unknown'}</span>`;
                }
                
                let canDelete = false;
                if (currentUserRole === 'superuser' && !isCurrentUser) {
                    canDelete = true;
                } else if (currentUserRole === 'manager' && user.role === 'user' && !isCurrentUser) {
                    canDelete = true;
                }
                
                let canChangeRole = false;
                if (currentUserRole === 'superuser' && !isCurrentUser) {
                    canChangeRole = true;
                } else if (currentUserRole === 'manager' && user.role === 'user' && !isCurrentUser) {
                    canChangeRole = true;
                }

                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border flex flex-col md:flex-row justify-between gap-4">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${user.name || 'Profile Not Setup'} ${statusBadge}</p>
                            <p class="text-sm text-gray-600">${user.email || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${user.designation || 'N/A'}</p>
                            <p class="text-sm text-gray-600 break-all"><span class="font-medium">User ID:</span> ${user.userId}</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            ${user.status === 'pending' ? `
                                <button onclick="handleApproveUser('${user.id}', '${user.name}')" class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg font-semibold text-sm">
                                    Approve
                                </button>
                            ` : ''}
                            ${user.status === 'active' && !isCurrentUser && user.role === 'user' ? `
                                <button onclick="handleSuspendUser('${user.id}', '${user.name}', true)" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-3 rounded-lg font-semibold text-sm">
                                    Suspend
                                </button>
                            ` : ''}
                             ${user.status === 'suspended' && !isCurrentUser ? `
                                <button onclick="handleSuspendUser('${user.id}', '${user.name}', false)" class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg font-semibold text-sm">
                                    Re-activate
                                </button>
                            ` : ''}
                            <select id="role-${user.id}" class="p-2 border border-gray-300 rounded-lg text-sm" ${!canChangeRole ? 'disabled' : ''}>
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                                ${currentUserRole === 'superuser' ? `<option value="superuser" ${user.role === 'superuser' ? 'selected' : ''}>Superuser</option>` : ''}
                            </select>
                            <button onclick="handleUpdateUserRole('${user.id}')" 
                                class="${!canChangeRole ? 'bg-gray-300 cursor-not-allowed' : 'bg-red-500 hover:bg-red-600'} text-white py-2 px-3 rounded-lg font-semibold text-sm"
                                ${!canChangeRole ? 'disabled' : ''}>
                                Update Role
                            </button>
                            ${canDelete ? `
                                <button onclick="handleDeleteUser('${user.id}', '${user.email}')" class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg font-semibold text-sm">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        function renderManagerRequests(requests) { // Renamed
            const list = document.getElementById('manager-requests-list');
            if (!list) return;
            list.innerHTML = '';
            
            if (requests.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No requests have been placed yet.</p>';
                return;
            }
            
            requests.forEach(request => {
                const totalItems = request.items.reduce((sum, item) => sum + item.quantity, 0);
                const requestDate = request.createdAt?.toDate ? request.createdAt.toDate().toLocaleString() : 'Pending';
                
                let superuserButton = '';
                if (currentUserRole === 'superuser') {
                    superuserButton = `<button onclick="handleDeleteRequest('${request.id}')" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">Delete</button>`;
                }

                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${request.userProfile?.name || 'Unknown User'}</h3>
                                <p class="text-gray-600 text-sm font-mono">ID: ${request.id}</p>
                                <p class="text-gray-600">${requestDate}</p>
                                <p class="text-gray-600">Total Items: ${totalItems}</p>
                            </div>
                            <div class="flex flex-col gap-2 items-end">
                                <button onclick="viewManagerRequestDetails('${request.id}')" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">
                                    View
                                </button>
                                ${superuserButton}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            window.viewManagerRequestDetails = async (requestId) => {
                const requestRef = doc(getRequestsCollection(), requestId);
                const requestDoc = await getDoc(requestRef);
                if (requestDoc.exists()) {
                    lastRequestCache = { id: requestDoc.id, ...requestDoc.data() };
                    renderRequestSummaryPage(lastRequestCache, false); // false = not just created
                    
                    // --- NEW NAVIGATION ---
                    document.getElementById('manager-interface').classList.add('hidden');
                    document.getElementById('request-summary-page').classList.remove('hidden');
                    
                    // Add back button
                    document.getElementById('summary-back-btn-container').innerHTML = `
                        <button id="summary-back-to-manager" class="w-full bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-700">
                            Back to All Requests
                        </button>
                    `;
                    document.getElementById('summary-back-to-manager').onclick = () => {
                        document.getElementById('request-summary-page').classList.add('hidden');
                        document.getElementById('manager-interface').classList.remove('hidden');
                        showManagerTab('manager-requests-tab');
                    };
                    
                } else {
                    showToast("Request not found.", true);
                }
            };
        }
        
        function renderActivityLog(logs) {
            const list = document.getElementById('activity-log-list');
            if (!list) return;
            list.innerHTML = '';
            if (logs.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No activities logged yet.</p>';
                return;
            }
            
            logs.forEach(log => {
                const time = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : 'Just now';
                
                let superuserButton = '';
                if (currentUserRole === 'superuser') {
                    superuserButton = `<button onclick="handleDeleteLog('${log.id}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">Delete Log</button>`;
                }
                
                // --- DATA-RICH LOG ---
                list.innerHTML += `
                    <div class="p-3 bg-white rounded-lg border font-mono text-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${log.action}</p>
                                <p class="text-gray-600">By: <span class="font-medium">${log.user}</span></p>
                                <p class="text-gray-600">When: ${time}</p>
                                <details class="mt-2 text-xs">
                                    <summary class="cursor-pointer text-gray-500">Details</summary>
                                    <pre class="mt-2 p-2 bg-gray-100 rounded overflow-auto">${JSON.stringify(log.details, null, 2)}</pre>
                                </details>
                            </div>
                            ${superuserButton}
                        </div>
                    </div>
                `;
            });
        }
        
        // --- MANAGER: ACTIONS ---
        async function handleAddInventoryItem() {
            const name = document.getElementById('item-name').value.trim();
            const itemCode = document.getElementById('item-code').value.trim();
            const category = document.getElementById('item-category').value.trim();
            const stock = parseInt(document.getElementById('item-stock').value, 10);
            const lowStock = parseInt(document.getElementById('item-low-stock').value, 10);
            
            if (!name || !itemCode || !category || isNaN(stock) || isNaN(lowStock)) {
                showToast("Please fill in all fields correctly.", true);
                return;
            }
            
            // Check for duplicate itemCode
            const existingItem = inventoryCache.find(item => item.itemCode === itemCode);
            if (existingItem) {
                showToast("An item with this Item Code already exists.", true);
                return;
            }
            
            try {
                const itemData = {
                    name: name,
                    itemCode: itemCode,
                    category: category,
                    stock: stock,
                    lowStockThreshold: lowStock,
                    isHidden: false, // NEW: Default to visible
                    addedAt: serverTimestamp(),
                    lastAddition: {
                        qty: stock,
                        date: serverTimestamp(),
                        user: currentUserProfile.name
                    },
                    lastWithdrawal: {
                        qty: 0,
                        date: null,
                        user: null
                    }
                };
                
                const itemRef = await addDoc(getInventoryCollection(), itemData);
                await logActivity("Inventory Item Added", { itemId: itemRef.id, ...itemData });
                
                showToast("Item added to inventory.");
                document.getElementById('item-name').value = '';
                document.getElementById('item-code').value = '';
                document.getElementById('item-category').value = '';
                document.getElementById('item-stock').value = '10';
                document.getElementById('item-low-stock').value = '5';
            } catch (error) {
                console.error("Add item error: ", error);
                showToast("Failed to add item.", true);
            }
        }
        
        // --- NEW HELPER FUNCTIONS FOR INVENTORY MGT ---

        function handleOpenEditModal(itemId) {
            const item = inventoryCache.find(i => i.id === itemId);
            if (!item) return;
            
            // Pre-fill modal
            document.getElementById('item-details-title').textContent = `Edit: ${item.name}`;
            document.getElementById('modal-detail-item-name').value = item.name;
            document.getElementById('modal-detail-item-code').value = item.itemCode;
            document.getElementById('modal-detail-item-category').value = item.category;
            document.getElementById('modal-detail-item-threshold').value = item.lowStockThreshold;
            document.getElementById('modal-detail-item-hidden').checked = item.isHidden || false;
            
            const confirmBtn = document.getElementById('modal-detail-confirm-btn');
            // Clone and replace button to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => handleConfirmEditItemDetails(itemId);
            
            document.getElementById('item-details-modal').classList.remove('hidden');
        }
        
        function closeEditItemDetailsModal() {
            document.getElementById('item-details-modal').classList.add('hidden');
        }
        
        async function handleConfirmEditItemDetails(itemId) {
            const newName = document.getElementById('modal-detail-item-name').value.trim();
            const newItemCode = document.getElementById('modal-detail-item-code').value.trim();
            const newCategory = document.getElementById('modal-detail-item-category').value.trim();
            const newThreshold = parseInt(document.getElementById('modal-detail-item-threshold').value, 10);
            const isHidden = document.getElementById('modal-detail-item-hidden').checked;
            
            if (!newName || !newItemCode || !newCategory || isNaN(newThreshold)) {
                showToast("All fields are required.", true);
                return;
            }
            
            // Check for duplicate itemCode
            const existingItem = inventoryCache.find(item => item.itemCode === newItemCode && item.id !== itemId);
            if (existingItem) {
                showToast("An item with this Item Code already exists.", true);
                return;
            }
            
            const itemRef = doc(getInventoryCollection(), itemId);
            const oldItem = inventoryCache.find(i => i.id === itemId);
            
            try {
                const updateData = { 
                    name: newName,
                    itemCode: newItemCode,
                    category: newCategory,
                    lowStockThreshold: newThreshold,
                    isHidden: isHidden
                };
                
                await updateDoc(itemRef, updateData);
                await logActivity("Inventory Item Details Updated", { 
                    itemId: itemId, 
                    oldDetails: {
                        name: oldItem.name,
                        itemCode: oldItem.itemCode,
                        category: oldItem.category,
                        threshold: oldItem.lowStockThreshold,
                        hidden: oldItem.isHidden
                    },
                    newDetails: updateData
                });
                showToast("Item details updated.");
                closeEditItemDetailsModal();
            } catch (error) {
                console.error("Update item details error: ", error);
                showToast("Failed to update item details.", true);
            }
        }
        
        async function handleQuickAddStock(itemId, currentStock) {
            const qtyInput = document.getElementById(`add-stock-qty-${itemId}`);
            if (!qtyInput) return;
            
            const qtyToAdd = parseInt(qtyInput.value, 10);
            
            if (isNaN(qtyToAdd) || qtyToAdd <= 0) {
                showToast("Please enter a valid quantity to add.", true);
                return;
            }
            
            const newStock = currentStock + qtyToAdd;
            const itemRef = doc(getInventoryCollection(), itemId);
            
            try {
                await updateDoc(itemRef, {
                    stock: newStock,
                    lastAddition: {
                        qty: qtyToAdd,
                        date: serverTimestamp(),
                        user: currentUserProfile.name
                    }
                });
                await logActivity("Stock Added", { itemId: itemId, added: qtyToAdd, newStock: newStock });
                showToast("Stock added successfully.");
                qtyInput.value = ''; // Clear input
            } catch (error) {
                console.error("Add stock error: ", error);
                showToast("Failed to add stock.", true);
            }
        }
        
        async function handleToggleCategory(categoryName, shouldHide) {
            const action = shouldHide ? "Hide" : "Show";
            showConfirmationModal(
                `${action} Category?`,
                `This will ${action.toLowerCase()} all items in the "${categoryName}" category from the public inventory.`,
                async () => {
                    const batch = writeBatch(db);
                    const itemsToUpdate = inventoryCache.filter(item => item.category === categoryName);
                    
                    if (itemsToUpdate.length === 0) {
                        showToast("No items found for this category.", true);
                        return;
                    }
                    
                    itemsToUpdate.forEach(item => {
                        const itemRef = doc(getInventoryCollection(), item.id);
                        batch.update(itemRef, { isHidden: shouldHide });
                    });
                    
                    try {
                        await batch.commit();
                        await logActivity("Category Toggled", { category: categoryName, action: action });
                        showToast(`Category "${categoryName}" is now ${shouldHide ? 'hidden' : 'visible'}.`);
                    } catch (error) {
                        console.error("Category toggle error:", error);
                        showToast("Failed to update category.", true);
                    }
                }
            );
        }

        // --- END OF NEW HELPERS ---
        
        // This function is now DEPRECATED by the new modal
        function handleEditItemName(itemId, oldName) {
            // Re-purpose this to open the *new* modal
            handleOpenEditModal(itemId);
        }
        
        // This function is now DEPRECATED
        function closeEditItemModal() {
            // This modal doesn't exist anymore, but we leave the function
            // just in case, or point it to the new one.
            closeEditItemDetailsModal();
        }
        
        // This function is now DEPRECATED
        async function handleConfirmEditItem(itemId, oldName) {
            // This is handled by handleConfirmEditItemDetails
            console.warn("handleConfirmEditItem is deprecated.");
        }
        
        // This function is now DEPRECATED
        async function handleUpdateItemThreshold(itemId) {
            // This is handled by handleConfirmEditItemDetails
            console.warn("handleUpdateItemThreshold is deprecated.");
        }
        
        function handleOpenAddStockModal(itemId, itemName, currentStock) {
            document.getElementById('modal-stock-item-name').textContent = itemName;
            document.getElementById('modal-stock-current').textContent = currentStock;
            document.getElementById('modal-stock-add-qty').value = '';
            
            const confirmBtn = document.getElementById('modal-stock-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => handleConfirmAddStock(itemId, currentStock);
            
            document.getElementById('add-stock-modal').classList.remove('hidden');
        }
        
        function closeAddStockModal() {
            document.getElementById('add-stock-modal').classList.add('hidden');
        }
        
        async function handleConfirmAddStock(itemId, currentStock) {
            const qtyToAdd = parseInt(document.getElementById('modal-stock-add-qty').value, 10);
            if (isNaN(qtyToAdd) || qtyToAdd <= 0) {
                showToast("Please enter a valid quantity to add.", true);
                return;
            }
            
            const newStock = currentStock + qtyToAdd;
            const itemRef = doc(getInventoryCollection(), itemId);
            
            try {
                await updateDoc(itemRef, {
                    stock: newStock,
                    lastAddition: {
                        qty: qtyToAdd,
                        date: serverTimestamp(),
                        user: currentUserProfile.name
                    }
                });
                await logActivity("Stock Added", { itemId: itemId, added: qtyToAdd, newStock: newStock });
                showToast("Stock added successfully.");
                closeAddStockModal();
            } catch (error) {
                console.error("Add stock error: ", error);
                showToast("Failed to add stock.", true);
            }
        }
        
        // --- NEW ITEM HISTORY FUNCTION ---
        async function handleViewItemHistory(itemId, itemName) {
            const modal = document.getElementById('item-history-modal');
            const title = document.getElementById('item-history-title');
            const list = document.getElementById('item-history-list');
            
            title.textContent = `History for: ${itemName}`;
            list.innerHTML = '<p>Loading history...</p>';
            modal.classList.remove('hidden');
            
            try {
                // --- THIS QUERY REQUIRES AN INDEX ---
                const logQuery = query(
                    getActivityLogCollection(), 
                    where("details.itemId", "==", itemId),
                    orderBy('timestamp', 'desc')
                );
                const snapshot = await getDocs(logQuery);
                
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500">No history found for this item.</p>';
                    return;
                }
                
                list.innerHTML = ''; // Clear loading
                snapshot.docs.forEach(doc => {
                    const log = doc.data();
                    const time = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : 'Just now';
                    
                    let detailsText = log.action;
                    if (log.action === 'Stock Added') {
                        detailsText = `+${log.details.added} (New Stock: ${log.details.newStock})`;
                    } else if (log.action === 'Item Withdrawn') { // --- BUGFIX: Use new log type ---
                        detailsText = `-${log.details.quantity} (New Stock: ${log.details.newStock}) | Req: ${log.details.requestId.substring(0, 5)}...`;
                    } else if (log.action === 'Inventory Item Details Updated') {
                        detailsText = `Details updated (Code: ${log.details.newDetails.itemCode})`;
                    } else if (log.action === 'Inventory Item Added') {
                        detailsText = `Item created (Code: ${log.details.itemCode})`;
                    }
                    
                    // Only show logs relevant to this item
                    if (log.action.includes('Stock') || log.action.includes('Item')) {
                        list.innerHTML += `
                            <div class="p-3 bg-gray-100 rounded-lg font-mono text-sm">
                                <p><strong>${time}</strong></p>
                                <p>By: ${log.user}</p>
                                <p>Action: ${detailsText}</p>
                            </div>
                        `;
                    }
                });
                
            } catch (error) {
                console.error("Error fetching item history:", error);
                // --- BUGFIX: Show error in UI if index is missing ---
                list.innerHTML = `<p class="text-red-600 font-medium">Could not load history. The database may be missing a required index. Please contact your administrator.</p>
                <p class="text-sm text-gray-600">Admin: See Step 6 in the setup guide to create the 'activity_log' index.</p>`;
            }
        }
        
        async function handleApproveUser(userId, name) {
            const userRef = doc(getUserRolesCollection(), userId);
            try {
                await updateDoc(userRef, { status: 'active' });
                await logActivity("User Approved", { approvedUserId: userId, name: name });
                showToast("User approved successfully.");
            } catch (error) {
                console.error("Approve user error:", error);
                showToast("Failed to approve user.", true);
            }
        }
        
        async function handleSuspendUser(userId, name, shouldSuspend) {
            const newStatus = shouldSuspend ? 'suspended' : 'active';
            const action = shouldSuspend ? 'User Suspended' : 'User Re-activated';
            const userRef = doc(getUserRolesCollection(), userId);
            try {
                await updateDoc(userRef, { status: newStatus });
                await logActivity(action, { targetUserId: userId, name: name });
                showToast(`User ${newStatus} successfully.`);
            } catch (error) {
                console.error("Suspend/activate user error:", error);
                showToast("Failed to update user status.", true);
            }
        }

        async function handleUpdateUserRole(userId) {
            if (userId === currentUserId) {
                showToast("You cannot change your own role.", true);
                return;
            }
            
            const roleSelect = document.getElementById(`role-${userId}`);
            const newRole = roleSelect.value;
            
            const userRoleRef = doc(getUserRolesCollection(), userId);
            try {
                await updateDoc(userRoleRef, { role: newRole });
                await logActivity("User Role Changed", { targetUserId: userId, newRole: newRole });
                showToast("User role updated successfully.");
            } catch (error) {
                console.error("Update role error: ", error);
                showToast("Failed to update user role.", true);
            }
        }
        
        async function handleDeleteUser(userId, email) {
            showConfirmationModal(
                "Delete User Data?",
                `This will delete all app data (profile, request list) for ${email}. It will NOT delete their login/PIN. You must do that from the Firebase Console. This is how you reset a user's PIN.`,
                async () => {
                    try {
                        // 1. Delete user role doc
                        const userRoleRef = doc(getUserRolesCollection(), userId);
                        await deleteDoc(userRoleRef);
                        
                        // 2. Delete user's request list (recursive delete)
                        const listRef = getUserRequestListCollection(userId);
                        const listSnapshot = await getDocs(listRef);
                        const batch = writeBatch(db);
                        listSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        
                        // 3. Log it
                        await logActivity("User Data Deleted", { deletedUserId: userId, email: email });
                        showToast("User data deleted. Remember to delete their login from the Auth console to reset their PIN.");

                    } catch (error) {
                        console.error("Delete user error:", error);
                        showToast("Failed to delete user data.", true);
                    }
                }
            );
        }
        
        // --- SUPERUSER ACTIONS ---
        async function handleDeleteLog(logId) {
            try {
                await deleteDoc(doc(getActivityLogCollection(), logId));
                showToast("Log entry deleted.");
            } catch (error) {
                console.error("Delete log error:", error);
                showToast("Could not delete log.", true);
            }
        }
        
        async function handleDeleteRequest(requestId) { // Renamed
            showConfirmationModal(
                "Delete Request?",
                `Superuser: Delete this entire request (${requestId})? This is irreversible and will remove it from history.`,
                async () => {
                    try {
                        await deleteDoc(doc(getRequestsCollection(), requestId));
                        await logActivity("Request Deleted (Superuser)", { deletedRequestId: requestId });
                        showToast("Request deleted.");
                    } catch (error) {
                        console.error("Delete request error:", error);
                        showToast("Could not delete request.", true);
                    }
                }
            );
        }
        
        async function handleDeleteItem(itemId, name) {
            showConfirmationModal(
                "Delete Inventory Item?",
                `Superuser: Delete "${name}" permanently? This is irreversible and will remove it from inventory.`,
                async () => {
                    try {
                        await deleteDoc(doc(getInventoryCollection(), itemId));
                        await logActivity("Inventory Item Deleted (Superuser)", { deletedItemId: itemId, name: name });
                        showToast("Item deleted.");
                    } catch (error) {
                        console.error("Delete item error:", error);
                        showToast("Could not delete item.", true);
                    }
                }
            );
        }
        
        async function handleBulkImport() {
            const importBtn = document.getElementById('bulk-import-btn');
            const outputEl = document.getElementById('bulk-import-output');
            const jsonInput = document.getElementById('bulk-import-json').value.trim();
            
            if (!jsonInput) {
                showToast("JSON input is empty.", true);
                return;
            }
            
            let items;
            try {
                items = JSON.parse(jsonInput);
                if (!Array.isArray(items)) throw new Error("Input is not a JSON array.");
            } catch (error) {
                showToast("Invalid JSON: " + error.message, true);
                return;
            }
            
            importBtn.disabled = true;
            importBtn.textContent = "Importing...";
            outputEl.innerHTML = 'Starting import...<br>';
            
            let addedCount = 0;
            let skippedCount = 0;
            const existingItemCodes = new Set(inventoryCache.map(i => i.itemCode));
            const batch = writeBatch(db);
            const batchLogPromises = [];
            
            for (const item of items) {
                if (!item.itemCode || !item.itemDescription || !item.itemCategory) {
                    outputEl.innerHTML += `<span class="text-yellow-600">Skipping:</span> Item is missing required fields (itemCode, itemDescription, itemCategory).<br>`;
                    skippedCount++;
                    continue;
                }
                
                if (existingItemCodes.has(item.itemCode)) {
                    outputEl.innerHTML += `<span class="text-gray-500">Skipping:</span> Item Code ${item.itemCode} already exists.<br>`;
                    skippedCount++;
                    continue;
                }
                
                // Add to batch
                const itemData = {
                    name: item.itemDescription,
                    itemCode: item.itemCode,
                    category: item.itemCategory,
                    stock: 0, // Default stock to 0
                    lowStockThreshold: 5, // Default
                    isHidden: false, // Default to visible
                    addedAt: serverTimestamp(),
                    lastAddition: { qty: 0, date: null, user: null },
                    lastWithdrawal: { qty: 0, date: null, user: null }
                };
                
                const newDocRef = doc(getInventoryCollection()); // Auto-generate ID
                batch.set(newDocRef, itemData);
                
                // Log this action
                batchLogPromises.push(logActivity("Inventory Item Added", { itemId: newDocRef.id, fromBulkImport: true, ...itemData }));
                
                existingItemCodes.add(item.itemCode); // Prevent duplicates in same batch
                addedCount++;
            }
            
            try {
                // Commit all items
                await batch.commit();
                // Log all items
                await Promise.all(batchLogPromises);
                
                outputEl.innerHTML += `<br><strong class="text-green-600">Import Complete!</strong><br>`;
                outputEl.innerHTML += `Added: ${addedCount}<br>`;
                outputEl.innerHTML += `Skipped: ${skippedCount}<br>`;
                
                await logActivity("Bulk Import Completed", { added: addedCount, skipped: skippedCount });
                showToast("Bulk import finished successfully!");
                document.getElementById('bulk-import-json').value = '';
                
            } catch (error) {
                console.error("Bulk import error:", error);
                outputEl.innerHTML += `<br><strong class="text-red-600">Error during import: ${error.message}</strong><br>`;
                showToast("Error during import. Check log.", true);
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = "Run Import";
            }
        }

        
        // --- 7. EVENT LISTENERS ---
        function setupStaticEventListeners() {
            // New public login button
            document.getElementById('public-login-btn').addEventListener('click', () => showView('login-view'));
        
            document.querySelector('button[onclick="handleLogout()"]').addEventListener('click', handleLogout);
            
            // User Nav
            document.querySelectorAll('#user-nav button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    if (page) showUserPage(page);
                });
            });
            document.getElementById('go-to-checkout-btn').addEventListener('click', () => showUserPage('user-checkout-page'));

            // Manager Nav
            document.querySelectorAll('#manager-nav button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    if (tab) showManagerTab(tab);
                });
            });
            
            // Dashboard quick actions
            document.getElementById('dash-view-all-pending').addEventListener('click', () => showManagerTab('user-mgt-tab'));
            document.getElementById('dash-view-all-low').addEventListener('click', () => showManagerTab('inventory-mgt-tab'));
            document.getElementById('dash-view-all-logs').addEventListener('click', () => showManagerTab('activity-log-tab'));
            
            // Other Listeners
            document.querySelector('button[onclick="handleAddInventoryItem()"]').addEventListener('click', handleAddInventoryItem);
            document.getElementById('confirm-request-btn').addEventListener('click', handleSubmitRequest);
            document.getElementById('copy-summary-btn').addEventListener('click', handleCopySummary);
            document.getElementById('bulk-import-btn').addEventListener('click', handleBulkImport);
            
            // Auth Listeners
            document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
            document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); handleRegister(); });
            document.getElementById('toggle-to-register').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(true); });
            document.getElementById('toggle-to-login').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(false); });
            
            // --- NEW: Filter Listeners ---
            // Use 'input' for live search
            // --- FIX: Add guards to prevent errors if elements don't exist ---
            
            // Public page filters are handled in setupPublicInventoryListener
            
            const userCategoryFilter = document.getElementById('user-category-filter');
            if (userCategoryFilter) {
                userCategoryFilter.addEventListener('input', () => renderUserInventory(inventoryCache));
            }
            
            const userSearchFilter = document.getElementById('user-search-filter');
            if (userSearchFilter) {
                userSearchFilter.addEventListener('input', () => renderUserInventory(inventoryCache));
            }
            
            const managerCategoryFilter = document.getElementById('manager-category-filter');
            if (managerCategoryFilter) {
                managerCategoryFilter.addEventListener('input', () => renderManagerInventory(inventoryCache));
            }
            
            const managerSearchFilter = document.getElementById('manager-search-filter');
            if (managerSearchFilter) {
                managerSearchFilter.addEventListener('input', () => renderManagerInventory(inventoryCache));
            }
            
            // Modal Listeners
            document.getElementById('modal-cancel-btn').addEventListener('click', closeConfirmationModal);
            document.getElementById('modal-stock-cancel-btn').addEventListener('click', closeAddStockModal);
            // document.getElementById('modal-edit-cancel-btn').addEventListener('click', closeEditItemModal); // DEPRECATED
            document.getElementById('item-history-close-btn').addEventListener('click', closeItemHistoryModal);
            
            // --- NEW LISTENER ---
            document.getElementById('modal-detail-cancel-btn').addEventListener('click', closeEditItemDetailsModal);
        }

        // --- 8. GLOBAL EXPORTS & INITIALIZATION ---
        window.handleAddToRequest = handleAddToRequest;
        window.handleUpdateRequestQuantity = handleUpdateRequestQuantity;
        window.handleRemoveFromRequest = handleRemoveFromRequest;
        // window.handleUpdateItemThreshold = handleUpdateItemThreshold; // DEPRECATED
        window.handleUpdateUserRole = handleUpdateUserRole;
        window.handleApproveUser = handleApproveUser;
        window.handleSuspendUser = handleSuspendUser;
        window.handleDeleteUser = handleDeleteUser;
        window.handleOpenAddStockModal = handleOpenAddStockModal;
        window.handleEditItemName = handleEditItemName; // Still used to open the modal
        window.handleViewItemHistory = handleViewItemHistory;
        window.handleDeleteLog = handleDeleteLog;
        window.handleDeleteRequest = handleDeleteRequest;
        window.handleDeleteItem = handleDeleteItem;
        window.handleLogout = handleLogout;
        window.showUserPage = showUserPage;
        window.showManagerTab = showManagerTab;
        
        // --- NEW EXPORTS ---
        window.handleOpenEditModal = handleOpenEditModal;
        window.handleQuickAddStock = handleQuickAddStock;
        window.handleToggleCategory = handleToggleCategory;

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupStaticEventListeners();
            showView('public-view'); // Start on public view, not loading
        });
        
    </script>

    <!-- Custom Styles -->
    <style>
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Remove all shadows */
        .shadow-lg, .shadow-xl, .shadow-md, .shadow-sm, .shadow, .shadow-inner {
             box-shadow: none !important;
        }
        body {
            font-family: Arial, sans-serif;
        }
        
        /* NEW: Marquee Scroll Animation */
        .marquee-container {
            height: 600px; /* Fixed height for the viewport */
            overflow-y: hidden;
            position: relative;
            /* Add a soft fade at the top and bottom */
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
        }

        .marquee-content-wrapper.scrolling {
            /* Animation properties are set by JS */
            animation-name: marquee-scroll;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        .marquee-content-wrapper.scrolling:hover {
            animation-play-state: paused;
        }
        
        @keyframes marquee-scroll {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50%); } /* Scrolls exactly one half (the original content) */
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Loading View (kept for initial JS load) -->
    <div id="loading-view" class="flex items-center justify-center min-h-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500"></div>
    </div>
    
    <!-- NEW Public View -->
    <div id="public-view" class="hidden flex-grow max-w-5xl mx-auto p-4 md:p-6 w-full">
        <header class="flex flex-col md:flex-row justify-between md:items-center mb-6 p-6 bg-white rounded-lg border">
            <div>
                <h1 class="text-4xl font-extrabold text-red-800">STORE-SIGHT</h1>
                <p class="text-gray-600">Hubli_Budarshingi_H Inventory-Stock Management</p>
                <p class="text-lg text-gray-800 font-bold mt-2">Store In-Charge: Ankita Chandrappa Bandi</p>
            </div>
            <div class="mt-4 md:mt-0 text-left md:text-right">
                <button id="public-login-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">
                    Employee Login
                </button>
            </div>
        </header>
        
        <main class="bg-white p-4 md:p-6 rounded-lg border">
            <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">Live Inventory Stock</h2>
            <p id="last-update-time" class="text-sm text-gray-500 mb-4">Loading...</p>
            <p id="public-inventory-error" class="hidden text-sm text-red-600 mb-4"></p>
            
            <!-- UPDATED: Public-side filters (Search Only) -->
            <div class="flex flex-col md:flex-row gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                <!-- Category Filter DIV removed -->
                <div class="flex-1">
                    <label for="public-search-filter" class="block text-sm font-medium text-gray-700">Search by Name/Code</label>
                    <input type="text" id="public-search-filter" placeholder="Type to search..." class="mt-1 block w-full rounded-lg border-gray-300">
                </div>
            </div>
            
            <!-- UPDATED: Marquee container changed to simple scroll container -->
            <div id="list-scroll-container" class="list-scroll-container mt-4">
                <!-- This is the list that will scroll -->
                <div id="public-inventory-list" class="space-y-4">
                    <!-- JS renders public inventory cards here -->
                    <p class="text-gray-500">Loading inventory...</p>
                </div>
                <!-- Removed clone and wrapper divs -->
            </div>
        </main>
    </div>

    <!-- Login View -->
    <div id="login-view" class="hidden flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <h1 class="text-4xl font-extrabold text-red-800 text-center mb-2">STORE-SIGHT</h1>
            <p class="text-center text-gray-600 mb-6">Hubli_Budarshingi_H Inventory-Stock Management</p>
            
            <form id="login-form" class="p-8 bg-white rounded-lg border space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center">Employee Login</h2>
                <div>
                    <label for="login-empid" class="block text-sm font-medium text-gray-700">Employee ID</label>
                    <input type="text" id="login-empid" required class="mt-1 block w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-2 focus:ring-red-300">
                </div>
                <div>
                    <label for="login-pin" class="block text-sm font-medium text-gray-700">4-Digit PIN</label>
                    <input type="password" id="login-pin" required maxlength="4" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-2 focus:ring-red-300">
                </div>
                
                <div id="auth-error-message" class="hidden text-sm text-red-600 font-medium"></div>

                <button id="login-button" type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 flex items-center justify-center gap-2">
                    <span id="login-spinner" class="spinner hidden"></span>
                    Login
                </button>
                <p class="text-sm text-center text-gray-600">
                    Don't have an account? 
                    <a href="#" id="toggle-to-register" class="font-medium text-red-600 hover:underline">Register here</a>
                </p>
            </form>
            
            <form id="register-form" class="hidden p-8 bg-white rounded-lg border space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center">Register</h2>
                <div>
                    <label for="register-empid" class="block text-sm font-medium text-gray-700">Employee ID</label>
                    <input type="text" id="register-empid" required class="mt-1 block w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-2 focus:ring-red-300">
                </div>
                <div>
                    <label for="register-pin" class="block text-sm font-medium text-gray-700">Create 4-Digit PIN</label>
                    <input type="password" id="register-pin" required maxlength="4" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-2 focus:ring-red-300">
                </div>

                <button id="register-button" type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                    <span id="register-spinner" class="spinner hidden"></span>
                    Register
                </button>
                <p class="text-sm text-center text-gray-600">
                    Already have an account? 
                    <a href="#" id="toggle-to-login" class="font-medium text-red-600 hover:underline">Login here</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Profile Setup View -->
    <div id="profile-setup-view" class="hidden flex-grow flex items-center justify-center p-4">
        <!-- JS will render the profile form here -->
    </div>
    
    <!-- Pending Approval View -->
    <div id="pending-view" class="hidden flex-grow flex items-center justify-center p-4 text-center">
        <div class="bg-white p-8 rounded-lg border max-w-lg">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Account Pending Approval</h1>
            <p class="text-gray-600 mb-6">Your profile is complete, but a manager still needs to approve your account before you can access the store. Please check back later.</p>
            <button onclick="handleLogout()" class="mt-2 text-sm text-red-500 hover:underline">
                Logout
            </button>
        </div>
    </div>
    
    <!-- Suspended View -->
    <div id="suspended-view" class="hidden flex-grow flex items-center justify-center p-4 text-center">
        <div class="bg-white p-8 rounded-lg border max-w-lg">
            <h1 class="text-2xl font-bold text-red-600 mb-4">Account Suspended</h1>
            <p class="text-gray-600 mb-6">Your account has been suspended. Please contact a manager for more information.</p>
            <button onclick="handleLogout()" class="mt-2 text-sm text-red-500 hover:underline">
                Logout
            </button>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-container" class="hidden flex-grow max-w-5xl mx-auto p-4 md:p-6 w-full">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between md:items-center mb-6 p-6 bg-white rounded-lg border-b-4 border-red-700">
            <div>
                <h1 class="text-4xl font-extrabold text-red-800">STORE-SIGHT</h1>
                <p class="text-gray-600">Hubli_Budarshingi_H Inventory-Stock Management</p>
            </div>
            <div class="mt-4 md:mt-0 text-left md:text-right">
                <p class="text-lg text-gray-800 font-bold">Store In-Charge: Ankita Chandrappa Bandi</p>
                <div class="text-sm text-gray-600 break-all mt-2">
                    <span id="user-id-display"></span>
                </div>
                <div class="text-sm font-semibold text-red-600">
                    <span id="user-role-display"></span>
                </div>
                <button onclick="handleLogout()" class="mt-2 text-sm text-red-500 hover:underline">
                    Logout
                </button>
            </div>
        </header>

        <!-- User Navigation -->
        <nav id="user-nav" class="flex justify-around bg-white rounded-lg border p-2 mb-6">
            <button data-page="user-inventory-page" class="flex-1 py-3 px-2 text-center font-semibold text-gray-700 hover:bg-gray-100 rounded-lg">
                Browse Items
            </button>
            <button data-page="user-request-page" class="flex-1 py-3 px-2 text-center font-semibold text-gray-700 hover:bg-gray-100 rounded-lg">
                Request List
            </button>
            <button data-page="user-requests-page" class="flex-1 py-3 px-2 text-center font-semibold text-gray-700 hover:bg-gray-100 rounded-lg">
                My Requests
            </button>
            <button data-page="user-profile-page" class="flex-1 py-3 px-2 text-center font-semibold text-gray-700 hover:bg-gray-100 rounded-lg">
                My Profile
            </button>
        </nav>
        
        <!-- Manager Navigation -->
        <nav id="manager-nav" class="hidden flex flex-wrap justify-center bg-gray-800 rounded-lg p-2 mb-6 gap-2">
            <button data-tab="dashboard-tab" class="flex-1 min-w-[120px] text-center py-3 px-4 font-semibold text-white bg-red-700 hover:bg-red-600 rounded-lg">
                Dashboard
            </button>
            <button data-tab="inventory-mgt-tab" class="flex-1 min-w-[120px] text-center py-3 px-4 font-semibold text-white bg-gray-700 hover:bg-red-600 rounded-lg">
                Inventory
            </button>
            <button data-tab="manager-requests-tab" class="flex-1 min-w-[120px] text-center py-3 px-4 font-semibold text-white bg-gray-700 hover:bg-red-600 rounded-lg">
                All Requests
            </button>
            <button data-tab="user-mgt-tab" class="flex-1 min-w-[120px] text-center py-3 px-4 font-semibold text-white bg-gray-700 hover:bg-red-600 rounded-lg">
                User Mgt
            </button>
             <button data-tab="activity-log-tab" class="flex-1 min-w-[120px] text-center py-3 px-4 font-semibold text-white bg-gray-700 hover:bg-red-600 rounded-lg">
                Activity Log
            </button>
            <button data-tab="user-profile-page" class="flex-1 min-w-[120px] text-center py-3 px-4 font-semibold text-white bg-gray-700 hover:bg-red-600 rounded-lg">
                My Profile
            </button>
            <!-- NEW: Superuser only button -->
            <button id="bulk-import-nav-btn" data-tab="bulk-import-tab" class="hidden flex-1 min-w-[120px] text-center py-3 px-4 font-semibold text-white bg-gray-700 hover:bg-red-600 rounded-lg">
                Bulk Import
            </button>
        </nav>

        <!-- ================================== -->
        <!--        COMMON PAGES (USER)         -->
        <!-- ================================== -->
        <main id="user-interface" class="hidden bg-gray-50 p-4 md:p-6 rounded-lg border">
            <!-- User Page: Inventory -->
            <div id="user-inventory-page">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">Products</h2>
                
                <!-- NEW: User-side filters -->
                <div class="flex flex-col md:flex-row gap-4 mb-4 p-4 bg-white rounded-lg border">
                    <div class="flex-1">
                        <label for="user-category-filter" class="block text-sm font-medium text-gray-700">Filter by Category</label>
                        <select id="user-category-filter" class="mt-1 block w-full rounded-lg border-gray-300">
                            <!-- Options will be added by JS -->
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="user-search-filter" class="block text-sm font-medium text-gray-700">Search by Name/Code</label>
                        <input type="text" id="user-search-filter" placeholder="Type to search..." class="mt-1 block w-full rounded-lg border-gray-300">
                    </div>
                </div>
                
                <div id="user-inventory-list" class="space-y-4"></div>
            </div>

            <!-- User Page: Request List -->
            <div id="user-request-page" class="hidden">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">Your Request List</h2>
                <div class="bg-white p-4 md:p-6 rounded-lg border">
                    <div id="request-items-list" class="space-y-4 mb-5"></div>
                    <hr class="my-4">
                    <div class="flex justify-between items-center mb-5">
                        <span class="text-lg font-medium text-gray-800">Total:</span>
                        <span id="request-total" class="text-lg font-bold text-gray-900">0 items</span>
                    </div>
                    <button id="go-to-checkout-btn" class="w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-600">
                        Proceed to Submit
                    </button>
                </div>
            </div>
            
            <!-- User Page: Checkout (Submit Request) -->
            <div id="user-checkout-page" class="hidden">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">Submit Request</h2>
                <div class="bg-white p-4 md:p-6 rounded-lg border">
                    <h3 class="text-xl font-semibold mb-4">1. Request Details</h3>
                    <div id="checkout-items-list" class="space-y-6 mb-6"></div>
                    <h3 class="text-xl font-semibold mb-4">2. Supervision</h3>
                    <div>
                        <label for="supervisor-name" class="block text-sm font-medium text-gray-700">Withdrawal Under Supervision Of:</label>
                        <input type="text" id="supervisor-name" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm" placeholder="Enter full name of security/supervisor">
                    </div>
                    <hr class="my-6">
                    <button id="confirm-request-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700">
                        Confirm Request
                    </button>
                </div>
            </div>
            
            <!-- User Page: Request History -->
            <div id="user-requests-page" class="hidden">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">My Request History</h2>
                <div id="user-requests-list" class="space-y-4">
                    <!-- JS renders history or error here -->
                </div>
            </div>
        </main>

        <!-- ================================== -->
        <!--        COMMON PAGES (MANAGER)      -->
        <!-- ================================== -->
        <main id="manager-interface" class="hidden bg-gray-50 p-4 md:p-6 rounded-lg border">
            <!-- Manager Tab: Dashboard -->
            <div id="dashboard-tab">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">Manager Dashboard</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg border text-center">
                        <h3 class="text-sm font-medium text-gray-500">Pending Users</h3>
                        <p id="kpi-pending-users" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border text-center">
                        <h3 class="text-sm font-medium text-gray-500">Low Stock Items</h3>
                        <p id="kpi-low-stock" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border text-center">
                        <h3 class="text-sm font-medium text-gray-500">Total Item Types</h3>
                        <p id="kpi-total-items" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Pending Users -->
                    <div class="lg:col-span-1 bg-white p-4 md:p-6 rounded-lg border">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Pending Approvals</h3>
                        <div id="dashboard-pending-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                        <button id="dash-view-all-pending" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                            View All Users
                        </button>
                    </div>
                    
                    <div class="lg:col-span-1 bg-white p-4 md:p-6 rounded-lg border">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Low Stock Items</h3>
                        <div id="dashboard-low-stock-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                        <button id="dash-view-all-low" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                            View All Inventory
                        </button>
                    </div>
                    
                    <div class="lg:col-span-1 bg-white p-4 md:p-6 rounded-lg border">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Recent Activity</h3>
                        <div id="dashboard-recent-activity" class="space-y-2 max-h-64 overflow-y-auto"></div>
                        <button id="dash-view-all-logs" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                            View Full Log
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manager Tab: Inventory Management -->
            <div id="inventory-mgt-tab" class="hidden">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">Inventory Management</h2>
                
                <div class="bg-white p-4 md:p-6 rounded-lg border mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Add New Item</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name/Description</label>
                            <input type="text" id="item-name" placeholder="e.g., Safety Helmet (Yellow)" class="mt-1 p-3 border rounded-lg w-full">
                        </div>
                        <div>
                            <label for="item-code" class="block text-sm font-medium text-gray-700">Item Code</label>
                            <input type="text" id="item-code" placeholder="e.g., HW-001" class="mt-1 p-3 border rounded-lg w-full">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label for="item-category" class="block text-sm font-medium text-gray-700">Category</label>
                            <input type="text" id="item-category" placeholder="e.g., Hardware" class="mt-1 p-3 border rounded-lg w-full">
                        </div>
                        <div>
                            <label for="item-stock" class="block text-sm font-medium text-gray-700">Initial Stock</label>
                            <input type="number" id="item-stock" value="10" class="mt-1 p-3 border rounded-lg w-full">
                        </div>
                        <div>
                            <label for="item-low-stock" class="block text-sm font-medium text-gray-700">Low Stock Threshold</label>
                            <input type="number" id="item-low-stock" value="5" class="mt-1 p-3 border rounded-lg w-full">
                        </div>
                    </div>
                    <button onclick="handleAddInventoryItem()" class="mt-4 w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">
                        Add New Item
                    </button>
                </div>
                
                <div class="bg-white p-4 md:p-6 rounded-lg border">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Manage Stock</h3>
                    
                    <!-- NEW: Manager-side filters -->
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="flex-1">
                            <label for="manager-category-filter" class="block text-sm font-medium text-gray-700">Filter by Category</label>
                            <select id="manager-category-filter" class="mt-1 block w-full rounded-lg border-gray-300">
                                <!-- Options will be added by JS -->
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="manager-search-filter" class="block text-sm font-medium text-gray-700">Search by Name/Code</label>
                            <input type="text" id="manager-search-filter" placeholder="Type to search..." class="mt-1 block w-full rounded-lg border-gray-300">
                        </div>
                    </div>
                    
                    <!-- NEW RENDERED LIST -->
                    <div id="manager-inventory-list" class="space-y-4"></div>
                </div>
            </div>
            
            <!-- Manager Tab: Request History -->
            <div id="manager-requests-tab" class="hidden">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">All Request History</h2>
                <div id="manager-requests-list" class="space-y-4"></div>
            </div>
            
            <!-- Manager Tab: User Management -->
            <div id="user-mgt-tab" class="hidden">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">User Role Management</h2>
                <div class="bg-white p-4 md:p-6 rounded-lg border">
                    <div id="user-roles-list" class="space-y-4"></div>
                </div>
            </div>
            
             <!-- Manager Tab: Activity Log -->
            <div id="activity-log-tab" class="hidden">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">Activity Log (Ledger)</h2>
                <div class="bg-white p-4 md:p-6 rounded-lg border">
                    <div id="activity-log-list" class="space-y-3 max-h-[800px] overflow-y-auto"></div>
                </div>
            </div>
            
            <!-- NEW: Superuser only tab -->
            <div id="bulk-import-tab" class="hidden">
                <h2 class="text-3xl font-bold mb-4 text-red-800 border-b-2 border-red-200 pb-2">Bulk Item Import</h2>
                <div class="bg-white p-4 md:p-6 rounded-lg border">
                    <p class="mb-4 text-gray-600">Paste your formatted JSON array here to import new items. See the "Bulk Import Guide" for instructions.</p>
                    <textarea id="bulk-import-json" class="w-full h-64 p-3 border rounded-lg font-mono text-sm" placeholder="[ ... ]"></textarea>
                    <button id="bulk-import-btn" class-="mt-4 w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700">
                        Run Import
                    </button>
                    
                    <h3 class="text-xl font-semibold mt-6 mb-4 text-gray-800 border-b pb-2">Import Log</h3>
                    <div id="bulk-import-output" class="w-full h-48 p-3 bg-gray-100 border rounded-lg overflow-y-auto font-mono text-sm">
                        Waiting for import...
                    </div>
                </div>
            </div>
            
        </main>
        
        <!-- Common Page: Profile (Used by both User & Manager) -->
        <div id="user-profile-page" class="hidden bg-gray-50 p-4 md:p-6 rounded-lg border">
            <!-- JS will render the profile form here -->
        </div>
        
        <!-- Common Page: Request Summary (MOVED HERE) -->
        <div id="request-summary-page" class="hidden bg-gray-50 p-4 md:p-6 rounded-lg border">
            <h2 id="request-summary-title" class="text-2xl font-semibold mb-4 text-green-600"></h2>
            <div class="bg-white p-4 md:p-6 rounded-lg border">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-red-800 border-b-2 border-red-200 pb-2">Withdrawal Slip</h3>
                    <button id="copy-summary-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">
                        Copy Summary
                    </button>
                </div>
                <div id="request-summary-details"></div>
                <!-- Back Button Container -->
                <div id="summary-back-btn-container" class="mt-6"></div>
            </div>
        </div>
        
    </div>
    
    <!-- Footer -->
    <footer class="text-center py-4 mt-8">
        <p class="text-sm text-gray-600">Designed by Rh. for  Team Sonic</p>
    </footer>
    
    <!-- Toast Notification -->
    <div id="toast-message" class="hidden opacity-0 fixed top-5 right-5 z-50 bg-green-600 text-white py-3 px-6 rounded-lg border transition-all duration-500">
        <!-- Message set by JS -->
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg border p-6 max-w-sm w-full">
            <h2 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">Are you sure?</h2>
            <p id="modal-message" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button id="modal-confirm-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Stock Modal (Legacy, but kept for Dashboard quick-add) -->
    <div id="add-stock-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg border p-6 max-w-sm w-full">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Add Stock</h2>
            <p class="text-gray-600 mb-2">Item: <span id="modal-stock-item-name" class="font-semibold"></span></p>
            <p class="text-gray-600 mb-4">Current Stock: <span id="modal-stock-current" class="font-semibold"></span></p>
            <div>
                <label for="modal-stock-add-qty" class="block text-sm font-medium text-gray-700">Quantity to Add:</label>
                <input type="number" id="modal-stock-add-qty" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-stock-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button id="modal-stock-confirm-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">
                    Add
                </button>
            </div>
        </div>
    </div>

    <!-- NEW Item History Modal -->
    <div id="item-history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg border p-6 max-w-lg w-full">
            <h2 id="item-history-title" class="text-xl font-bold text-gray-900 mb-4">Item History</h2>
            <div id="item-history-list" class="space-y-3 max-h-[60vh] overflow-y-auto bg-gray-50 p-4 rounded-lg border">
                <!-- JS renders history or error here -->
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="item-history-close-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- DEPRECATED Edit Item Modal (No longer used, replaced by item-details-modal) -->
    <div id="edit-item-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg border p-6 max-w-lg w-full">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Edit Item Details</h2>
            <div class="space-y-4">
                <div>
                    <label for="modal-edit-item-name" class="block text-sm font-medium text-gray-700">Item Name/Description</label>
                    <input type="text" id="modal-edit-item-name" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm">
                </div>
                 <div>
                    <label for="modal-edit-item-code" class="block text-sm font-medium text-gray-700">Item Code</label>
                    <input type="text" id="modal-edit-item-code" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm">
                </div>
                 <div>
                    <label for="modal-edit-item-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="modal-edit-item-category" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-edit-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button id="modal-edit-confirm-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW Edit Item Details Modal (Replaces the one above) -->
    <div id="item-details-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg border p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h2 id="item-details-title" class="text-xl font-bold text-gray-900 mb-4">Edit Item</h2>
            <div class="space-y-4">
                <div>
                    <label for="modal-detail-item-name" class="block text-sm font-medium text-gray-700">Item Name/Description</label>
                    <input type="text" id="modal-detail-item-name" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm">
                </div>
                 <div>
                    <label for="modal-detail-item-code" class="block text-sm font-medium text-gray-700">Item Code</label>
                    <input type="text" id="modal-detail-item-code" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm">
                </div>
                 <div>
                    <label for="modal-detail-item-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="modal-detail-item-category" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm">
                </div>
                <div>
                    <label for="modal-detail-item-threshold" class="block text-sm font-medium text-gray-700">Low Stock Threshold</label>
                    <input type="number" id="modal-detail-item-threshold" class="mt-1 block w-full rounded-lg border-gray-300 sm:text-sm">
                </div>
                <hr>
                <div class="flex items-center">
                    <input type="checkbox" id="modal-detail-item-hidden" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <label for="modal-detail-item-hidden" class="ml-2 block text-sm font-medium text-gray-700">Hide from Public Inventory</label>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-detail-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button id="modal-detail-confirm-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

</body>
</html>
