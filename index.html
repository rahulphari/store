<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STORE-SIGHT</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Google Font: Inter (for a modern, clean look) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 3. Firebase SDK (ES Module) -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where,
            orderBy,
            serverTimestamp,
            runTransaction,
            writeBatch,
            getDocs,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- GLOBAL VARIABLES ---
        let db, auth;
        let currentUserId, currentUserEmail, currentUserRole;
        let currentUserProfile = null;
        let lastRequestCache = null;
        
        // Data Caches
        let inventoryCache = [];
        let localRequestCache = []; // Renamed from localCartCache
        let userRolesCache = []; // Cache for dashboard
        let managerRequestsCache = []; // NEW cache for dashboard alerts
        let feedbackCache = []; // NEW cache for dashboard alerts

        // Listeners
        let unsubscribePublicInventory = () => {};
        let unsubscribeInventory = () => {};
        let unsubscribeRequestList = () => {}; // Renamed
        let unsubscribeUserRequests = () => {}; // Renamed
        let unsubscribeManagerRequests = () => {}; // Renamed
        let unsubscribeUserRoles = () => {};
        let unsubscribeActivityLog = () => {};
        let unsubscribeDashboardLogs = () => {};
        let unsubscribeManagerAlertRequests = () => {}; // NEW
        let unsubscribeManagerAlertFeedback = () => {}; // NEW


        // --- USER'S FIREBASE CONFIG ---
        // This config is public. For a real app, you'd secure this.
        const firebaseConfig = {
          apiKey: "AIzaSyDmCSYXnlcXfxt-MvoEkGs0ilVW-E2_Ex4",
          authDomain: "hubli-store.firebaseapp.com",
          projectId: "hubli-store",
          storageBucket: "hubli-store.firebasestorage.app",
          messagingSenderId: "324782981287",
          appId: "1:324782981287:web:10f6b46d6a5f222a155b82",
          measurementId: "G-FRFB45079Q"
        };
        
        const appId = firebaseConfig.projectId; // Using "hubli-store"
        // --- END OF CONFIG ---


        // --- DATABASE PATHS ---
        const getInventoryCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
        const getUserRolesCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'user_roles');
        const getRequestsCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'orders'); // "orders" collection in DB
        const getActivityLogCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'activity_log');
        const getFeedbackCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'feedback'); // NEW
        const getUserRequestListCollection = (userId) => collection(db, 'artifacts', appId, 'users', userId, 'cart'); // "cart" collection in DB
        
        // Helper function for logging all actions
        async function logActivity(action, details = {}) {
            try {
                const user = currentUserProfile?.name || currentUserEmail || "System";
                await addDoc(getActivityLogCollection(), {
                    timestamp: serverTimestamp(),
                    action: action,
                    user: user,
                    userId: currentUserId || null,
                    details: details // e.g., { itemId: "...", newName: "..." }
                });
            } catch (error) {
                console.error("Failed to log activity:", error);
            }
        }
        
        // --- NEW: Feedback Submission ---
        async function handleFeedbackSubmit() {
            const feedbackInput = document.getElementById('feedback-text');
            const typeSelect = document.getElementById('feedback-type');
            const text = feedbackInput.value.trim();
            const type = typeSelect.value;
            
            if (!text) {
                showToast("Please enter your feedback before submitting.", true);
                return;
            }
            
            const feedbackBtn = document.getElementById('submit-feedback-btn');
            feedbackBtn.disabled = true;
            feedbackBtn.textContent = "Submitting...";
            
            try {
                await addDoc(getFeedbackCollection(), {
                    text: text,
                    type: type,
                    status: "new", // "new" or "read"
                    submittedAt: serverTimestamp(),
                    user: {
                        id: currentUserId || null,
                        email: currentUserEmail || "Guest",
                        name: currentUserProfile?.name || "Guest"
                    }
                });
                showToast("Feedback submitted successfully. Thank you!");
                feedbackInput.value = '';
                closeFeedbackModal();
            } catch (error) {
                console.error("Feedback submission error:", error);
                showToast("Could not submit feedback.", true);
            } finally {
                feedbackBtn.disabled = false;
                feedbackBtn.textContent = "Submit Feedback";
            }
        }


        // --- 1. INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Error'); // Keep console clean
                
                // Start public listener *before* auth
                setupPublicInventoryListener(); 
                
                setupAuthListener();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                const publicError = document.getElementById('public-inventory-error');
                if (publicError) {
                    publicError.textContent = "Error connecting to inventory services. Please refresh.";
                    publicError.classList.remove('hidden');
                }
            }
        }
        
        function setupPublicInventoryListener() {
            const inventoryQuery = query(getInventoryCollection(), orderBy('name'));
            unsubscribePublicInventory = onSnapshot(inventoryQuery, (snapshot) => {
                const inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Find the most recent update time
                let lastUpdate = null;
                inventory.forEach(item => {
                    const addTime = item.lastAddition?.date?.toDate();
                    const withdrawTime = item.lastWithdrawal?.date?.toDate();
                    if (addTime && (!lastUpdate || addTime > lastUpdate)) lastUpdate = addTime;
                    if (withdrawTime && (!lastUpdate || withdrawTime > lastUpdate)) lastUpdate = withdrawTime;
                });
                
                const updateEl = document.getElementById('last-update-time');
                if (updateEl) {
                    updateEl.textContent = lastUpdate ? `Inventory last updated: ${lastUpdate.toLocaleString()}` : `Inventory up-to-date.`;
                }

            }, (error) => {
                console.error("Public inventory listener error:", error);
                const updateEl = document.getElementById('last-update-time');
                if (updateEl) {
                    updateEl.textContent = "Could not load inventory status.";
                    updateEl.classList.add('text-red-500');
                }
            });
        }

        // --- 2. AUTHENTICATION & PROFILE ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                unsubscribeAll(); // Unsubscribe auth-only listeners
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    await checkUserRoleAndProfile(user);
                } else {
                    currentUserId = null;
                    currentUserEmail = null;
                    currentUserRole = null;
                    currentUserProfile = null;
                    showView('public-view'); // Default to public view on logout
                }
            });
        }

        async function checkUserRoleAndProfile(user) {
            const userId = user.uid;
            const userRoleRef = doc(getUserRolesCollection(), userId);
            const userDoc = await getDoc(userRoleRef);

            if (userDoc.exists()) {
                const data = userDoc.data();
                currentUserRole = data.role; // 'user', 'manager', or 'superuser'
                currentUserProfile = {
                    name: data.name || '',
                    empId: data.empId || '',
                    designation: data.designation || '',
                    email: data.email || user.email,
                    status: data.status || 'pending'
                };
                
                // --- Robust Status Check ---
                
                // 1. Suspended? Stop immediately.
                if (currentUserProfile.status === 'suspended') {
                    showView('suspended-view');
                    return;
                }
                
                // 2. Profile incomplete? Force setup.
                if (!currentUserProfile.name) {
                    renderProfilePage(true); // 'true' for isFirstTime setup
                    showView('profile-setup-view');
                    return;
                }
                
                // 3. Profile complete, but pending? Force wait.
                // (Managers/Superusers skip this check)
                if (currentUserProfile.status === 'pending' && currentUserRole === 'user') {
                    showView('pending-view');
                    return;
                }
                
                // 4. Active user, or manager/superuser? Let them in.
                if (currentUserProfile.status === 'active' || currentUserRole === 'manager' || currentUserRole === 'superuser') {
                    showView('app-container');
                    // --- NEW: Populate modern header ---
                    document.getElementById('header-user-name').textContent = currentUserProfile.name;
                    document.getElementById('header-user-details').textContent = `Emp ID: ${currentUserProfile.empId} | Role: ${currentUserRole}`;
                    
                    setupUIForRole(currentUserRole);
                    attachDataListeners(currentUserRole, userId);
                    return;
                }

                // Fallback (shouldn't be reached)
                console.warn("Unhandled user state:", currentUserProfile);
                showView('public-view');
                
            } else {
                // New user: Create a default 'user' role, force profile setup, and set status to 'pending'
                const emailEmpId = user.email.split('@')[0].split('-')[1] || null;

                currentUserRole = 'user';
                await setDoc(userRoleRef, { 
                    role: 'user', 
                    status: 'pending', // All new users are pending
                    created: serverTimestamp(),
                    userId: userId,
                    email: user.email,
                    name: "", 
                    empId: emailEmpId, // Save the Employee ID
                    designation: ""
                });
                await logActivity("User Registered", { email: user.email, empId: emailEmpId });
                // Recurse to trigger profile setup
                await checkUserRoleAndProfile(user);
            }
        }

        async function handleProfileUpdate(isFirstTime) {
            const name = document.getElementById('profile-name').value.trim();
            const empId = document.getElementById('profile-empId').value.trim(); // This is read-only, but we get it
            const designation = document.getElementById('profile-designation').value.trim();
            
            if (!name || !empId || !designation) {
                showToast("Please fill in all profile fields.", true);
                return;
            }
            
            const userRoleRef = doc(getUserRolesCollection(), currentUserId);
            try {
                await updateDoc(userRoleRef, {
                    name: name,
                    empId: empId,
                    designation: designation
                    // Status remains 'pending'
                });
                
                if (isFirstTime) {
                    await logActivity("Profile Completed", { name: name });
                }

                currentUserProfile = { ...currentUserProfile, name, empId, designation };
                showToast("Profile updated successfully!");
                
                await checkUserRoleAndProfile(auth.currentUser);

            } catch (error) {
                console.error("Profile update error:", error);
                showToast("Failed to update profile.", true);
            }
        }
        
        async function handleRegister() {
            const empId = document.getElementById('register-empid').value.trim();
            const pin = document.getElementById('register-pin').value.trim();
            
            if (!empId || !pin) {
                showAuthError("Please enter both Employee ID and PIN.");
                return;
            }
            if (!/^\d{4}$/.test(pin)) {
                showAuthError("PIN must be exactly 4 digits.");
                return;
            }
            
            const email = `user-${empId}@hubli-store.app`;
            const password = `PIN-${pin}`; // Add prefix
            
            try {
                showAuthLoading(true);
                await createUserWithEmailAndPassword(auth, email, password);
                showAuthLoading(false);
                showAuthError("");
            } catch (error) {
                console.error("Registration Error:", error);
                showAuthError(getFriendlyAuthError(error));
                showAuthLoading(false);
            }
        }

        async function handleLogin() {
            const empId = document.getElementById('login-empid').value.trim();
            const pin = document.getElementById('login-pin').value.trim();
            
            if (!empId || !pin) {
                showAuthError("Please enter both Employee ID and PIN.");
                return;
            }
            
            const email = `user-${empId}@hubli-store.app`;
            const password = `PIN-${pin}`; // Add prefix

            try {
                showAuthLoading(true);
                await signInWithEmailAndPassword(auth, email, password);
                showAuthLoading(false);
                showAuthError("");
            } catch (error) {
                console.error("Login Error:", error);
                showAuthError(getFriendlyAuthError(error));
                showAuthLoading(false);
            }
        }

        async function handleLogout() {
            await signOut(auth);
            // Auth listener will automatically route to public-view
        }
        
        function getFriendlyAuthError(error) {
            switch (error.code) {
                case 'auth/invalid-email': return 'Please enter a valid Employee ID.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Invalid Employee ID or PIN.';
                case 'auth/email-already-in-use': return 'This Employee ID is already registered.';
                case 'auth/weak-password': return 'PIN must be at least 4 digits.';
                default: return 'An error occurred. Please try again.';
            }
        }

        // --- 3. UI & VIEW MANAGEMENT ---
        function showView(viewId) {
            ['loading-view', 'public-view', 'app-container', 'profile-setup-view', 'pending-view', 'suspended-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        function toggleAuthForms(showRegister) {
            document.getElementById('login-form-container').classList.toggle('hidden', showRegister);
            document.getElementById('register-form-container').classList.toggle('hidden', !showRegister);
            showAuthError("");
        }
        
        function showAuthError(message) {
            const errorEl = document.getElementById('auth-error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.toggle('hidden', !message);
            }
        }

        function showAuthLoading(isLoading) {
            document.getElementById('login-button').disabled = isLoading;
            document.getElementById('register-button').disabled = isLoading;
            document.getElementById('login-spinner').classList.toggle('hidden', !isLoading);
            document.getElementById('register-spinner').classList.toggle('hidden', !isLoading);
        }

        function setupUIForRole(role) {
            const isManagerOrSuper = (role === 'manager' || role === 'superuser');
            
            // Hide all main interfaces first
            document.getElementById('user-interface').classList.add('hidden');
            document.getElementById('manager-interface').classList.add('hidden');
            document.getElementById('request-summary-page').classList.add('hidden');
            document.getElementById('user-profile-page').classList.add('hidden');
            
            // Show/hide superuser-only tabs
            document.getElementById('bulk-import-nav-btn').classList.toggle('hidden', !isManagerOrSuper); // Managers get it too
            document.getElementById('delete-item-permissions').classList.toggle('hidden', role !== 'superuser');


            if (isManagerOrSuper) {
                document.getElementById('manager-interface').classList.remove('hidden');
                document.getElementById('manager-nav').classList.remove('hidden');
                document.getElementById('user-nav').classList.add('hidden');
                showManagerTab('dashboard-tab');
            } else {
                document.getElementById('user-interface').classList.remove('hidden');
                document.getElementById('manager-nav').classList.add('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                showUserPage('user-inventory-page');
            }
        }
        
        // --- NEW: ANIMATED PAGE CHANGER ---
        function showUserPage(pageId) {
            const pages = ['user-inventory-page', 'user-request-page', 'user-checkout-page', 'user-requests-page', 'user-profile-page'];
            const navLinks = document.querySelectorAll('#user-nav a');
            
            // Hide all pages and apply fade-in to target
            pages.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === pageId) {
                        el.classList.remove('hidden');
                        el.classList.add('page-fade-in');
                    } else {
                        el.classList.add('hidden');
                        el.classList.remove('page-fade-in');
                    }
                }
            });
            
            // Set active tab style
            navLinks.forEach(link => {
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('bg-red-700', 'text-white');
                    link.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    link.classList.remove('bg-red-700', 'text-white');
                    link.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });

            if (pageId === 'user-checkout-page') renderCheckoutPage();
            if (pageId === 'user-profile-page') renderProfilePage(false);
        }

        // --- NEW: ANIMATED TAB CHANGER ---
        function showManagerTab(tabId) {
            const tabs = ['dashboard-tab', 'inventory-mgt-tab', 'user-mgt-tab', 'manager-requests-tab', 'activity-log-tab', 'user-profile-page', 'bulk-import-tab'];
            const navLinks = document.querySelectorAll('#manager-nav a');
            
            // Hide all tabs and apply fade-in to target
            tabs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === tabId) {
                        el.classList.remove('hidden');
                        el.classList.add('page-fade-in');
                    } else {
                        el.classList.add('hidden');
                        el.classList.remove('page-fade-in');
                    }
                }
            });
            
            // Also hide the summary page when changing tabs
            document.getElementById('request-summary-page').classList.add('hidden');
            
            // Set active tab style
            navLinks.forEach(link => {
                if (link.getAttribute('data-tab') === tabId) {
                    link.classList.add('bg-red-700', 'text-white');
                    link.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    link.classList.remove('bg-red-700', 'text-white');
                    link.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });

            if (tabId === 'user-profile-page') renderProfilePage(false);
            if (tabId === 'dashboard-tab') renderDashboard(); // Re-render dashboard on view
        }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-message');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.remove('hidden', 'opacity-0', '-translate-y-12');
            toast.classList.toggle('bg-red-600', isError);
            toast.classList.toggle('bg-green-600', !isError);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-12');
                setTimeout(() => toast.classList.add('hidden'), 500);
            }, 3000);
        }
        
        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => {
                onConfirm();
                closeConfirmationModal();
            };
            
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }
        
        function closeItemHistoryModal() {
            document.getElementById('item-history-modal').classList.add('hidden');
        }
        
        function openRulesModal() {
            document.getElementById('store-rules-modal').classList.remove('hidden');
        }
        function closeRulesModal() {
            document.getElementById('store-rules-modal').classList.add('hidden');
        }
        
        function openFeedbackModal() {
            document.getElementById('feedback-modal').classList.remove('hidden');
        }
        function closeFeedbackModal() {
            document.getElementById('feedback-modal').classList.add('hidden');
        }


        // --- 4. DATA LISTENERS ---
        function attachDataListeners(role, userId) {
            const isManagerOrSuper = (role === 'manager' || role === 'superuser');
            
            // 1. Listen to Inventory (all auth'd users)
            const inventoryQuery = query(getInventoryCollection(), orderBy('name'));
            unsubscribeInventory = onSnapshot(inventoryQuery, (snapshot) => {
                inventoryCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (role === 'user') {
                    renderUserInventory(inventoryCache);
                    renderUserRequestList(localRequestCache, inventoryCache); // Re-render list with fresh names
                }
                if (isManagerOrSuper) {
                    renderManagerInventory(inventoryCache);
                    if (document.getElementById('dashboard-tab').offsetParent) {
                        renderDashboard(); // Re-render dashboard if it's visible
                    }
                }
            }, (error) => console.error("Inventory listener error:", error));

            // 2. Listen to User Request List (only for regular users)
            if (role === 'user') {
                const requestListQuery = query(getUserRequestListCollection(userId));
                unsubscribeRequestList = onSnapshot(requestListQuery, (snapshot) => {
                    localRequestCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserRequestList(localRequestCache, inventoryCache);
                }, (error) => console.error("Request list listener error:", error));
            }
            
            // 3. Listen to User Requests (only for regular users)
            if (role === 'user') {
                const userRequestsQuery = query(getRequestsCollection(), where('userId', '==', userId), orderBy('createdAt', 'desc'));
                unsubscribeUserRequests = onSnapshot(userRequestsQuery, (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserRequests(requests);
                }, (error) => {
                    console.error("User requests listener error:", error);
                    const list = document.getElementById('user-requests-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-600 font-medium col-span-1 md:col-span-2">Error loading history. The database may be missing a required index. Please contact your administrator.</p>`;
                    }
                });
            }

            // 4. Listen to User Roles, All Requests, Activity Log (only for managers/supers)
            if (isManagerOrSuper) {
                // User Roles
                const usersQuery = query(getUserRolesCollection(), orderBy('created', 'desc'));
                unsubscribeUserRoles = onSnapshot(usersQuery, (snapshot) => {
                    userRolesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserRoles(userRolesCache);
                    if (document.getElementById('dashboard-tab').offsetParent) {
                        renderDashboard(); // Re-render dashboard for pending user count
                    }
                }, (error) => console.error("User roles listener error:", error));
                
                // All Requests (for main list)
                const allRequestsQuery = query(getRequestsCollection(), orderBy('createdAt', 'desc'));
                unsubscribeManagerRequests = onSnapshot(allRequestsQuery, (snapshot) => {
                    managerRequestsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderManagerRequests(managerRequestsCache);
                }, (error) => console.error("Manager requests listener error:", error));
                
                // --- NEW: Pending Requests (for dashboard alerts) ---
                const pendingRequestsQuery = query(getRequestsCollection(), where('status', '==', 'pending'), orderBy('createdAt', 'desc'));
                unsubscribeManagerAlertRequests = onSnapshot(pendingRequestsQuery, (snapshot) => {
                    const pendingRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Just update the cache, renderDashboard will read it
                    managerRequestsCache = [...pendingRequests, ...managerRequestsCache.filter(r => r.status !== 'pending')];
                    if (document.getElementById('dashboard-tab').offsetParent) {
                        renderDashboard();
                    }
                }, (error) => console.error("Manager pending requests listener error:", error));
                
                // --- NEW: New Feedback (for dashboard alerts) ---
                const newFeedbackQuery = query(getFeedbackCollection(), where('status', '==', 'new'), orderBy('submittedAt', 'desc'));
                unsubscribeManagerAlertFeedback = onSnapshot(newFeedbackQuery, (snapshot) => {
                    feedbackCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (document.getElementById('dashboard-tab').offsetParent) {
                        renderDashboard();
                    }
                }, (error) => console.error("Manager feedback listener error:", error));
                
                // Full Activity Log
                const logQuery = query(getActivityLogCollection(), orderBy('timestamp', 'desc'), limit(50));
                unsubscribeActivityLog = onSnapshot(logQuery, (snapshot) => {
                    const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderActivityLog(logs);
                }, (error) => console.error("Activity log listener error:", error));
                
                // Dashboard Activity Log (just 5 items)
                const dashLogQuery = query(getActivityLogCollection(), orderBy('timestamp', 'desc'), limit(5));
                unsubscribeDashboardLogs = onSnapshot(dashLogQuery, (snapshot) => {
                    if (document.getElementById('dashboard-tab').offsetParent) {
                        renderDashboardRecentActivity(snapshot.docs);
                    }
                }, (error) => console.error("Dashboard log listener error:", error));
            }
        }

        function unsubscribeAll() {
            unsubscribeInventory();
            unsubscribeRequestList();
            unsubscribeUserRequests();
            unsubscribeManagerRequests();
            unsubscribeUserRoles();
            unsubscribeActivityLog();
            unsubscribeDashboardLogs();
            unsubscribeManagerAlertRequests(); // NEW
            unsubscribeManagerAlertFeedback(); // NEW
        }

        // --- 5. REGULAR USER: ACTIONS & RENDERING ---
        async function handleAddToRequest(itemId, itemName, maxStock) { // Renamed
            if (maxStock <= 0) {
                showToast("Item is out of stock.", true);
                return;
            }
            
            const requestItemRef = doc(getUserRequestListCollection(currentUserId), itemId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const requestItemDoc = await transaction.get(requestItemRef);
                    
                    if (requestItemDoc.exists()) {
                        const newQuantity = requestItemDoc.data().quantity + 1;
                        if (newQuantity > maxStock) {
                            throw new Error("Cannot add more than available stock.");
                        }
                        transaction.update(requestItemRef, { quantity: newQuantity });
                    } else {
                        // Find full item data
                        const inventoryItem = inventoryCache.find(item => item.id === itemId);
                        transaction.set(requestItemRef, {
                            productId: itemId,
                            productName: inventoryItem.name, // Use full name
                            itemCode: inventoryItem.itemCode,
                            category: inventoryItem.category,
                            quantity: 1,
                            addedAt: serverTimestamp()
                        });
                    }
                });
                showToast("Item added to request list!");
            } catch (error) {
                console.error("Add to list error:", error.message);
                showToast(error.message || "Could not add item.", true);
            }
        }

        async function handleUpdateRequestQuantity(itemId, newQuantity) { // Renamed
            const requestItemRef = doc(getUserRequestListCollection(currentUserId), itemId);
            if (newQuantity <= 0) {
                await deleteDoc(requestItemRef);
                showToast("Item removed from list.");
            } else {
                const inventoryItem = inventoryCache.find(item => item.id === itemId);
                if (inventoryItem && newQuantity > inventoryItem.stock) {
                    showToast("Cannot add more than available stock.", true);
                } else {
                    await updateDoc(requestItemRef, { quantity: newQuantity });
                    showToast("List updated.");
                }
            }
        }

        async function handleRemoveFromRequest(itemId) { // Renamed
            const requestItemRef = doc(getUserRequestListCollection(currentUserId), itemId);
            await deleteDoc(requestItemRef);
            showToast("Item removed from list.");
        }

        async function handleSubmitRequest() { // Renamed
            const checkoutButton = document.getElementById('confirm-request-btn');
            checkoutButton.disabled = true;
            checkoutButton.textContent = "Submitting...";

            const supervisorName = document.getElementById('supervisor-name').value.trim();
            if (!supervisorName) {
                showToast("Please enter the supervisor's name.", true);
                checkoutButton.disabled = false;
                checkoutButton.textContent = "Confirm Request";
                return;
            }
            
            let newRequestData;
            let requestId;
            const logPromises = []; // For the item-specific logs

            try {
                // --- ATOMIC TRANSACTION ---
                await runTransaction(db, async (transaction) => {
                    // --- 1. READ PHASE ---
                    
                    // 1a. Read all request list items
                    const listSnapshot = await getDocs(query(getUserRequestListCollection(currentUserId)));
                    const listItems = listSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (listItems.length === 0) {
                        throw new Error("Your request list is empty.");
                    }

                    // 1b. Read all inventory items in the list
                    const inventoryDocs = new Map();
                    const readPromises = listItems.map(item => {
                        const itemRef = doc(getInventoryCollection(), item.productId);
                        return transaction.get(itemRef).then(doc => inventoryDocs.set(item.productId, doc));
                    });
                    await Promise.all(readPromises);

                    // --- 2. VALIDATION PHASE (In-Memory) ---
                    const itemsWithDetails = [];
                    for (const item of listItems) {
                        const inventoryDoc = inventoryDocs.get(item.productId);
                        if (!inventoryDoc || !inventoryDoc.exists()) {
                            throw new Error(`Item "${item.productName}" is no longer available.`);
                        }
                        
                        const inventoryData = inventoryDoc.data();
                        
                        // --- NEW: Check if hidden ---
                        if (inventoryData.isHidden) {
                            throw new Error(`Item "${inventoryData.name}" is currently unavailable.`);
                        }
                        
                        if (inventoryData.stock < item.quantity) {
                            throw new Error(`Not enough stock for "${inventoryData.name}". Only ${inventoryData.stock} left.`);
                        }
                        
                        itemsWithDetails.push({
                            ...item,
                            remarks: document.getElementById(`remarks-${item.id}`).value.trim()
                        });
                    }

                    // --- 3. WRITE PHASE (All writes at the end) ---
                    
                    // 3a. Prepare the new request
                    const newRequestRef = doc(getRequestsCollection()); // Auto-generate ID
                    requestId = newRequestRef.id; // Store ID for logging
                    newRequestData = {
                        userId: currentUserId,
                        userProfile: currentUserProfile,
                        status: "pending", // ALWAYS "pending"
                        createdAt: serverTimestamp(),
                        supervisorName: supervisorName,
                        items: itemsWithDetails // Now includes full item details from cart
                    };
                    
                    // 3b. Write 1: Create the new request
                    transaction.set(newRequestRef, newRequestData);

                    const withdrawalTime = serverTimestamp();
                    const withdrawalUser = currentUserProfile.name;

                    // 3c. Write 2: Update all inventory items
                    for (const item of itemsWithDetails) {
                        const itemRef = doc(getInventoryCollection(), item.productId);
                        const currentStock = inventoryDocs.get(item.productId).data().stock;
                        const newStock = currentStock - item.quantity;
                        
                        transaction.update(itemRef, { 
                            stock: newStock,
                            lastWithdrawal: {
                                qty: item.quantity,
                                date: withdrawalTime,
                                user: withdrawalUser
                            }
                        });
                        
                        logPromises.push(logActivity("Item Withdrawn", {
                            requestId: requestId,
                            itemId: item.productId,
                            itemName: item.productName,
                            quantity: item.quantity,
                            newStock: newStock
                        }));
                    }
                    
                    // 3d. Write 3: Delete all request list items
                    for (const listDoc of listSnapshot.docs) {
                        transaction.delete(listDoc.ref);
                    }
                });
                // --- TRANSACTION END ---

                // --- POST-TRANSACTION SUCCESS ---
                // Log the main request
                logPromises.push(logActivity("Request Placed", { requestId: requestId, items: newRequestData.items.length }));
                // Log all item withdrawals
                await Promise.all(logPromises);
                
                showToast("Request submitted successfully!");
                
                lastRequestCache = { id: requestId, ...newRequestData }; // Save for summary page
                
                renderRequestSummaryPage(lastRequestCache, true); // true = just created
                document.getElementById('user-interface').classList.add('hidden'); // Hide user UI
                document.getElementById('request-summary-page').classList.remove('hidden'); // Show summary
                
                document.getElementById('summary-back-btn-container').innerHTML = `
                    <button id="summary-back-to-shop" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                        Back to Browse
                    </button>
                `;
                document.getElementById('summary-back-to-shop').onclick = () => {
                    document.getElementById('request-summary-page').classList.add('hidden');
                    document.getElementById('user-interface').classList.remove('hidden');
                    showUserPage('user-inventory-page');
                };
                
            } catch (error) {
                console.error("Request submission error: ", error);
                showToast(error.message || "Failed to submit request.", true);
            } finally {
                checkoutButton.disabled = false;
                checkoutButton.textContent = "Confirm Request";
            }
        }
        
        async function handleCopySummary() {
            if (!lastRequestCache) return;
            
            const { id, createdAt, supervisorName, userProfile, items } = lastRequestCache;
            
            let summaryText = `** STORE-SIGHT: Withdrawal Slip **\n\n`;
            summaryText += `Request ID: ${id}\n`;
            summaryText += `Date: ${new Date().toLocaleString()}\n`;
            summaryText += `Status: Pending\n\n`;
            
            summaryText += `**Requested By:**\n`;
            summaryText += `Name: ${userProfile.name}\n`;
            summaryText += `Employee ID: ${userProfile.empId}\n`;
            summaryText += `Designation: ${userProfile.designation}\n\n`;
            
            summaryText += `**Withdrawal Supervised By:**\n${supervisorName}\n\n`;
            
            summaryText += `**Items Requested (${items.length}):**\n`;
            summaryText += `---------------------------------\n`;
            
            items.forEach((item, index) => {
                const currentName = item.productName; // Use name from cart
                const itemCode = item.itemCode;
                
                summaryText += `${index + 1}. ${currentName} (${itemCode})\n`;
                summaryText += `   Qty: ${item.quantity}\n`;
                if (item.remarks) {
                    summaryText += `   Remarks: ${item.remarks}\n`;
                }
                summaryText += `\n`;
            });
            
            const textArea = document.createElement("textarea");
            textArea.value = summaryText;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("Summary copied to clipboard!");
            } catch (err) {
                showToast("Could not copy summary.", true);
            }
            document.body.removeChild(textArea);
        }

        // --- REGULAR USER: RENDER ---
        
        function renderProfilePage(isFirstTime = false) {
            const container = document.getElementById('user-profile-page');
            const setupContainer = document.getElementById('profile-setup-view');

            const targetContainer = isFirstTime ? setupContainer : container;
            if (!targetContainer) return;
            
            const title = isFirstTime ? "Welcome! Let's set up your profile." : "My Profile";
            const buttonText = isFirstTime ? "Save and Continue" : "Update Profile";
            
            const name = currentUserProfile?.name || '';
            const empId = currentUserProfile?.empId || '';
            const designation = currentUserProfile?.designation || '';
            const email = currentUserEmail || '';
            
            targetContainer.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl max-w-2xl mx-auto border">
                    <h2 class="text-3xl font-bold mb-5 text-red-800 border-b-2 border-red-100 pb-2">${title}</h2>
                    ${isFirstTime ? '<p class="text-gray-600 mb-6">Please complete your profile to continue. Your account will be pending approval from a manager.</p>' : ''}
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Login Email (Auto-generated)</label>
                            <input type="email" value="${email}" disabled class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-100 sm:text-sm">
                        </div>
                        <div>
                            <label for="profile-empId" class="block text-sm font-medium text-gray-700">Employee ID</label>
                            <input type="text" id="profile-empId" value="${empId}" disabled class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-100 sm:text-sm">
                        </div>
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="profile-name" value="${name}" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200">
                        </div>
                        <div>
                            <label for="profile-designation" class="block text-sm font-medium text-gray-700">Designation</label>
                            <input type="text" id="profile-designation" value="${designation}" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200">
                        </div>
                        
                        <button id="update-profile-btn" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('update-profile-btn').onclick = () => handleProfileUpdate(isFirstTime);
        }
        
        // --- NEW: RENDER USER INVENTORY (CARDS) ---
        function renderUserInventory(inventory) {
            const list = document.getElementById('user-inventory-list');
            if (!list) return;

            const categoryFilterEl = document.getElementById('user-category-filter');
            const searchFilterEl = document.getElementById('user-search-filter');
            
            const currentCategoryValue = categoryFilterEl ? categoryFilterEl.value : 'ALL';
            const selectedCategory = currentCategoryValue || 'ALL';
            const searchTerm = searchFilterEl ? searchFilterEl.value.toLowerCase() : '';

            const allVisibleItems = inventory.filter(item => !item.isHidden);
            const categories = ['ALL', ...new Set(allVisibleItems.map(item => item.category || 'Uncategorized'))];
            
            if (categoryFilterEl) {
                if (categoryFilterEl.options.length !== categories.length) {
                     categoryFilterEl.innerHTML = categories.sort().map(cat => 
                        `<option value="${cat}">${cat}</option>`
                     ).join('');
                }
                categoryFilterEl.value = selectedCategory;
            }

            const filteredAndVisibleInventory = allVisibleItems.filter(item => {
                const categoryMatch = (selectedCategory === 'ALL') || (item.category || 'Uncategorized') === selectedCategory;
                const searchMatch = item.name.toLowerCase().includes(searchTerm) || (item.itemCode || '').toLowerCase().includes(searchTerm);
                return categoryMatch && searchMatch;
            });
            
            list.innerHTML = '';
            if (filteredAndVisibleInventory.length === 0) {
                list.innerHTML = '<p class="text-gray-500 col-span-1 md:col-span-2 lg:col-span-3">No items match your filters.</p>';
                return;
            }

            filteredAndVisibleInventory.forEach(item => {
                const inStock = item.stock > 0;
                list.innerHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-md flex flex-col justify-between transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                        <div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-semibold px-2 py-0.5 bg-red-100 text-red-700 rounded-full">${item.category || 'Uncategorized'}</span>
                                <span class="text-sm font-medium text-gray-500">${item.itemCode || 'N/A'}</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mt-3">${item.name}</h3>
                            <p class="text-gray-600 mt-2">
                                ${inStock ? `Stock: <span class="font-bold text-2xl text-green-600">${item.stock}</span>` : '<span class="font-bold text-xl text-red-600">Out of Stock</span>'}
                            </p>
                        </div>
                        <button 
                            onclick="handleAddToRequest('${item.id}', '${item.name}', ${item.stock})" 
                            class="add-to-request-btn ${inStock ? 'inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2' : 'inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-gray-500 bg-gray-200 rounded-lg shadow-sm cursor-not-allowed'} text-sm mt-4 w-full"
                            ${!inStock ? 'disabled' : ''}
                        >
                            Add to List
                        </button>
                    </div>
                `;
            });
        }

        // --- NEW: RENDER USER REQUEST LIST (MODERN) ---
        function renderUserRequestList(requestList, inventory) { // Renamed
            const list = document.getElementById('request-items-list');
            const totalSpan = document.getElementById('request-total');
            const checkoutBtn = document.getElementById('go-to-checkout-btn');
            
            if (!list || !totalSpan || !checkoutBtn) return;
            
            list.innerHTML = '';
            let totalItems = 0;

            if (requestList.length === 0) {
                list.innerHTML = '<p class="text-gray-500">Your request list is empty.</p>';
                checkoutBtn.disabled = true;
                checkoutBtn.className = 'w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-gray-500 bg-gray-200 rounded-lg shadow-sm cursor-not-allowed';
            } else {
                requestList.forEach(item => {
                    totalItems += item.quantity;
                    const currentName = item.productName; // Use name from cart
                    
                    list.innerHTML += `
                        <div class="bg-white p-4 rounded-xl shadow-md flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">${currentName} <span class="text-sm font-normal text-gray-500">(${item.itemCode || 'N/A'})</span></h4>
                                <p class="text-sm text-gray-500">${item.category || 'Uncategorized'}</p>
                                <div class="flex items-center gap-2 mt-2">
                                    <button onclick="handleUpdateRequestQuantity('${item.id}', ${item.quantity - 1})" class="inline-flex items-center justify-center w-10 h-10 rounded-full transition-all duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300 w-8 h-8">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                                    </button>
                                    <span class="text-lg w-10 text-center font-bold">${item.quantity}</span>
                                    <button onclick="handleUpdateRequestQuantity('${item.id}', ${item.quantity + 1})" class="inline-flex items-center justify-center w-10 h-10 rounded-full transition-all duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300 w-8 h-8">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <button onclick="handleRemoveFromRequest('${item.id}')" class="inline-flex items-center justify-center w-10 h-10 rounded-full transition-all duration-200 text-red-500 hover:bg-red-100">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                });
                checkoutBtn.disabled = false;
                checkoutBtn.className = 'w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-green-600 to-green-700 rounded-lg shadow-md hover:shadow-lg hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2';
            }
            
            totalSpan.textContent = `${totalItems} items`;
        }
        
        function renderCheckoutPage() {
            const list = document.getElementById('checkout-items-list');
            list.innerHTML = '';
            document.getElementById('supervisor-name').value = '';
            
            if (localRequestCache.length === 0) {
                 list.innerHTML = '<p class="text-gray-500">Your list is empty. <a href="#" onclick="showUserPage(\'user-inventory-page\'); return false;" class="text-red-500 hover:underline">Browse items</a>.</p>';
                 document.getElementById('confirm-request-btn').disabled = true;
                 return;
            }
            
            document.getElementById('confirm-request-btn').disabled = false;
            localRequestCache.forEach(item => {
                const currentName = item.productName; // Use name from cart
                
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-md space-y-4" id="item-form-${item.id}">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">${currentName} (Qty: ${item.quantity})</h4>
                            <p class="text-sm text-gray-500">${item.category || 'Uncategorized'} (${item.itemCode || 'N/A'})</p>
                        </div>
                        <div>
                            <label for="remarks-${item.id}" class="block text-sm font-medium text-gray-700">Remarks:</label>
                            <input type="text" id="remarks-${item.id}" class="checkout-remarks-input mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200" placeholder="Optional">
                        </div>
                    </div>
                `;
            });
        }
        
        // --- NEW: RENDER REQUEST SUMMARY (MODERN) ---
        function renderRequestSummaryPage(request, justCreated) { // Renamed
            const list = document.getElementById('request-summary-details');
            const titleEl = document.getElementById('request-summary-title');
            if (!request || !titleEl) {
                list.innerHTML = '<p class="text-gray-600">Could not find request details.</p>';
                return;
            }
            
            if (justCreated) {
                titleEl.innerHTML = `
                <svg class="w-12 h-12 text-green-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Request Placed Successfully!
                `;
                titleEl.className = 'text-3xl font-bold mb-4 text-green-600 text-center';
            } else {
                titleEl.textContent = ''; // Title is now on the slip itself
                titleEl.className = '';
            }
            
            document.getElementById('copy-summary-btn').classList.toggle('hidden', !justCreated);
            const requestDate = request.createdAt?.toDate ? request.createdAt.toDate().toLocaleString() : 'Just now';
            const requestStatus = request.status || 'pending';
            
            let statusBadge = '';
            switch (requestStatus) {
                case 'pending': statusBadge = '<span class="text-sm font-medium px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full">Pending</span>'; break;
                case 'verified': statusBadge = '<span class="text-sm font-medium px-3 py-1 bg-green-100 text-green-800 rounded-full">Verified</span>'; break;
                case 'unauthorized': statusBadge = '<span class="text-sm font-medium px-3 py-1 bg-red-100 text-red-800 rounded-full">Unauthorized</span>'; break;
                default: statusBadge = `<span class="text-sm font-medium px-3 py-1 bg-gray-100 text-gray-800 rounded-full">${requestStatus}</span>`;
            }

            let itemsHtml = '';
            request.items.forEach((item, index) => {
                const currentName = item.productName;
                
                itemsHtml += `
                    <tr class="border-b">
                        <td class="p-3">${index + 1}</td>
                        <td class="p-3">${currentName} (${item.itemCode})</td>
                        <td class="p-3 text-center">${item.quantity}</td>
                        <td class="p-3">${item.remarks || 'N/A'}</td>
                    </tr>
                `;
            });
            
            list.innerHTML = `
                <div class="space-y-4 text-sm text-gray-800">
                    <div class="flex justify-between items-center">
                        <div>
                            <p><strong>Request ID:</strong></p>
                            <p class="font-mono">${request.id}</p>
                        </div>
                        ${statusBadge}
                    </div>
                    <p><strong>Date:</strong> ${requestDate}</p>
                    <hr>
                    <p><strong>Requested By:</strong></p>
                    <div class="pl-4">
                        <p>${request.userProfile.name}</p>
                        <p>ID: ${request.userProfile.empId}</p>
                        <p>Designation: ${request.userProfile.designation}</p>
                    </div>
                    <hr>
                    <p><strong>Supervised By:</strong></p>
                    <div class="pl-4">
                        <p>${request.supervisorName}</p>
                    </div>
                    <hr>
                    <p><strong>Items (${request.items.length}):</strong></p>
                    <table class="w-full border-collapse border mt-2 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 border text-left">#</th>
                                <th class="p-3 border text-left">Item (Code)</th>
                                <th class="p-3 border text-center">Qty</th>
                                <th class="p-3 border text-left">Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    
                    <!-- NEW: Verification Buttons -->
                    <div id="request-verification-actions" class="mt-6 pt-6 border-t ${request.status !== 'pending' ? 'hidden' : ''}">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Manager Actions</h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="handleApproveRequest('${request.id}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg shadow-md hover:shadow-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 flex-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                Verify & Approve
                            </button>
                            <button onclick="handleUnauthorizedRequest('${request.id}', '${request.userId}', '${request.userProfile.name}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-600 rounded-lg shadow-md hover:shadow-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 flex-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                                Mark as Unauthorized
                            </button>
                        </div>
                    </div>

                </div>
            `;
        }
        
        // --- NEW: RENDER USER REQUESTS (CARDS) ---
        function renderUserRequests(requests) { // Renamed
            const list = document.getElementById('user-requests-list');
            if (!list) return;
            list.innerHTML = '';
            
            if (requests.length === 0) {
                list.innerHTML = '<p class="text-gray-500 col-span-1 md:col-span-2">You have not placed any requests yet.</p>';
                return;
            }
            
            requests.forEach(request => {
                const totalItems = request.items.reduce((sum, item) => sum + item.quantity, 0);
                const requestDate = request.createdAt?.toDate ? request.createdAt.toDate().toLocaleDateString() : 'Pending';
                
                let statusBadge = '';
                switch (request.status) {
                    case 'pending': statusBadge = '<span class="text-xs font-medium px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded-full">Pending</span>'; break;
                    case 'verified': statusBadge = '<span class="text-xs font-medium px-2 py-0.5 bg-green-100 text-green-800 rounded-full">Verified</span>'; break;
                    case 'unauthorized': statusBadge = '<span class="text-xs font-medium px-2 py-0.5 bg-red-100 text-red-800 rounded-full">Unauthorized</span>'; break;
                    default: statusBadge = `<span class="text-xs font-medium px-2 py-0.5 bg-gray-100 text-gray-800 rounded-full">${request.status || 'Unknown'}</span>`;
                }

                list.innerHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-md flex justify-between items-center transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-800 font-mono">ID: ${request.id.substring(0, 8)}...</span>
                                ${statusBadge}
                            </div>
                            <p class="text-gray-600 mt-2">Date: ${requestDate}</p>
                            <p class="text-gray-600">Total Items: <span class="font-bold text-lg text-gray-800">${totalItems}</span></p>
                        </div>
                        <button onclick="viewRequestDetails('${request.id}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 text-sm">
                            View
                        </button>
                    </div>
                `;
            });
            
            window.viewRequestDetails = async (requestId) => {
                const requestRef = doc(getRequestsCollection(), requestId);
                const requestDoc = await getDoc(requestRef);
                if (requestDoc.exists()) {
                    lastRequestCache = { id: requestDoc.id, ...requestDoc.data() };
                    renderRequestSummaryPage(lastRequestCache, false); // false = not just created
                    
                    document.getElementById('user-interface').classList.add('hidden');
                    document.getElementById('request-summary-page').classList.remove('hidden');
                    
                    document.getElementById('summary-back-btn-container').innerHTML = `
                        <button id="summary-back-to-user" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                            Back to My Requests
                        </button>
                    `;
                    document.getElementById('summary-back-to-user').onclick = () => {
                        document.getElementById('request-summary-page').classList.add('hidden');
                        document.getElementById('user-interface').classList.remove('hidden');
                        showUserPage('user-requests-page');
                    };
                    
                } else {
                    showToast("Request not found.", true);
                }
            };
        }

        // --- 6. MANAGER: ACTIONS & RENDERING ---
        
        // --- NEW: RENDER DASHBOARD (MODERN) ---
        function renderDashboard() {
            const kpiPending = document.getElementById('kpi-pending-users');
            const kpiLowStock = document.getElementById('kpi-low-stock');
            const kpiTotalItems = document.getElementById('kpi-total-items');
            
            if (!kpiPending || !kpiLowStock || !kpiTotalItems) return;
            
            // 1. Render KPIs from cache
            const pendingUsers = userRolesCache.filter(user => user.status === 'pending').length;
            const lowStockItems = inventoryCache.filter(item => item.stock <= item.lowStockThreshold && !item.isHidden).length; // Don't count hidden low stock
            const totalItems = inventoryCache.length;
            
            kpiPending.textContent = pendingUsers;
            kpiLowStock.textContent = lowStockItems;
            kpiTotalItems.textContent = totalItems;
            kpiPending.classList.toggle('text-red-500', pendingUsers > 0);
            kpiLowStock.classList.toggle('text-red-500', lowStockItems > 0);
            
            // --- NEW: Render Dashboard Alerts ---
            renderDashboardAlerts();
            
            // 3. Render Low Stock List
            const lowStockList = document.getElementById('dashboard-low-stock-list');
            const lowStockItemsToShow = inventoryCache.filter(item => item.stock <= item.lowStockThreshold && !item.isHidden).slice(0, 5); // Don't show hidden
            lowStockList.innerHTML = '';
            if (lowStockItemsToShow.length === 0) {
                lowStockList.innerHTML = '<p class="text-sm text-gray-500">All stock levels look good!</p>';
            } else {
                lowStockItemsToShow.forEach(item => {
                    lowStockList.innerHTML += `
                        <div class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-100">
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm font-bold text-red-600">Stock: ${item.stock}</p>
                            </div>
                            <button onclick="handleOpenAddStockModal('${item.id}', '${item.name}', ${item.stock})" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 bg-red-500 hover:bg-red-600 text-sm py-1 px-3">
                                Add Stock
                            </button>
                        </div>
                    `;
                });
            }
        }
        
        // --- NEW: RENDER DASHBOARD ALERTS (MODERN) ---
        function renderDashboardAlerts() {
            const list = document.getElementById('dashboard-alerts-list');
            if (!list) return;
            list.innerHTML = '';
            
            let alertsHtml = '';
            
            // 1. Pending Users
            const pendingUsers = userRolesCache.filter(user => user.status === 'pending');
            pendingUsers.forEach(user => {
                alertsHtml += `
                    <div class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between gap-3 transition-all duration-300 hover:shadow-lg">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            </span>
                            <div>
                                <h4 class="font-semibold text-gray-800">Pending User</h4>
                                <p class="text-sm text-gray-600">${user.name || user.email}</p>
                            </div>
                        </div>
                        <button onclick="handleViewAlert('user-mgt-tab')" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 text-sm py-1 px-3">View</button>
                    </div>
                `;
            });

            // 2. Pending Requests
            const pendingRequests = managerRequestsCache.filter(req => req.status === 'pending');
             pendingRequests.forEach(req => {
                alertsHtml += `
                    <div class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between gap-3 transition-all duration-300 hover:shadow-lg">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            </span>
                            <div>
                                <h4 class="font-semibold text-gray-800">New Request</h4>
                                <p class="text-sm text-gray-600">${req.userProfile?.name || 'Unknown'} - ${req.items.length} items</p>
                            </div>
                        </div>
                        <button onclick="handleViewAlert('manager-requests-tab')" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 text-sm py-1 px-3">View</button>
                    </div>
                `;
            });
            
            // 3. New Feedback
            feedbackCache.forEach(fb => {
                alertsHtml += `
                    <div class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between gap-3 transition-all duration-300 hover:shadow-lg">
                        <div class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                            </span>
                            <div>
                                <h4 class="font-semibold text-gray-800">New Feedback</h4>
                                <p class="text-sm text-gray-600">${fb.user?.name || 'Guest'} - (${fb.type})</p>
                            </div>
                        </div>
                        <button onclick="handleDismissFeedback('${fb.id}')" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 text-sm py-1 px-3">Dismiss</button>
                    </div>
                `;
            });

            if (alertsHtml === '') {
                list.innerHTML = '<p class="text-sm text-gray-500">No new alerts.</p>';
            } else {
                list.innerHTML = alertsHtml;
            }
            
            window.handleViewAlert = (tabName) => showManagerTab(tabName);
        }
        
        function renderDashboardRecentActivity(logDocs) {
            const list = document.getElementById('dashboard-recent-activity');
            if (!list) return;
            list.innerHTML = '';
            if (logDocs.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500">No recent activity.</p>';
                return;
            }
            logDocs.forEach(doc => {
                const log = doc.data();
                const time = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : 'Just now';
                list.innerHTML += `
                    <div class="p-3 border-b border-gray-200">
                        <p class="font-semibold text-gray-800 text-sm">${log.action}</p>
                        <p class="text-xs text-gray-600">By: ${log.user} | ${time}</p>
                    </div>
                `;
            });
        }

        // --- NEW: RENDER MANAGER INVENTORY (CARDS) ---
        function renderManagerInventory(inventory) {
            const list = document.getElementById('manager-inventory-list');
            if (!list) return;

            const categoryFilterEl = document.getElementById('manager-category-filter');
            const searchFilterEl = document.getElementById('manager-search-filter');
            
            const currentCategoryValue = categoryFilterEl ? categoryFilterEl.value : 'ALL';
            const selectedCategory = currentCategoryValue || 'ALL';
            const searchTerm = searchFilterEl ? searchFilterEl.value.toLowerCase() : '';

            const categories = ['ALL', ...new Set(inventory.map(item => item.category || 'Uncategorized'))];
            
            if (categoryFilterEl) {
                if (categoryFilterEl.options.length !== categories.length) {
                     categoryFilterEl.innerHTML = categories.sort().map(cat => 
                        `<option value="${cat}">${cat}</option>`
                     ).join('');
                }
                categoryFilterEl.value = selectedCategory;
            }

            const filteredInventory = inventory.filter(item => {
                const categoryMatch = (selectedCategory === 'ALL') || (item.category || 'Uncategorized') === selectedCategory;
                const searchMatch = item.name.toLowerCase().includes(searchTerm) || (item.itemCode || '').toLowerCase().includes(searchTerm);
                return categoryMatch && searchMatch;
            });

            list.innerHTML = '';
            
            if (filteredInventory.length === 0) {
                list.innerHTML = '<p class="text-gray-500 col-span-1 md:col-span-2">No items match your filters.</p>';
                return;
            }

            // 1. Group by category
            const categoryGroups = filteredInventory.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            // 2. Get sorted category names
            const sortedCategories = Object.keys(categoryGroups).sort();
            let html = '';

            // 3. Render by category
            for (const categoryName of sortedCategories) {
                const items = categoryGroups[categoryName];
                
                const allHidden = items.every(item => item.isHidden);
                
                html += `
                    <div class="mb-8 col-span-1 md:col-span-2">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center bg-gray-100 p-4 rounded-xl mb-4 gap-3">
                            <h3 class="text-2xl font-bold text-gray-700">${categoryName}</h3>
                            <button onclick="handleToggleCategory('${categoryName}', ${!allHidden})" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 text-sm py-2 px-3 ${allHidden ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${allHidden ? 'Show Category' : 'Hide Category'}
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                `;
                
                // 4. Render the new card for each item
                items.forEach(item => {
                    const isHidden = item.isHidden || false;
                    const isLowStock = item.stock <= item.lowStockThreshold;
                    
                    html += `
                        <div class="bg-white p-5 rounded-xl shadow-md transition-all duration-300 hover:shadow-lg ${isHidden ? 'opacity-60 bg-gray-50' : ''}">
                            <!-- Top row: Name and Edit Button -->
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${item.name} ${isHidden ? '<span class="text-sm font-medium text-red-600">(Hidden)</span>' : ''}</h3>
                                    <p class="text-sm text-gray-500">${item.category} | <span class="font-mono">${item.itemCode || 'N/A'}</span></p>
                                    <p class="text-xs text-gray-500 mt-1">Threshold: ${item.lowStockThreshold}</p>
                                </div>
                                <button onclick="handleOpenEditModal('${item.id}')" class="inline-flex items-center justify-center w-10 h-10 rounded-full transition-all duration-200 text-gray-500 hover:bg-gray-100">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                            </div>
                            
                            <p class="font-extrabold text-4xl ${isLowStock ? 'text-red-600' : 'text-gray-800'} mb-4">${item.stock}</p>
                            
                            <!-- Bottom row: Add/Remove Stock -->
                            <div class="flex items-center gap-2">
                                <input type="number" id="add-stock-qty-${item.id}" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 w-24" placeholder="Qty">
                                <button onclick="handleQuickAddStock('${item.id}', ${item.stock})" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 py-2 px-3 text-sm">
                                    Add
                                </button>
                                <button onclick="handleOpenRemoveStockModal('${item.id}', '${item.name}', ${item.stock})" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-600 rounded-lg shadow-md hover:shadow-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 py-2 px-3 text-sm">
                                    Remove
                                </button>
                                <button onclick="handleViewItemHistory('${item.id}', '${item.name}')" title="View History" class="inline-flex items-center justify-center w-10 h-10 rounded-full transition-all duration-200 bg-gray-200 text-gray-800 hover:bg-gray-300 ml-auto">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`; // Close grid and category div
            }
            
            list.innerHTML = html; // Set the concatenated HTML
        }
        
        // --- NEW: RENDER USER ROLES (CARDS) ---
        function renderUserRoles(users) {
            const list = document.getElementById('user-roles-list');
            if (!list) return;
            list.innerHTML = '';
            
            users.forEach(user => {
                const isCurrentUser = user.id === currentUserId;
                let statusBadge = '';
                switch (user.status) {
                    case 'active': statusBadge = '<span class="text-xs font-medium px-2 py-1 bg-green-100 text-green-800 rounded-full">Active</span>'; break;
                    case 'pending': statusBadge = '<span class="text-xs font-medium px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">Pending</span>'; break;
                    case 'suspended': statusBadge = '<span class="text-xs font-medium px-2 py-1 bg-red-100 text-red-800 rounded-full">Suspended</span>'; break;
                    default: statusBadge = `<span class="text-xs font-medium px-2 py-1 bg-gray-100 text-gray-800 rounded-full">${user.status || 'Unknown'}</span>`;
                }
                
                let canDelete = false;
                if (currentUserRole === 'superuser' && !isCurrentUser) {
                    canDelete = true;
                } else if (currentUserRole === 'manager' && user.role === 'user' && !isCurrentUser) {
                    canDelete = true;
                }
                
                let canChangeRole = false;
                if (currentUserRole === 'superuser' && !isCurrentUser) {
                    canChangeRole = true;
                } else if (currentUserRole === 'manager' && user.role === 'user' && !isCurrentUser) {
                    canChangeRole = true;
                }

                list.innerHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-md transition-all duration-300 hover:shadow-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-800">${user.name || 'Profile Not Setup'}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${user.email || 'N/A'}</p>
                        <p class="text-sm text-gray-500">${user.designation || 'N/A'}</p>
                        <p class="text-xs text-gray-500 break-all mt-2 font-mono">ID: ${user.userId}</p>
                        
                        <hr class="my-4">
                        
                        <div class="flex flex-wrap items-center gap-2">
                            ${user.status === 'pending' ? `
                                <button onclick="handleApproveUser('${user.id}', '${user.name}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 bg-green-600 hover:bg-green-700 text-sm py-1 px-3">
                                    Approve
                                </button>
                            ` : ''}
                            ${user.status === 'active' && !isCurrentUser && user.role === 'user' ? `
                                <button onclick="handleSuspendUser('${user.id}', '${user.name}', true)" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 bg-yellow-500 hover:bg-yellow-600 text-sm py-1 px-3">
                                    Suspend
                                </button>
                            ` : ''}
                             ${user.status === 'suspended' && !isCurrentUser ? `
                                <button onclick="handleApproveUser('${user.id}', '${user.name}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 bg-green-600 hover:bg-green-700 text-sm py-1 px-3">
                                    Re-activate
                                </button>
                            ` : ''}
                            <select id="role-${user.id}" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 text-sm py-1" ${!canChangeRole ? 'disabled' : ''}>
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                                ${currentUserRole === 'superuser' ? `<option value="superuser" ${user.role === 'superuser' ? 'selected' : ''}>Superuser</option>` : ''}
                            </select>
                            <button onclick="handleUpdateUserRole('${user.id}')" 
                                class="${!canChangeRole ? 'inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-gray-500 bg-gray-200 rounded-lg shadow-sm cursor-not-allowed' : 'inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2'} text-sm py-1 px-3"
                                ${!canChangeRole ? 'disabled' : ''}>
                                Set Role
                            </button>
                            ${canDelete ? `
                                <button onclick="handleDeleteUser('${user.id}', '${user.email}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-600 rounded-lg shadow-md hover:shadow-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 text-sm py-1 px-3 ml-auto">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        // --- NEW: RENDER MANAGER REQUESTS (CARDS) ---
        function renderManagerRequests(requests) { // Renamed
            const list = document.getElementById('manager-requests-list');
            if (!list) return;
            list.innerHTML = '';
            
            if (requests.length === 0) {
                list.innerHTML = '<p class="text-gray-500 col-span-1 md:col-span-2">No requests have been placed yet.</p>';
                return;
            }
            
            requests.forEach(request => {
                const totalItems = request.items.reduce((sum, item) => sum + item.quantity, 0);
                const requestDate = request.createdAt?.toDate ? request.createdAt.toLocaleString() : 'Pending';
                
                let superuserButton = '';
                if (currentUserRole === 'superuser') {
                    superuserButton = `<button onclick="handleDeleteRequest('${request.id}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-600 rounded-lg shadow-md hover:shadow-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 text-sm py-1 px-3">Delete</button>`;
                }
                
                let statusBadge = '';
                switch (request.status) {
                    case 'pending': statusBadge = '<span class="text-xs font-medium px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded-full">Pending</span>'; break;
                    case 'verified': statusBadge = '<span class="text-xs font-medium px-2 py-0.5 bg-green-100 text-green-800 rounded-full">Verified</span>'; break;
                    case 'unauthorized': statusBadge = '<span class="text-xs font-medium px-2 py-0.5 bg-red-100 text-red-800 rounded-full">Unauthorized</span>'; break;
                    default: statusBadge = `<span class="text-xs font-medium px-2 py-0.5 bg-gray-100 text-gray-800 rounded-full">${request.status || 'Unknown'}</span>`;
                }

                list.innerHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-md transition-all duration-300 hover:shadow-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-800">${request.userProfile?.name || 'Unknown User'}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-gray-600 text-sm mt-1">${requestDate}</p>
                        <p class="text-gray-500 text-sm font-mono">ID: ${request.id.substring(0, 8)}...</p>
                        <p class="text-gray-600 mt-2">Total Items: <span class="font-bold text-lg text-gray-800">${totalItems}</span></p>
                        
                        <hr class="my-4">
                        
                        <div class="flex justify-between items-center">
                            ${superuserButton}
                            <button onclick="viewManagerRequestDetails('${request.id}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 text-sm ml-auto">
                                View
                            </button>
                        </div>
                    </div>
                `;
            });
            
            window.viewManagerRequestDetails = async (requestId) => {
                const requestRef = doc(getRequestsCollection(), requestId);
                const requestDoc = await getDoc(requestRef);
                if (requestDoc.exists()) {
                    lastRequestCache = { id: requestDoc.id, ...requestDoc.data() };
                    renderRequestSummaryPage(lastRequestCache, false); // false = not just created
                    
                    document.getElementById('manager-interface').classList.add('hidden');
                    document.getElementById('request-summary-page').classList.remove('hidden');
                    
                    document.getElementById('summary-back-btn-container').innerHTML = `
                        <button id="summary-back-to-manager" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                            Back to All Requests
                        </button>
                    `;
                    document.getElementById('summary-back-to-manager').onclick = () => {
                        document.getElementById('request-summary-page').classList.add('hidden');
                        document.getElementById('manager-interface').classList.remove('hidden');
                        showManagerTab('manager-requests-tab');
                    };
                    
                } else {
                    showToast("Request not found.", true);
                }
            };
        }
        
        // --- NEW: RENDER ACTIVITY LOG (MODERN) ---
        function renderActivityLog(logs) {
            const list = document.getElementById('activity-log-list');
            if (!list) return;
            list.innerHTML = '';
            if (logs.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No activities logged yet.</p>';
                return;
            }
            
            logs.forEach(log => {
                const time = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : 'Just now';
                
                let superuserButton = '';
                if (currentUserRole === 'superuser') {
                    superuserButton = `<button onclick="handleDeleteLog('${log.id}')" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-600 rounded-lg shadow-md hover:shadow-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 text-xs py-1 px-2">Delete</button>`;
                }
                
                list.innerHTML += `
                    <div class="p-4 bg-white rounded-xl shadow-md font-mono text-sm">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-2">
                            <div>
                                <p class="font-semibold text-gray-800">${log.action}</p>
                                <p class="text-gray-600">By: <span class="font-medium">${log.user}</span></p>
                                <p class="text-gray-600">When: ${time}</p>
                                <details class="mt-2 text-xs">
                                    <summary class="cursor-pointer text-gray-500 hover:text-gray-800">Details</summary>
                                    <pre class="mt-2 p-3 bg-gray-100 rounded-lg overflow-auto">${JSON.stringify(log.details, null, 2)}</pre>
                                </details>
                            </div>
                            ${superuserButton}
                        </div>
                    </div>
                `;
            });
        }
        
        // --- MANAGER: ACTIONS ---
        async function handleAddInventoryItem() {
            const name = document.getElementById('item-name').value.trim();
            const itemCode = document.getElementById('item-code').value.trim();
            const category = document.getElementById('item-category').value.trim();
            const stock = parseInt(document.getElementById('item-stock').value, 10);
            const lowStock = parseInt(document.getElementById('item-low-stock').value, 10);
            
            if (!name || !itemCode || !category || isNaN(stock) || isNaN(lowStock)) {
                showToast("Please fill in all fields correctly.", true);
                return;
            }
            
            const existingItem = inventoryCache.find(item => item.itemCode === itemCode);
            if (existingItem) {
                showToast("An item with this Item Code already exists.", true);
                return;
            }
            
            try {
                const itemData = {
                    name: name,
                    itemCode: itemCode,
                    category: category,
                    stock: stock,
                    lowStockThreshold: lowStock,
                    isHidden: false,
                    addedAt: serverTimestamp(),
                    lastAddition: {
                        qty: stock,
                        date: serverTimestamp(),
                        user: currentUserProfile.name
                    },
                    lastWithdrawal: {
                        qty: 0,
                        date: null,
                        user: null
                    }
                };
                
                const itemRef = await addDoc(getInventoryCollection(), itemData);
                await logActivity("Inventory Item Added", { itemId: itemRef.id, ...itemData });
                
                showToast("Item added to inventory.");
                document.getElementById('item-name').value = '';
                document.getElementById('item-code').value = '';
                document.getElementById('item-category').value = '';
                document.getElementById('item-stock').value = '10';
                document.getElementById('item-low-stock').value = '5';
                // --- NEW: Collapse card after adding ---
                document.getElementById('add-item-card').classList.add('hidden');
                document.getElementById('add-item-button').classList.remove('hidden');
            } catch (error) {
                console.error("Add item error: ", error);
                showToast("Failed to add item.", true);
            }
        }
        
        function handleOpenEditModal(itemId) {
            const item = inventoryCache.find(i => i.id === itemId);
            if (!item) return;
            
            // --- FIX: Store item details for delete button ---
            lastRequestCache = item; // Re-using this global var
            
            document.getElementById('item-details-title').textContent = `Edit: ${item.name}`;
            document.getElementById('modal-detail-item-name').value = item.name;
            document.getElementById('modal-detail-item-code').value = item.itemCode;
            document.getElementById('modal-detail-item-category').value = item.category;
            document.getElementById('modal-detail-item-threshold').value = item.lowStockThreshold;
            document.getElementById('modal-detail-item-hidden').checked = item.isHidden || false;
            
            const confirmBtn = document.getElementById('modal-detail-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => handleConfirmEditItemDetails(itemId);
            
            document.getElementById('item-details-modal').classList.remove('hidden');
        }
        
        function closeEditItemDetailsModal() {
            document.getElementById('item-details-modal').classList.add('hidden');
        }
        
        async function handleConfirmEditItemDetails(itemId) {
            const newName = document.getElementById('modal-detail-item-name').value.trim();
            const newItemCode = document.getElementById('modal-detail-item-code').value.trim();
            const newCategory = document.getElementById('modal-detail-item-category').value.trim();
            const newThreshold = parseInt(document.getElementById('modal-detail-item-threshold').value, 10);
            const isHidden = document.getElementById('modal-detail-item-hidden').checked;
            
            if (!newName || !newItemCode || !newCategory || isNaN(newThreshold)) {
                showToast("All fields are required.", true);
                return;
            }
            
            const existingItem = inventoryCache.find(item => item.itemCode === newItemCode && item.id !== itemId);
            if (existingItem) {
                showToast("An item with this Item Code already exists.", true);
                return;
            }
            
            const itemRef = doc(getInventoryCollection(), itemId);
            const oldItem = inventoryCache.find(i => i.id === itemId);
            
            try {
                const updateData = { 
                    name: newName,
                    itemCode: newItemCode,
                    category: newCategory,
                    lowStockThreshold: newThreshold,
                    isHidden: isHidden
                };
                
                await updateDoc(itemRef, updateData);
                await logActivity("Inventory Item Details Updated", { 
                    itemId: itemId, 
                    oldDetails: {
                        name: oldItem.name,
                        itemCode: oldItem.itemCode,
                        category: oldItem.category,
                        threshold: oldItem.lowStockThreshold,
                        hidden: oldItem.isHidden
                    },
                    newDetails: updateData
                });
                showToast("Item details updated.");
                closeEditItemDetailsModal();
            } catch (error) {
                console.error("Update item details error: ", error);
                showToast("Failed to update item details.", true);
            }
        }
        
        async function handleQuickAddStock(itemId, currentStock) {
            const qtyInput = document.getElementById(`add-stock-qty-${itemId}`);
            if (!qtyInput) return;
            
            const qtyToAdd = parseInt(qtyInput.value, 10);
            
            if (isNaN(qtyToAdd) || qtyToAdd <= 0) {
                showToast("Please enter a valid quantity to add.", true);
                return;
            }
            
            const newStock = currentStock + qtyToAdd;
            const itemRef = doc(getInventoryCollection(), itemId);
            
            try {
                await updateDoc(itemRef, {
                    stock: newStock,
                    lastAddition: {
                        qty: qtyToAdd,
                        date: serverTimestamp(),
                        user: currentUserProfile.name
                    }
                });
                await logActivity("Stock Added", { itemId: itemId, added: qtyToAdd, newStock: newStock });
                showToast("Stock added successfully.");
                qtyInput.value = ''; // Clear input
            } catch (error) {
                console.error("Add stock error: ", error);
                showToast("Failed to add stock.", true);
            }
        }
        
        async function handleToggleCategory(categoryName, shouldHide) {
            const action = shouldHide ? "Hide" : "Show";
            showConfirmationModal(
                `${action} Category?`,
                `This will ${action.toLowerCase()} all items in the "${categoryName}" category from the public inventory.`,
                async () => {
                    const batch = writeBatch(db);
                    const itemsToUpdate = inventoryCache.filter(item => item.category === categoryName);
                    
                    if (itemsToUpdate.length === 0) {
                        showToast("No items found for this category.", true);
                        return;
                    }
                    
                    itemsToUpdate.forEach(item => {
                        const itemRef = doc(getInventoryCollection(), item.id);
                        batch.update(itemRef, { isHidden: shouldHide });
                    });
                    
                    try {
                        await batch.commit();
                        await logActivity("Category Toggled", { category: categoryName, action: action });
                        showToast(`Category "${categoryName}" is now ${shouldHide ? 'hidden' : 'visible'}.`);
                    } catch (error) {
                        console.error("Category toggle error:", error);
                        showToast("Failed to update category.", true);
                    }
                }
            );
        }
        
        function handleOpenAddStockModal(itemId, itemName, currentStock) {
            document.getElementById('modal-stock-item-name').textContent = itemName;
            document.getElementById('modal-stock-current').textContent = currentStock;
            document.getElementById('modal-stock-add-qty').value = '';
            
            const confirmBtn = document.getElementById('modal-stock-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => handleConfirmAddStock(itemId, currentStock);
            
            document.getElementById('add-stock-modal').classList.remove('hidden');
        }
        
        function closeAddStockModal() {
            document.getElementById('add-stock-modal').classList.add('hidden');
        }
        
        async function handleConfirmAddStock(itemId, currentStock) {
            const qtyToAdd = parseInt(document.getElementById('modal-stock-add-qty').value, 10);
            if (isNaN(qtyToAdd) || qtyToAdd <= 0) {
                showToast("Please enter a valid quantity to add.", true);
                return;
            }
            
            const newStock = currentStock + qtyToAdd;
            const itemRef = doc(getInventoryCollection(), itemId);
            
            try {
                await updateDoc(itemRef, {
                    stock: newStock,
                    lastAddition: {
                        qty: qtyToAdd,
                        date: serverTimestamp(),
                        user: currentUserProfile.name
                    }
                });
                await logActivity("Stock Added", { itemId: itemId, added: qtyToAdd, newStock: newStock });
                showToast("Stock added successfully.");
                closeAddStockModal();
            } catch (error) {
                console.error("Add stock error: ", error);
                showToast("Failed to add stock.", true);
            }
        }
        
        // --- NEW: Remove Stock Modal ---
        function handleOpenRemoveStockModal(itemId, itemName, currentStock) {
            document.getElementById('modal-remove-item-name').textContent = itemName;
            document.getElementById('modal-remove-current').textContent = currentStock;
            document.getElementById('modal-remove-qty').value = '';
            document.getElementById('modal-remove-reason').value = '';
            
            const confirmBtn = document.getElementById('modal-remove-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => handleConfirmRemoveStock(itemId, currentStock);
            
            document.getElementById('remove-stock-modal').classList.remove('hidden');
        }
        
        function closeRemoveStockModal() {
            document.getElementById('remove-stock-modal').classList.add('hidden');
        }
        
        async function handleConfirmRemoveStock(itemId, currentStock) {
            const qtyToRemove = parseInt(document.getElementById('modal-remove-qty').value, 10);
            const reason = document.getElementById('modal-remove-reason').value.trim();

            if (isNaN(qtyToRemove) || qtyToRemove <= 0) {
                showToast("Please enter a valid quantity to remove.", true);
                return;
            }
            if (!reason) {
                showToast("A reason is required for stock removal.", true);
                return;
            }
            
            const newStock = currentStock - qtyToRemove;
            if (newStock < 0) {
                showToast("Cannot remove more than available stock.", true);
                return;
            }
            
            const itemRef = doc(getInventoryCollection(), itemId);
            
            try {
                await updateDoc(itemRef, {
                    stock: newStock,
                    lastWithdrawal: { // Use lastWithdrawal for this, but log it differently
                        qty: qtyToRemove,
                        date: serverTimestamp(),
                        user: `${currentUserProfile.name} (Adjustment)`
                    }
                });
                await logActivity("Stock Removed (Adjustment)", { itemId: itemId, removed: qtyToRemove, newStock: newStock, reason: reason });
                showToast("Stock removed successfully.");
                closeRemoveStockModal();
            } catch (error) {
                console.error("Remove stock error: ", error);
                showToast("Failed to remove stock.", true);
            }
        }
        
        async function handleViewItemHistory(itemId, itemName) {
            const modal = document.getElementById('item-history-modal');
            const title = document.getElementById('item-history-title');
            const list = document.getElementById('item-history-list');
            
            title.textContent = `History for: ${itemName}`;
            list.innerHTML = '<p>Loading history...</p>';
            modal.classList.remove('hidden');
            
            try {
                const logQuery = query(
                    getActivityLogCollection(), 
                    where("details.itemId", "==", itemId),
                    orderBy('timestamp', 'desc')
                );
                const snapshot = await getDocs(logQuery);
                
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500">No history found for this item.</p>';
                    return;
                }
                
                list.innerHTML = ''; // Clear loading
                snapshot.docs.forEach(doc => {
                    const log = doc.data();
                    const time = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : 'Just now';
                    
                    let detailsText = log.action;
                    let detailsColor = 'text-gray-800';
                    
                    if (log.action === 'Stock Added') {
                        detailsText = `+${log.details.added} (New Stock: ${log.details.newStock})`;
                        detailsColor = 'text-green-700';
                    } else if (log.action === 'Item Withdrawn') {
                        detailsText = `-${log.details.quantity} (New Stock: ${log.details.newStock}) | Req: ${log.details.requestId.substring(0, 5)}...`;
                        detailsColor = 'text-red-700';
                    } else if (log.action === 'Stock Removed (Adjustment)') {
                        detailsText = `-${log.details.removed} (New Stock: ${log.details.newStock}) | Reason: ${log.details.reason}`;
                        detailsColor = 'text-red-700 font-semibold';
                    } else if (log.action === 'Inventory Item Details Updated') {
                        detailsText = `Details updated (Code: ${log.details.newDetails.itemCode})`;
                    } else if (log.action === 'Inventory Item Added') {
                        detailsText = `Item created (Code: ${log.details.itemCode})`;
                    }
                    
                    // Only show logs relevant to this item
                    if (log.action.includes('Stock') || log.action.includes('Item')) {
                        list.innerHTML += `
                            <div class="p-3 bg-gray-100 rounded-lg font-mono text-sm">
                                <p><strong>${time}</strong></p>
                                <p>By: ${log.user}</p>
                                <p class="${detailsColor}">Action: ${detailsText}</p>
                            </div>
                        `;
                    }
                });
                
            } catch (error) {
                console.error("Error fetching item history:", error);
                list.innerHTML = `<p class="text-red-600 font-medium">Could not load history. The database may be missing a required index. Please contact your administrator.</p>`;
            }
        }
        
        async function handleApproveUser(userId, name) {
            const userRef = doc(getUserRolesCollection(), userId);
            try {
                await updateDoc(userRef, { status: 'active' });
                await logActivity("User Approved", { approvedUserId: userId, name: name });
                showToast("User approved successfully.");
            } catch (error) {
                console.error("Approve user error:", error);
                showToast("Failed to approve user.", true);
            }
        }
        
        async function handleSuspendUser(userId, name, shouldSuspend) {
            const newStatus = shouldSuspend ? 'suspended' : 'active';
            const action = shouldSuspend ? 'User Suspended' : 'User Re-activated';
            const userRef = doc(getUserRolesCollection(), userId);
            try {
                await updateDoc(userRef, { status: newStatus });
                await logActivity(action, { targetUserId: userId, name: name });
                showToast(`User ${newStatus} successfully.`);
            } catch (error) {
                console.error("Suspend/activate user error:", error);
                showToast("Failed to update user status.", true);
            }
        }
        
        // --- NEW: Approve Request ---
        async function handleApproveRequest(requestId) {
            const requestRef = doc(getRequestsCollection(), requestId);
            try {
                await updateDoc(requestRef, { status: 'verified' });
                await logActivity("Request Verified", { 
                    requestId: requestId, 
                    manager: currentUserProfile.name 
                });
                showToast("Request verified and approved.");
                // Hide the summary page and go back
                document.getElementById('request-summary-page').classList.add('hidden');
                document.getElementById('manager-interface').classList.remove('hidden');
                showManagerTab('manager-requests-tab');
            } catch (error) {
                console.error("Approve request error:", error);
                showToast("Failed to approve request.", true);
            }
        }
        
        // --- NEW: Mark as Unauthorized ---
        async function handleUnauthorizedRequest(requestId, targetUserId, targetUserName) {
            showConfirmationModal(
                "Mark as Unauthorized?",
                `This will mark the request as "unauthorized" AND suspend the user account for ${targetUserName}. Are you sure?`,
                async () => {
                    const requestRef = doc(getRequestsCollection(), requestId);
                    const userRef = doc(getUserRolesCollection(), targetUserId);
                    
                    const batch = writeBatch(db);
                    
                    // 1. Mark request as unauthorized
                    batch.update(requestRef, { status: 'unauthorized' });
                    // 2. Suspend the user
                    batch.update(userRef, { status: 'suspended' });
                    
                    try {
                        await batch.commit();
                        await logActivity("Request Unauthorized & User Suspended", { 
                            requestId: requestId, 
                            targetUserId: targetUserId,
                            targetUserName: targetUserName,
                            manager: currentUserProfile.name 
                        });
                        showToast("Request marked unauthorized and user suspended.");
                        // Hide the summary page and go back
                        document.getElementById('request-summary-page').classList.add('hidden');
                        document.getElementById('manager-interface').classList.remove('hidden');
                        showManagerTab('manager-requests-tab');
                    } catch (error) {
                        console.error("Unauthorized request error:", error);
                        showToast("Failed to complete action.", true);
                    }
                }
            );
        }

        async function handleUpdateUserRole(userId) {
            if (userId === currentUserId) {
                showToast("You cannot change your own role.", true);
                return;
            }
            
            const roleSelect = document.getElementById(`role-${userId}`);
            const newRole = roleSelect.value;
            
            const userRoleRef = doc(getUserRolesCollection(), userId);
            try {
                await updateDoc(userRoleRef, { role: newRole });
                await logActivity("User Role Changed", { targetUserId: userId, newRole: newRole });
                showToast("User role updated successfully.");
            } catch (error) {
                console.error("Update role error: ", error);
                showToast("Failed to update user role.", true);
            }
        }
        
        async function handleDeleteUser(userId, email) {
            showConfirmationModal(
                "Delete User Data?",
                `This will delete all app data (profile, request list) for ${email}. It will NOT delete their login/PIN. You must do that from the Firebase Console. This is how you reset a user's PIN.`,
                async () => {
                    try {
                        // 1. Delete user role doc
                        const userRoleRef = doc(getUserRolesCollection(), userId);
                        await deleteDoc(userRoleRef);
                        
                        // 2. Delete user's request list (recursive delete)
                        const listRef = getUserRequestListCollection(userId);
                        const listSnapshot = await getDocs(listRef);
                        const batch = writeBatch(db);
                        listSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        
                        // 3. Log it
                        await logActivity("User Data Deleted", { deletedUserId: userId, email: email });
                        showToast("User data deleted. Remember to delete their login from the Auth console to reset their PIN.");

                    } catch (error) {
                        console.error("Delete user error:", error);
                        showToast("Failed to delete user data.", true);
                    }
                }
            );
        }
        
        // --- NEW: Dismiss Feedback ---
        async function handleDismissFeedback(feedbackId) {
            const feedbackRef = doc(getFeedbackCollection(), feedbackId);
            try {
                await updateDoc(feedbackRef, { status: 'read' });
                await logActivity("Feedback Read", { feedbackId: feedbackId });
                showToast("Feedback marked as read.");
                // Listener will auto-update the dashboard
            } catch (error) {
                console.error("Dismiss feedback error:", error);
                showToast("Could not dismiss feedback.", true);
            }
        }
        
        // --- SUPERUSER ACTIONS ---
        async function handleDeleteLog(logId) {
            try {
                await deleteDoc(doc(getActivityLogCollection(), logId));
                showToast("Log entry deleted.");
            } catch (error) {
                console.error("Delete log error:", error);
                showToast("Could not delete log.", true);
            }
        }
        
        async function handleDeleteRequest(requestId) { // Renamed
            showConfirmationModal(
                "Delete Request?",
                `Superuser: Delete this entire request (${requestId})? This is irreversible and will remove it from history.`,
                async () => {
                    try {
                        await deleteDoc(doc(getRequestsCollection(), requestId));
                        await logActivity("Request Deleted (Superuser)", { deletedRequestId: requestId });
                        showToast("Request deleted.");
                    } catch (error) {
                        console.error("Delete request error:", error);
                        showToast("Could not delete request.", true);
                    }
                }
            );
        }
        
        async function handleDeleteItem(itemId, name) {
            // --- FIX: Get item from stored cache ---
            const item = lastRequestCache;
            if (!item) {
                showToast("Could not find item to delete.", true);
                return;
            }
        
            showConfirmationModal(
                "Delete Inventory Item?",
                `Superuser: Delete "${item.name}" permanently? This is irreversible and will remove it from inventory.`,
                async () => {
                    try {
                        await deleteDoc(doc(getInventoryCollection(), item.id));
                        await logActivity("Inventory Item Deleted (Superuser)", { deletedItemId: item.id, name: item.name });
                        showToast("Item deleted.");
                        closeEditItemDetailsModal(); // Close the modal it was in
                    } catch (error) {
                        console.error("Delete item error:", error);
                        showToast("Could not delete item.", true);
                    }
                }
            );
        }
        
        // --- MODIFIED: Bulk Stock Update (Add/Remove) ---
        async function handleBulkStockUpdate() {
            const importBtn = document.getElementById('bulk-import-btn');
            const outputEl = document.getElementById('bulk-import-output');
            const textInput = document.getElementById('bulk-import-json').value.trim();
            
            if (!textInput) {
                showToast("Input is empty.", true);
                return;
            }
            
            const lines = textInput.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) {
                showToast("No valid lines found.", true);
                return;
            }
            
            importBtn.disabled = true;
            importBtn.textContent = "Processing...";
            outputEl.innerHTML = 'Starting update...<br>';
            
            let updatedCount = 0;
            let notFoundCount = 0;
            let errorCount = 0;
            
            const batch = writeBatch(db);
            const logPromises = [];
            const timestamp = serverTimestamp();
            
            for (const line of lines) {
                const parts = line.trim().split(/\s+/);
                if (parts.length !== 2) {
                    outputEl.innerHTML += `<span class="text-yellow-600">Skipping:</span> Invalid format "${line}"<br>`;
                    errorCount++;
                    continue;
                }
                
                const itemCode = parts[0];
                const qtyChange = parseInt(parts[1], 10);
                
                if (isNaN(qtyChange)) {
                    outputEl.innerHTML += `<span class="text-yellow-600">Skipping:</span> Invalid quantity for ${itemCode}.<br>`;
                    errorCount++;
                    continue;
                }
                
                if (qtyChange === 0) {
                     outputEl.innerHTML += `<span class="text-gray-500">Skipping:</span> No change for ${itemCode}.<br>`;
                    errorCount++;
                    continue;
                }
                
                const item = inventoryCache.find(i => i.itemCode === itemCode);
                
                if (!item) {
                    outputEl.innerHTML += `<span class="text-red-600">Error:</span> Item Code ${itemCode} not found.<br>`;
                    notFoundCount++;
                    continue;
                }
                
                const newStock = item.stock + qtyChange;
                
                if (newStock < 0) {
                    outputEl.innerHTML += `<span class="text-red-600">Error:</span> Cannot remove ${qtyChange} from ${itemCode}. Stock would be ${newStock}.<br>`;
                    errorCount++;
                    continue;
                }
                
                // Add to batch
                const itemRef = doc(getInventoryCollection(), item.id);
                let updateData = { stock: newStock };
                let logAction;
                let logDetails;
                
                if (qtyChange > 0) {
                    // ADDING STOCK
                    logAction = "Stock Added";
                    updateData.lastAddition = {
                        qty: qtyChange,
                        date: timestamp,
                        user: `${currentUserProfile.name} (Bulk)`
                    };
                    logDetails = { itemId: item.id, added: qtyChange, newStock: newStock, reason: "Bulk Stock Update" };
                    
                } else {
                    // REMOVING STOCK
                    logAction = "Stock Removed (Adjustment)";
                    updateData.lastWithdrawal = {
                        qty: Math.abs(qtyChange),
                        date: timestamp,
                        user: `${currentUserProfile.name} (Bulk)`
                    };
                    logDetails = { itemId: item.id, removed: Math.abs(qtyChange), newStock: newStock, reason: "Bulk Stock Update" };
                }

                batch.update(itemRef, updateData);
                logPromises.push(logActivity(logAction, logDetails));
                
                outputEl.innerHTML += `<span class="text-green-600">Success:</span> ${itemCode} stock set to ${newStock}.<br>`;
                updatedCount++;
            }
            
            try {
                // Commit all items
                await batch.commit();
                // Log all items
                await Promise.all(logPromises);
                
                outputEl.innerHTML += `<br><strong class="text-green-600">Update Complete!</strong><br>`;
                outputEl.innerHTML += `Updated: ${updatedCount}<br>`;
                outputEl.innerHTML += `Not Found: ${notFoundCount}<br>`;
                outputEl.innerHTML += `Errors/Skipped: ${errorCount}<br>`;
                
                await logActivity("Bulk Stock Update Completed", { updated: updatedCount, notFound: notFoundCount, errors: errorCount });
                showToast("Bulk update finished successfully!");
                document.getElementById('bulk-import-json').value = '';
                
            } catch (error) {
                console.error("Bulk update error:", error);
                outputEl.innerHTML += `<br><strong class="text-red-600">Error during update: ${error.message}</strong><br>`;
                showToast("Error during update. Check log.", true);
            } finally {
                // --- FIX: Re-enable the button after processing ---
                importBtn.disabled = false;
                importBtn.textContent = "Run Update";
            }
        }
        
        // --- NEW: Download CSV Template ---
        async function handleDownloadTemplate() {
            if (inventoryCache.length === 0) {
                showToast("Inventory data is not loaded yet.", true);
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ItemName,ItemCode,CurrentStock\n"; // Header
            
            inventoryCache.forEach(item => {
                const name = `"${item.name.replace(/"/g, '""')}"`; // Handle quotes in name
                csvContent += `${name},${item.itemCode},${item.stock}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "store_inventory_template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        
        // --- 7. EVENT LISTENERS ---
        function setupStaticEventListeners() {
            // Public Page
            document.getElementById('open-rules-btn').addEventListener('click', openRulesModal);
            document.getElementById('close-rules-btn').addEventListener('click', closeRulesModal);
            document.getElementById('open-feedback-btn').addEventListener('click', openFeedbackModal);
            document.getElementById('close-feedback-btn').addEventListener('click', closeFeedbackModal);
            document.getElementById('submit-feedback-btn').addEventListener('click', handleFeedbackSubmit);
        
            document.querySelector('button[onclick="handleLogout()"]').addEventListener('click', handleLogout);
            
            // User Nav
            document.querySelectorAll('#user-nav a').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = btn.dataset.page;
                    if (page) showUserPage(page);
                });
            });
            document.getElementById('go-to-checkout-btn').addEventListener('click', () => showUserPage('user-checkout-page'));

            // Manager Nav
            document.querySelectorAll('#manager-nav a').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = btn.dataset.tab;
                    if (tab) showManagerTab(tab);
                });
            });
            
            // Dashboard quick actions
            document.getElementById('dash-view-all-low').addEventListener('click', () => showManagerTab('inventory-mgt-tab'));
            document.getElementById('dash-view-all-logs').addEventListener('click', () => showManagerTab('activity-log-tab'));
            
            // Inventory Page
            document.getElementById('add-item-button').addEventListener('click', () => {
                document.getElementById('add-item-card').classList.remove('hidden');
                document.getElementById('add-item-button').classList.add('hidden');
            });
            document.getElementById('cancel-add-item-btn').addEventListener('click', () => {
                document.getElementById('add-item-card').classList.add('hidden');
                document.getElementById('add-item-button').classList.remove('hidden');
            });
            document.querySelector('button[onclick="handleAddInventoryItem()"]').addEventListener('click', handleAddInventoryItem);

            // Other Listeners
            document.getElementById('confirm-request-btn').addEventListener('click', handleSubmitRequest);
            document.getElementById('copy-summary-btn').addEventListener('click', handleCopySummary);
            document.getElementById('bulk-import-btn').addEventListener('click', handleBulkStockUpdate);
            document.getElementById('download-template-btn').addEventListener('click', handleDownloadTemplate); // NEW
            
            // Auth Listeners
            document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
            document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); handleRegister(); });
            document.getElementById('toggle-to-register').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(true); });
            document.getElementById('toggle-to-login').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(false); });
            
            const userCategoryFilter = document.getElementById('user-category-filter');
            if (userCategoryFilter) {
                userCategoryFilter.addEventListener('input', () => renderUserInventory(inventoryCache));
            }
            const userSearchFilter = document.getElementById('user-search-filter');
            if (userSearchFilter) {
                userSearchFilter.addEventListener('input', () => renderUserInventory(inventoryCache));
            }
            const managerCategoryFilter = document.getElementById('manager-category-filter');
            if (managerCategoryFilter) {
                managerCategoryFilter.addEventListener('input', () => renderManagerInventory(inventoryCache));
            }
            const managerSearchFilter = document.getElementById('manager-search-filter');
            if (managerSearchFilter) {
                managerSearchFilter.addEventListener('input', () => renderManagerInventory(inventoryCache));
            }
            
            // Modal Listeners
            document.getElementById('modal-cancel-btn').addEventListener('click', closeConfirmationModal);
            document.getElementById('modal-stock-cancel-btn').addEventListener('click', closeAddStockModal);
            document.getElementById('modal-remove-cancel-btn').addEventListener('click', closeRemoveStockModal); // NEW
            document.getElementById('item-history-close-btn').addEventListener('click', closeItemHistoryModal);
            document.getElementById('modal-detail-cancel-btn').addEventListener('click', closeEditItemDetailsModal);
        }

        // --- 8. GLOBAL EXPORTS & INITIALIZATION ---
        window.handleAddToRequest = handleAddToRequest;
        window.handleUpdateRequestQuantity = handleUpdateRequestQuantity;
        window.handleRemoveFromRequest = handleRemoveFromRequest;
        window.handleUpdateUserRole = handleUpdateUserRole;
        window.handleApproveUser = handleApproveUser;
        window.handleSuspendUser = handleSuspendUser;
        window.handleDeleteUser = handleDeleteUser;
        window.handleOpenAddStockModal = handleOpenAddStockModal;
        window.handleViewItemHistory = handleViewItemHistory;
        window.handleDeleteLog = handleDeleteLog;
        window.handleDeleteRequest = handleDeleteRequest;
        window.handleDeleteItem = handleDeleteItem;
        window.handleLogout = handleLogout;
        window.showUserPage = showUserPage;
        window.showManagerTab = showManagerTab;
        window.handleOpenEditModal = handleOpenEditModal;
        window.handleQuickAddStock = handleQuickAddStock;
        window.handleToggleCategory = handleToggleCategory;
        window.handleOpenRemoveStockModal = handleOpenRemoveStockModal;
        window.handleApproveRequest = handleApproveRequest;
        window.handleUnauthorizedRequest = handleUnauthorizedRequest;
        window.handleDismissFeedback = handleDismissFeedback;

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupStaticEventListeners();
            showView('public-view'); // Start on public view, not loading
        });
        
    </script>

    <!-- NEW: Custom Styles (FIXED) -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Spinner Animation */
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            /* Removed @apply */
        }
        
        /* Modal Panel */
        .modal-panel {
            /* Removed @apply and transform/opacity classes */
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl */
            padding: 1.5rem; /* p-6 */
        }
        
        /* Page Fade-in Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>

<!-- NEW: Modernized Body -->
<body class="bg-slate-50 min-h-screen flex flex-col text-gray-800">

    <!-- Loading View (kept for initial JS load) -->
    <div id="loading-view" class="flex items-center justify-center min-h-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500"></div>
    </div>
    
    <!-- NEW: Public View (Redesigned) -->
    <div id="public-view" class="hidden flex-grow w-full">
        <!-- Public Header -->
        <header class="bg-white rounded-b-xl shadow-md p-4 md:p-6">
            <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between md:items-center">
                <div>
                    <div class="flex items-center gap-3">
                        <svg class="w-10 h-10 text-red-600" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20C7.58 20 4 16.42 4 12C4 7.58 7.58 4 12 4ZM12 6C8.69 6 6 8.69 6 12C6 15.31 8.69 18 12 18C15.31 18 18 15.31 18 12C18 8.69 15.31 6 12 6ZM12 8C14.21 8 16 9.79 16 12C16 14.21 14.21 16 12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8ZM12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10Z"></path></svg>
                        <h1 class="text-3xl sm:text-4xl font-extrabold text-red-800">STORE-SIGHT</h1>
                    </div>
                    <p class="text-gray-600 ml-12">Hubli_Budarshingi_H Inventory-Stock Management</p>
                </div>
                <div class="mt-4 md:mt-0 text-left md:text-right">
                    <p class="text-base sm:text-lg text-gray-800 font-bold">Store In-Charge: Ankita Chandrappa Bandi</p>
                    <!-- "View Rules" button moved here -->
                    <button id="open-rules-btn" class="text-sm text-red-600 hover:underline font-medium">
                        View Store Rules & Guidelines
                    </button>
                    <p id="last-update-time" class="text-sm text-gray-500 mt-1">Loading...</p>
                </div>
            </div>
        </header>
        
        <!-- Public Main Content (Login/Register) -->
        <main class="flex-grow flex items-center justify-center p-4 py-12">
            <div class="w-full max-w-md">
            
                <!-- Login Form -->
                <div id="login-form-container">
                    <form id="login-form" class="p-8 bg-white rounded-2xl shadow-xl border space-y-5">
                        <h2 class="text-2xl font-bold text-gray-800 text-center">Employee Login</h2>
                        <div>
                            <label for="login-empid" class="block text-sm font-medium text-gray-700">Employee ID</label>
                            <input type="text" id="login-empid" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                        </div>
                        <div>
                            <label for="login-pin" class="block text-sm font-medium text-gray-700">4-Digit PIN</label>
                            <input type="password" id="login-pin" required maxlength="4" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                        </div>
                        
                        <div id="auth-error-message" class="hidden text-sm text-red-600 font-medium"></div>

                        <button id="login-button" type="submit" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 py-3">
                            <span id="login-spinner" class="spinner hidden"></span>
                            Login
                        </button>
                        <p class="text-sm text-center text-gray-600">
                            Don't have an account? 
                            <a href="#" id="toggle-to-register" class="font-medium text-red-600 hover:underline">Register here</a>
                        </p>
                    </form>
                </div>
                
                <!-- Register Form -->
                <div id="register-form-container" class="hidden">
                    <form id="register-form" class="p-8 bg-white rounded-2xl shadow-xl border space-y-5">
                        <h2 class="text-2xl font-bold text-gray-800 text-center">Register</h2>
                        <div>
                            <label for="register-empid" class="block text-sm font-medium text-gray-700">Employee ID</label>
                            <input type="text" id="register-empid" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                        </div>
                        <div>
                            <label for="register-pin" class="block text-sm font-medium text-gray-700">Create 4-Digit PIN</label>
                            <input type="password" id="register-pin" required maxlength="4" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                        </div>

                        <button id="register-button" type="submit" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-green-600 to-green-700 rounded-lg shadow-md hover:shadow-lg hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 py-3">
                            <span id="register-spinner" class="spinner hidden"></span>
                            Register
                        </button>
                        <p class="text-sm text-center text-gray-600">
                            Already have an account? 
                            <a href="#" id="toggle-to-login" class="font-medium text-red-600 hover:underline">Login here</a>
                        </p>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Setup View -->
    <div id="profile-setup-view" class="hidden flex-grow flex items-center justify-center p-4">
        <!-- JS will render the profile form here -->
    </div>
    
    <!-- Pending Approval View -->
    <div id="pending-view" class="hidden flex-grow flex items-center justify-center p-4 text-center">
        <div class="bg-white p-8 rounded-xl shadow-xl border max-w-lg">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Account Pending Approval</h1>
            <p class="text-gray-600 mb-6">Your profile is complete, but a manager still needs to approve your account before you can access the store. Please check back later.</p>
            <button onclick="handleLogout()" class="mt-2 text-sm text-red-500 hover:underline">
                Logout
            </button>
        </div>
    </div>
    
    <!-- Suspended View -->
    <div id="suspended-view" class="hidden flex-grow flex items-center justify-center p-4 text-center">
        <div class="bg-white p-8 rounded-xl shadow-xl border max-w-lg">
            <h1 class="text-2xl font-bold text-red-600 mb-4">Account Suspended</h1>
            <p class="text-gray-600 mb-6">Your account has been suspended. Please contact a manager for more information.</p>
            <button onclick="handleLogout()" class="mt-2 text-sm text-red-500 hover:underline">
                Logout
            </button>
        </div>
    </div>


    <!-- Main App Container (Redesigned) -->
    <div id="app-container" class="hidden flex-grow max-w-7xl mx-auto p-4 md:p-6 w-full space-y-6">
        <!-- NEW Modern Header -->
        <header class="flex flex-col md:flex-row justify-between md:items-center p-5 bg-white rounded-xl shadow-md border">
            <div class="flex items-center gap-3">
                <svg class="w-10 h-10 text-red-600" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20C7.58 20 4 16.42 4 12C4 7.58 7.58 4 12 4ZM12 6C8.69 6 6 8.69 6 12C6 15.31 8.69 18 12 18C15.31 18 18 15.31 18 12C18 8.69 15.31 6 12 6ZM12 8C14.21 8 16 9.79 16 12C16 14.21 14.21 16 12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8ZM12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10Z"></path></svg>
                <div>
                    <h1 class="text-3xl font-extrabold text-red-800">STORE-SIGHT</h1>
                    <p class="text-gray-600 text-sm">Hubli_Budarshingi_H Inventory-Stock Management</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-4">
                <div class="text-right">
                    <p id="header-user-name" class="text-lg font-bold text-gray-800">User Name</p>
                    <p id="header-user-details" class="text-sm text-gray-500">Emp ID & Role</p>
                </div>
                <div class="w-14 h-14 rounded-full bg-red-100 text-red-600 flex items-center justify-center">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                </div>
                <button onclick="handleLogout()" title="Logout" class="inline-flex items-center justify-center w-10 h-10 rounded-full transition-all duration-200 text-gray-500 hover:bg-red-100 hover:text-red-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </button>
            </div>
        </header>

        <!-- NEW User Navigation (Modern) -->
        <nav id="user-nav" class="flex flex-wrap gap-2 bg-white rounded-xl shadow-md border p-2">
            <a href="#" data-page="user-inventory-page" class="flex-1 flex items-center justify-center gap-2 py-3 px-2 text-center font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                Browse Items
            </a>
            <a href="#" data-page="user-request-page" class="flex-1 flex items-center justify-center gap-2 py-3 px-2 text-center font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                Request List
            </a>
            <a href="#" data-page="user-requests-page" class="flex-1 flex items-center justify-center gap-2 py-3 px-2 text-center font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                My Requests
            </a>
            <a href="#" data-page="user-profile-page" class="flex-1 flex items-center justify-center gap-2 py-3 px-2 text-center font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                My Profile
            </a>
        </nav>
        
        <!-- NEW Manager Navigation (Modern) -->
        <nav id="manager-nav" class="hidden flex flex-wrap gap-2 bg-white rounded-xl shadow-md border p-2">
            <a href="#" data-tab="dashboard-tab" class="flex-1 flex items-center justify-center gap-2 min-w-[120px] text-center py-3 px-4 font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Dashboard
            </a>
            <a href="#" data-tab="inventory-mgt-tab" class="flex-1 flex items-center justify-center gap-2 min-w-[120px] text-center py-3 px-4 font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                Inventory
            </a>
            <a href="#" data-tab="manager-requests-tab" class="flex-1 flex items-center justify-center gap-2 min-w-[120px] text-center py-3 px-4 font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                All Requests
            </a>
            <a href="#" data-tab="user-mgt-tab" class="flex-1 flex items-center justify-center gap-2 min-w-[120px] text-center py-3 px-4 font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                User Mgt
            </a>
             <a href="#" data-tab="activity-log-tab" class="flex-1 flex items-center justify-center gap-2 min-w-[120px] text-center py-3 px-4 font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6"></path></svg>
                Activity Log
            </a>
            <a href="#" data-tab="user-profile-page" class="flex-1 flex items-center justify-center gap-2 min-w-[120px] text-center py-3 px-4 font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                My Profile
            </a>
            <a id="bulk-import-nav-btn" href="#" data-tab="bulk-import-tab" class="hidden flex-1 flex items-center justify-center gap-2 min-w-[120px] text-center py-3 px-4 font-semibold text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M12 16v-4m0 0l-2 2m2-2l2 2m-2-4v-1a2 2 0 00-2-2h-2a2 2 0 00-2 2v1"></path></svg>
                Bulk Stock Update
            </a>
        </nav>

        <!-- Main Content Area -->
        <div class="bg-white p-4 md:p-8 rounded-xl shadow-md border min-h-[600px]">
            <!-- ================================== -->
            <!--        COMMON PAGES (USER)         -->
            <!-- ================================== -->
            <main id="user-interface" class="hidden">
                <!-- User Page: Inventory -->
                <div id="user-inventory-page">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">Browse Items</h2>
                    
                    <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-gray-50 rounded-xl border">
                        <div class="flex-1">
                            <label for="user-category-filter" class="block text-sm font-medium text-gray-700">Filter by Category</label>
                            <select id="user-category-filter" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                                <!-- Options will be added by JS -->
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="user-search-filter" class="block text-sm font-medium text-gray-700">Search by Name/Code</label>
                            <input type="text" id="user-search-filter" placeholder="Type to search..." class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                        </div>
                    </div>
                    
                    <!-- NEW: Grid Layout -->
                    <div id="user-inventory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <!-- User Page: Request List (Modernized) -->
                <div id="user-request-page" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">Your Request List</h2>
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- List -->
                        <div id="request-items-list" class="space-y-4 flex-grow lg:w-2/3"></div>
                        <!-- Summary -->
                        <div class="lg:w-1/3">
                            <div class="bg-gray-50 p-5 rounded-xl border-2 border-gray-200">
                                <h3 class="text-xl font-semibold mb-4">Request Summary</h3>
                                <div class="flex justify-between items-center mb-5">
                                    <span class="text-lg font-medium text-gray-800">Total:</span>
                                    <span id="request-total" class="text-2xl font-bold text-gray-900">0 items</span>
                                </div>
                                <button id="go-to-checkout-btn" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-green-600 to-green-700 rounded-lg shadow-md hover:shadow-lg hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2">
                                    Proceed to Submit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Page: Checkout (Submit Request) -->
                <div id="user-checkout-page" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">Submit Request</h2>
                    <div class="max-w-3xl mx-auto">
                        <h3 class="text-xl font-semibold mb-4">1. Request Details</h3>
                        <div id="checkout-items-list" class="space-y-6 mb-6"></div>
                        <h3 class="text-xl font-semibold mb-4">2. Supervision</h3>
                        <div class="bg-white p-5 rounded-xl shadow-md">
                            <label for="supervisor-name" class="block text-sm font-medium text-gray-700">Withdrawal Under Supervision Of:</label>
                            <input type="text" id="supervisor-name" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1" placeholder="Enter full name of security/supervisor">
                        </div>
                        <hr class="my-6">
                        <button id="confirm-request-btn" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 py-4">
                            Confirm & Submit Request
                        </button>
                    </div>
                </div>
                
                <!-- User Page: Request History (Grid) -->
                <div id="user-requests-page" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">My Request History</h2>
                    <div id="user-requests-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- JS renders history or error here -->
                    </div>
                </div>
            </main>

            <!-- ================================== -->
            <!--        COMMON PAGES (MANAGER)      -->
            <!-- ================================== -->
            <main id="manager-interface" class="hidden">
                <!-- Manager Tab: Dashboard (Modernized) -->
                <div id="dashboard-tab">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">Manager Dashboard</h2>
                    
                    <!-- NEW: KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-yellow-400 to-orange-500 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-medium">Pending Users</h3>
                                <svg class="w-8 h-8 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            </div>
                            <p id="kpi-pending-users" class="text-5xl font-extrabold mt-2">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-pink-600 p-6 rounded-xl shadow-lg text-white">
                             <div class="flex justify-between items-center">
                                <h3 class="text-lg font-medium">Low Stock Items</h3>
                                <svg class="w-8 h-8 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                            </div>
                            <p id="kpi-low-stock" class="text-5xl font-extrabold mt-2">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-6 rounded-xl shadow-lg text-white">
                             <div class="flex justify-between items-center">
                                <h3 class="text-lg font-medium">Total Item Types</h3>
                                <svg class="w-8 h-8 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                            </div>
                            <p id="kpi-total-items" class="text-5xl font-extrabold mt-2">0</p>
                        </div>
                    </div>
                    
                    <!-- NEW: Alerts Section -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Alerts</h3>
                        <div id="dashboard-alerts-list" class="space-y-4">
                            <!-- JS renders alerts -->
                        </div>
                    </div>

                    <!-- Dashboard Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-5 rounded-xl shadow-md border">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-gray-800">Low Stock Items</h3>
                                <button id="dash-view-all-low" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 text-sm py-1 px-3">View All</button>
                            </div>
                            <div id="dashboard-low-stock-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-md border">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-gray-800">Recent Activity</h3>
                                <button id="dash-view-all-logs" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 text-sm py-1 px-3">View Full Log</button>
                            </div>
                            <div id="dashboard-recent-activity" class="space-y-2 max-h-64 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Manager Tab: Inventory Management (Modernized) -->
                <div id="inventory-mgt-tab" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">Inventory Management</h2>
                    
                    <!-- NEW: Collapsible Add Item Card -->
                    <div class="mb-6">
                        <button id="add-item-button" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 py-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Add New Item
                        </button>
                        <div id="add-item-card" class="hidden bg-white p-6 rounded-xl shadow-lg border">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Add New Item</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name/Description</label>
                                    <input type="text" id="item-name" placeholder="e.g., Safety Helmet (Yellow)" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                                </div>
                                <div>
                                    <label for="item-code" class="block text-sm font-medium text-gray-700">Item Code</label>
                                    <input type="text" id="item-code" placeholder="e.g., HW-001" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                <div>
                                    <label for="item-category" class="block text-sm font-medium text-gray-700">Category</label>
                                    <input type="text" id="item-category" placeholder="e.g., Hardware" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                                </div>
                                <div>
                                    <label for="item-stock" class="block text-sm font-medium text-gray-700">Initial Stock</label>
                                    <input type="number" id="item-stock" value="10" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                                </div>
                                <div>
                                    <label for="item-low-stock" class="block text-sm font-medium text-gray-700">Low Stock Threshold</label>
                                    <input type="number" id="item-low-stock" value="5" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                                </div>
                            </div>
                            <div class="flex gap-4 mt-6">
                                <button onclick="handleAddInventoryItem()" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-green-600 to-green-700 rounded-lg shadow-md hover:shadow-lg hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 flex-1">
                                    Add New Item
                                </button>
                                <button id="cancel-add-item-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 flex-1">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Manage Stock</h3>
                        
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <label for="manager-category-filter" class="block text-sm font-medium text-gray-700">Filter by Category</label>
                                <select id="manager-category-filter" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                                    <!-- Options will be added by JS -->
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="manager-search-filter" class="block text-sm font-medium text-gray-700">Search by Name/Code</label>
                                <input type="text" id="manager-search-filter" placeholder="Type to search..." class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                            </div>
                        </div>
                        
                        <!-- NEW RENDERED LIST (Grid) -->
                        <div id="manager-inventory-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>
                
                <!-- Manager Tab: Request History (Grid) -->
                <div id="manager-requests-tab" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">All Request History</h2>
                    <div id="manager-requests-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>
                
                <!-- Manager Tab: User Management (Grid) -->
                <div id="user-mgt-tab" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">User Role Management</h2>
                    <div id="user-roles-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>
                
                 <!-- Manager Tab: Activity Log -->
                <div id="activity-log-tab" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">Activity Log (Ledger)</h2>
                    <div id="activity-log-list" class="space-y-4 max-h-[800px] overflow-y-auto"></div>
                </div>
                
                <!-- Manager/Superuser Tab: Bulk Stock Update -->
                <div id="bulk-import-tab" class="hidden">
                    <h2 class="text-3xl font-bold mb-6 text-red-800 border-b-2 border-red-100 pb-2">Bulk Stock Update</h2>
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-gray-600">Add or remove stock in bulk. Use format: <code class="font-mono bg-gray-100 p-1 rounded">ItemCode Quantity</code> (e.g., <code class="font-mono bg-gray-100 p-1 rounded">HW-001 10</code> or <code class="font-mono bg-gray-100 p-1 rounded">HW-002 -5</code>)</p>
                            <button id="download-template-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">Download Template (CSV)</button>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Note: Download the template, update quantities, and copy/paste only the ItemCode and Quantity columns into the box below.</p>
                        
                        <textarea id="bulk-import-json" class="w-full h-64 p-3 border rounded-lg font-mono text-sm block rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200" placeholder="HW-001 10
HW-002 -5
HW-003 20"></textarea>
                        <button id="bulk-import-btn" class="mt-4 w-full inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 py-4">
                            Run Update
                        </button>
                        
                        <h3 class="text-xl font-semibold mt-6 mb-4 text-gray-800 border-b pb-2">Update Log</h3>
                        <div id="bulk-import-output" class="w-full h-48 p-3 bg-gray-100 border rounded-lg overflow-y-auto font-mono text-sm">
                            Waiting for update...
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Common Page: Profile (Used by both User & Manager) -->
            <div id="user-profile-page" class="hidden">
                <!-- JS will render the profile form here -->
            </div>
            
            <!-- Common Page: Request Summary -->
            <div id="request-summary-page" class="hidden">
                <h2 id="request-summary-title" class="text-3xl font-bold mb-4 text-green-600 text-center"></h2>
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl border max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-red-800 border-b-2 border-red-100 pb-2">Withdrawal Slip</h3>
                        <button id="copy-summary-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                            Copy Summary
                        </button>
                    </div>
                    <div id="request-summary-details"></div>
                    <!-- Back Button Container -->
                    <div id="summary-back-btn-container" class="mt-6"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center py-6 mt-8">
        <p class="text-sm text-gray-600">Designed by Rh. for  Team Sonic</p>
    </footer>
    
    <!-- Toast Notification (Modern) -->
    <div id="toast-message" class="hidden opacity-0 -translate-y-12 fixed top-5 right-5 z-50 bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg transition-all duration-500">
        <!-- Message set by JS -->
    </div>
    
    <!-- Floating Feedback Button -->
    <button id="open-feedback-btn" class="fixed bottom-6 right-6 inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 rounded-full p-4 shadow-xl transform hover:scale-105">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
    </button>
    
    <!-- ================================== -->
    <!--            MODALS                -->
    <!-- ================================== -->

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
            <h2 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">Are you sure?</h2>
            <p id="modal-message" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                    Cancel
                </button>
                <button id="modal-confirm-btn" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-600 rounded-lg shadow-md hover:shadow-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Stock Modal (Legacy, but kept for Dashboard quick-add) -->
    <div id="add-stock-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Add Stock</h2>
            <p class="text-gray-600 mb-2">Item: <span id="modal-stock-item-name" class="font-semibold"></span></p>
            <p class="text-gray-600 mb-4">Current Stock: <span id="modal-stock-current" class="font-semibold"></span></p>
            <div>
                <label for="modal-stock-add-qty" class="block text-sm font-medium text-gray-700">Quantity to Add:</label>
                <input type="number" id="modal-stock-add-qty" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-stock-cancel-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                    Cancel
                </button>
                <button id="modal-stock-confirm-btn" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                    Add
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Remove Stock Modal -->
    <div id="remove-stock-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Remove Stock (Adjustment)</h2>
            <p class="text-gray-600 mb-2">Item: <span id="modal-remove-item-name" class="font-semibold"></span></T>
            <p class="text-gray-600 mb-4">Current Stock: <span id="modal-remove-current" class="font-semibold"></span></p>
            <div class="space-y-4">
                <div>
                    <label for="modal-remove-qty" class="block text-sm font-medium text-gray-700">Quantity to Remove:</label>
                    <input type="number" id="modal-remove-qty" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                </div>
                <div>
                    <label for="modal-remove-reason" class="block text-sm font-medium text-gray-700">Reason for Removal (Required):</label>
                    <input type="text" id="modal-remove-reason" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1" placeholder="e.g., Damaged, Expired">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-remove-cancel-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                    Cancel
                </button>
                <button id="modal-remove-confirm-btn" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-600 rounded-lg shadow-md hover:shadow-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                    Confirm Removal
                </button>
            </div>
        </div>
    </div>

    <!-- NEW Item History Modal -->
    <div id="item-history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full">
            <h2 id="item-history-title" class="text-xl font-bold text-gray-900 mb-4">Item History</h2>
            <div id="item-history-list" class="space-y-3 max-h-[60vh] overflow-y-auto bg-gray-50 p-4 rounded-lg border">
                <!-- JS renders history or error here -->
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="item-history-close-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW Edit Item Details Modal -->
    <div id="item-details-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h2 id="item-details-title" class="text-xl font-bold text-gray-900 mb-4">Edit Item</h2>
            <div class="space-y-4">
                <div>
                    <label for="modal-detail-item-name" class="block text-sm font-medium text-gray-700">Item Name/Description</label>
                    <input type="text" id="modal-detail-item-name" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                </div>
                 <div>
                    <label for="modal-detail-item-code" class="block text-sm font-medium text-gray-700">Item Code</label>
                    <input type="text" id="modal-detail-item-code" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                </div>
                 <div>
                    <label for="modal-detail-item-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="modal-detail-item-category" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                </div>
                <div>
                    <label for="modal-detail-item-threshold" class="block text-sm font-medium text-gray-700">Low Stock Threshold</label>
                    <input type="number" id="modal-detail-item-threshold" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                </div>
                <hr class="pt-2">
                <div class="flex items-center" id="delete-item-permissions">
                    <input type="checkbox" id="modal-detail-item-hidden" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <label for="modal-detail-item-hidden" class="ml-2 block text-sm font-medium text-gray-700">Hide from Public Inventory</label>
                    <button onclick="handleDeleteItem(lastRequestCache, lastRequestCache)" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-600 rounded-lg shadow-md hover:shadow-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 text-sm py-1 px-3 ml-auto">Delete Item</button>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-detail-cancel-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                    Cancel
                </button>
                <button id="modal-detail-confirm-btn" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Store Rules Modal -->
    <div id="store-rules-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-3xl w-full max-h-[80vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-red-800 flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Store Rules & Operating Guidelines
            </h2>
            <p class="text-gray-600 mb-6">To ensure transparency, accountability, and smooth operations, all users are required to follow the rules below:</p>
            
            <div class="space-y-5 overflow-y-auto p-2">
                <!-- Rules content... -->
                <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border">
                    <span class="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-red-600 text-white font-bold rounded-full text-lg">1</span>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Mandatory Recording of Withdrawals</h3>
                        <p class="text-gray-600 mt-1">All store withdrawals must be recorded in the App without exception. Items taken without entry in the system will be treated as unauthorized withdrawal.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border">
                    <span class="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-red-600 text-white font-bold rounded-full text-lg">2</span>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">User Registration & Approval</h3>
                        <p class="text-gray-600 mt-1">Users must register a new account in the app if they do not already have one. Access will be granted only after approval & verification.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border">
                    <span class="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-red-600 text-white font-bold rounded-full text-lg">3</span>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Withdrawal Oversight Requirement</h3>
                        <p class="text-gray-600 mt-1">Every withdrawal must take place in the presence of an authorised individual. The authorised persons full name must be mentioned in the withdrawal entry. Withdrawals done without authorised oversight will be treated as a violation.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border">
                    <span class="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-red-600 text-white font-bold rounded-full text-lg">4</span>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Data Accuracy & Responsibility</h3>
                        <p class="text-gray-600 mt-1">Any mismatch, manipulation, or variation in recorded data will require a formal explanation from the individual responsible. Users are accountable for the accuracy of entries made under their login.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border">
                    <span class="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-red-600 text-white font-bold rounded-full text-lg">5</span>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Proper Handling of Store Items</h3>
                        <p class="text-gray-600 mt-1">Items must be handled responsibly and returned (if applicable) in good condition. Damaged or missing items should be immediately reported.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border">
                    <span class="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-red-600 text-white font-bold rounded-full text-lg">6</span>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">No Third-Party Withdrawals</h3>
                        <p class="text-gray-600 mt-1">Users must withdraw items only for themselves or officially assigned work. Taking materials on behalf of another person without written/recorded approval is prohibited.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border">
                    <span class="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-red-600 text-white font-bold rounded-full text-lg">7</span>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Maintain Cleanliness & Order</h3>
                        <p class="text-gray-600 mt-1">Do not leave open boxes, scattered materials, or packaging on the floor. Keep the store area neat after every visit.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border">
                    <span class="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-red-600 text-white font-bold rounded-full text-lg">8</span>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Random Audits</h3>
                        <p class="text-gray-600 mt-1">The store is subject to periodic audits. Users may be contacted for verification of their withdrawals.</p>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button id="close-rules-btn" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Feedback Modal -->
    <div id="feedback-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Feedback & Suggestions</h2>
            <p class="text-gray-600 mb-6">Have an idea or found a bug? Let us know!</p>
            <div classs="space-y-4">
                <div>
                    <label for="feedback-type" class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="feedback-type" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1">
                        <option value="Suggestion">Suggestion</option>
                        <option value="Bug Report">Bug Report</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="mt-4">
                    <label for="feedback-text" class="block text-sm font-medium text-gray-700">Message</label>
                    <textarea id="feedback-text" rows="4" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-300 sm:text-sm transition-all duration-200 mt-1" placeholder="Your message..."></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="close-feedback-btn" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                    Cancel
                </button>
                <button id="submit-feedback-btn" class="inline-flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 rounded-lg shadow-md hover:shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                    Submit Feedback
                </button>
            </div>
        </div>
    </div>

</body>
</html>
