<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STORE-SIGHT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        :root {
            --theme-color: #DC2626; /* Red-600 */
            --theme-color-dark: #B91C1C; /* Red-700 */
            --theme-color-light: #FEE2E2; /* Red-100 */
            --theme-color-text: #F87171; /* Red-400 */
        }
        .theme-bg { background-color: var(--theme-color); }
        .theme-bg-dark { background-color: var(--theme-color-dark); }
        .theme-bg-light { background-color: var(--theme-color-light); }
        .theme-text { color: var(--theme-color); }
        .theme-text-light { color: var(--theme-color-text); }
        .theme-border { border-color: var(--theme-color); }

        .nav-tab {
            @apply text-sm font-medium text-center text-gray-400 p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-300 hover:border-gray-500 cursor-pointer;
        }
        .nav-tab.active {
            @apply text-white border-b-2 border-red-600;
        }
        .btn {
            @apply w-full font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-200;
        }
        .btn-primary {
            @apply bg-red-600 hover:bg-red-700 text-white;
        }
        .btn-secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-800;
        }
        .btn-outline {
            @apply bg-white border border-gray-300 hover:bg-gray-100 text-gray-800;
        }
        .btn-danger {
            @apply bg-red-100 hover:bg-red-200 text-red-700;
        }

        .form-input {
            @apply bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5;
        }
        .form-label {
            @apply block mb-2 text-sm font-medium text-gray-900;
        }
        .card {
            @apply bg-white rounded-xl shadow-lg p-6;
        }
        .modal {
            @apply fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50;
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-xl p-6 w-full max-w-md;
        }
        .page-header {
            @apply text-2xl font-bold text-red-700 border-b-2 border-red-200 pb-2 mb-6;
        }
        .section-header {
            @apply text-xl font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-4;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Public filter pills */
        .filter-pill {
            @apply text-sm font-medium px-4 py-1.5 rounded-full cursor-pointer transition-colors;
        }
        .filter-pill.active {
            @apply bg-red-600 text-white;
        }
        .filter-pill:not(.active) {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
    </style>
</head>
<body class="h-full flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 w-full z-10">
        <div class="container mx-auto max-w-6xl">
            <h1 class="text-3xl font-bold text-red-700">STORE-SIGHT</h1>
            <p class="text-sm text-gray-600">Hubli_Budarshingi_H Inventory-Stock Management</p>
            <p id="store-in-charge-header" class="text-sm text-gray-800 font-bold mt-1 text-lg">Store In-Charge: Ankita Chandrappa Bandi</p>
            
            <!-- Logged-in User Info -->
            <div id="user-info-header" class="hidden mt-2 text-sm">
                <span id="user-details-header"></span>
                <span id="user-role-header" class="font-bold ml-2"></span>
                <a href="#" id="logout-button" class="ml-4 text-red-600 hover:underline font-medium">Logout</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-6 bg-gray-100">
        <div class="container mx-auto max-w-6xl">

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-red-600"></div>
            </div>

            <!-- Login / Register Page -->
            <div id="auth-page" class="hidden">
                <div class="max-w-md mx-auto mt-10">
                    <div id="login-form-container" class="card">
                        <h2 class="page-header">Login</h2>
                        <form id="login-form">
                            <div>
                                <label for="login-emp-id" class="form-label">Employee ID</label>
                                <input type="text" id="login-emp-id" class="form-input" required>
                            </div>
                            <div class="mt-4">
                                <label for="login-pin" class="form-label">4-Digit PIN</label>
                                <input type="password" id="login-pin" class="form-input" minlength="4" maxlength="4" inputmode="numeric" required>
                            </div>
                            <button type="submit" class="btn btn-primary mt-6">Login</button>
                            <p class="mt-4 text-sm text-center text-gray-600">
                                No account? <a href="#" id="show-register-form" class="text-red-600 hover:underline">Register here</a>
                            </p>
                            <p id="login-error" class="text-red-600 text-sm mt-2 text-center"></p>
                        </form>
                    </div>

                    <div id="register-form-container" class="card hidden">
                        <h2 class="page-header">Register</h2>
                        <form id="register-form">
                            <div>
                                <label for="reg-emp-id" class="form-label">Employee ID</label>
                                <input type="text" id="reg-emp-id" class="form-input" required>
                            </div>
                            <div class="mt-4">
                                <label for="reg-pin" class="form-label">4-Digit PIN</label>
                                <input type="password" id="reg-pin" class="form-input" minlength="4" maxlength="4" inputmode="numeric" required>
                            </div>
                            <div class="mt-4">
                                <label for="reg-name" class="form-label">Full Name</label>
                                <input type="text" id="reg-name" class="form-input" required>
                            </div>
                            <div class="mt-4">
                                <label for="reg-designation" class="form-label">Designation</label>
                                <input type="text" id="reg-designation" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn-primary mt-6">Register</button>
                            <p class="mt-4 text-sm text-center text-gray-600">
                                Already have an account? <a href="#" id="show-login-form" class="text-red-600 hover:underline">Login here</a>
                            </p>
                            <p id="register-error" class="text-red-600 text-sm mt-2 text-center"></p>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Profile Completion Page -->
            <div id="profile-completion-page" class="hidden">
                <div class="max-w-md mx-auto mt-10 card">
                    <h2 class="page-header">Complete Your Profile</h2>
                    <p class="mb-4 text-gray-600">Please provide your details to continue.</p>
                    <form id="profile-completion-form">
                        <div class="mt-4">
                            <label for="profile-name" class="form-label">Full Name</label>
                            <input type="text" id="profile-name" class="form-input" required>
                        </div>
                        <div class="mt-4">
                            <label for="profile-designation" class="form-label">Designation</label>
                            <input type="text" id="profile-designation" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-6">Save Profile</button>
                        <p id="profile-completion-error" class="text-red-600 text-sm mt-2 text-center"></p>
                    </form>
                </div>
            </div>

            <!-- User Verification Page -->
            <div id="verification-page" class="hidden">
                <div class="max-w-md mx-auto mt-10 card text-center">
                    <h2 class="page-header">Account Pending</h2>
                    <p class="text-gray-700">Your account has been registered successfully.</p>
                    <p class="text-gray-700 mt-2">A manager must approve your account before you can proceed.</p>
                    <button id="logout-button-verification" class="btn btn-primary mt-6">Logout</button>
                </div>
            </div>

            <!-- Public Inventory Page -->
            <div id="public-inventory-page" class="hidden">
                <div class="card">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                        <h2 class="page-header mb-0 md:mb-6">Live Inventory Stock</h2>
                        <div class="flex items-center space-x-2 overflow-x-auto no-scrollbar pb-2">
                            <span class="text-sm font-medium text-gray-700">Filter:</span>
                            <span id="filter-all" class="filter-pill active">All</span>
                            <span id="filter-in-stock" class="filter-pill">In Stock</span>
                            <span id="filter-low-stock" class="filter-pill">Low Stock</span>
                            <span id="filter-out-of-stock" class="filter-pill">Out of Stock</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">Last updated: <span id="public-last-updated"></span></p>

                    <!-- Scrollable Table Container -->
                    <div class="overflow-y-auto max-h-[60vh] border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Update</th>
                                </tr>
                            </thead>
                            <tbody id="public-inventory-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                    <div id="public-inventory-empty" class="text-center p-10 text-gray-500 hidden">
                        <p>No inventory items found.</p>
                    </div>
                    
                    <button id="public-login-button" class="btn btn-primary mt-6">Login / Register to Place Request</button>
                </div>
            </div>

            <!-- Regular User Interface -->
            <div id="user-interface" class="hidden">
                <!-- User Navigation -->
                <nav class="bg-gray-800 rounded-lg shadow-md mb-6">
                    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
                        <div class="relative flex items-center justify-between h-16">
                            <div class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start">
                                <div class="flex space-x-4">
                                    <a href="#" id="user-nav-inventory" class="nav-tab active">Inventory</a>
                                    <a href="#" id="user-nav-list" class="nav-tab">Request List <span id="user-cart-count" class="bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1">0</span></a>
                                    <a href="#" id="user-nav-requests" class="nav-tab">My Requests</a>
                                    <a href="#" id="user-nav-profile" class="nav-tab">My Profile</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- User Pages -->
                <div id="user-pages">
                    <!-- User Inventory Page -->
                    <div id="user-inventory-page" class="card">
                        <h2 class="page-header">Make a Request</h2>
                        <input type="text" id="user-inventory-search" class="form-input mb-4" placeholder="Search by name, code, or category...">
                        <div id="user-inventory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- JS will populate this -->
                        </div>
                        <p id="user-inventory-empty" class="text-gray-500 text-center hidden">No items found.</p>
                    </div>

                    <!-- User Request List (Cart) Page -->
                    <div id="user-list-page" class="hidden card">
                        <h2 class="page-header">My Request List</h2>
                        <div id="user-cart-items">
                            <!-- JS will populate this -->
                        </div>
                        <div id="user-cart-empty" class="text-gray-500 text-center hidden">
                            <p>Your request list is empty.</p>
                        </div>
                        <div id="user-cart-checkout-section" class="mt-6 border-t pt-6 hidden">
                            <h3 class="section-header">Submit Request</h3>
                            <form id="checkout-form">
                                <div class="mb-4">
                                    <label for="checkout-supervisor" class="form-label">Supervised by (Name)</label>
                                    <input type="text" id="checkout-supervisor" class="form-input" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Submit Request</button>
                            </form>
                        </div>
                    </div>

                    <!-- User My Requests (History) Page -->
                    <div id="user-requests-page" class="hidden card">
                        <h2 class="page-header">My Request History</h2>
                        <div id="user-request-history-list" class="space-y-4">
                            <!-- JS will populate this -->
                        </div>
                        <p id="user-request-history-empty" class="text-gray-500 text-center hidden">You have not placed any requests.</p>
                        <p id="user-request-history-error" class="text-red-500 text-center hidden"></p>
                    </div>

                    <!-- User My Profile Page -->
                    <div id="user-profile-page" class="hidden card">
                        <h2 class="page-header">My Profile</h2>
                        <form id="user-profile-form">
                            <div class="mb-4">
                                <label for="profile-emp-id-display" class="form-label">Employee ID</label>
                                <input type="text" id="profile-emp-id-display" class="form-input bg-gray-200" disabled>
                            </div>
                             <div class="mb-4">
                                <label for="profile-name-display" class="form-label">Full Name</label>
                                <input type="text" id="profile-name-display" class="form-input" required>
                            </div>
                             <div class="mb-4">
                                <label for="profile-designation-display" class="form-label">Designation</label>
                                <input type="text" id="profile-designation-display" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                            <p id="profile-update-success" class="text-green-600 text-sm mt-2 text-center"></p>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Manager/Superuser Interface -->
            <div id="manager-interface" class="hidden">
                <!-- Manager Navigation -->
                <nav class="bg-gray-800 rounded-lg shadow-md mb-6">
                    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
                        <div class="relative flex items-center justify-between h-16 overflow-x-auto no-scrollbar">
                            <div class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start">
                                <div class="flex space-x-4">
                                    <a href="#" id="manager-nav-dashboard" class="nav-tab active">Dashboard</a>
                                    <a href="#" id="manager-nav-inventory" class="nav-tab">Inventory</a>
                                    <a href="#" id="manager-nav-requests" class="nav-tab">All Requests</a>
                                    <a href="#" id="manager-nav-users" class="nav-tab">User Mgt</a>
                                    <a href="#" id="manager-nav-log" class="nav-tab">Activity Log</a>
                                    <a href="#" id="manager-nav-import" class="nav-tab hidden">Bulk Import</a>
                                    <a href="#" id="manager-nav-profile" class="nav-tab">My Profile</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Manager Pages -->
                <div id="manager-pages">
                    <!-- Manager Dashboard -->
                    <div id="manager-dashboard-page" class="card">
                        <h2 class="page-header">Manager Dashboard</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-red-100 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-red-700">Pending Users</p>
                                <p id="dashboard-pending-users" class="text-3xl font-bold text-red-900">0</p>
                                <button id="dashboard-goto-users" class="text-sm text-red-600 hover:underline">View Users</button>
                            </div>
                            <div class="bg-yellow-100 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-yellow-700">Low Stock Items</p>
                                <p id="dashboard-low-stock-items" class="text-3xl font-bold text-yellow-900">0</p>
                                <button id="dashboard-goto-inventory" class="text-sm text-yellow-600 hover:underline">View Inventory</button>
                            </div>
                            <div class="bg-blue-100 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-blue-700">Total Requests</p>
                                <p id="dashboard-total-requests" class="text-3xl font-bold text-blue-900">0</p>
                                <button id="dashboard-goto-requests" class="text-sm text-blue-600 hover:underline">View Requests</button>
                            </div>
                        </div>
                    </div>

                    <!-- Manager Inventory Page -->
                    <div id="manager-inventory-page" class="hidden card">
                        <h2 class="page-header">Manage Inventory</h2>
                        <button id="show-add-item-modal" class="btn btn-primary mb-4 w-auto">Add New Item</button>
                        <input type="text" id="manager-inventory-search" class="form-input mb-4" placeholder="Search by name, code, or category...">
                        
                        <!-- Compact List/Table for Inventory -->
                        <div class="space-y-2" id="manager-inventory-list">
                            <!-- JS will populate this -->
                        </div>
                        <p id="manager-inventory-empty" class="text-gray-500 text-center hidden">No items found.</p>
                    </div>

                    <!-- Manager All Requests Page -->
                    <div id="manager-requests-page" class="hidden card">
                        <h2 class="page-header">All Requests</h2>
                        <input type="text" id="manager-request-search" class="form-input mb-4" placeholder="Search by User Name, Emp ID, or Order ID...">
                        <div id="manager-request-list" class="space-y-4">
                            <!-- JS will populate this -->
                        </div>
                        <p id="manager-request-list-empty" class="text-gray-500 text-center hidden">No requests found.</p>
                        <p id="manager-request-list-error" class="text-red-500 text-center hidden"></p>
                    </div>

                    <!-- Manager User Mgt Page -->
                    <div id="manager-users-page" class="hidden card">
                        <h2 class="page-header">User Management</h2>
                        <input type="text" id="manager-user-search" class="form-input mb-4" placeholder="Search by Name or Employee ID...">
                        <div class="space-y-4" id="manager-user-list">
                            <!-- JS will populate this -->
                        </div>
                    </div>

                    <!-- Manager Activity Log Page -->
                    <div id="manager-log-page" class="hidden card">
                        <h2 class="page-header">Activity Log</h2>
                        <input type="text" id="manager-log-search" class="form-input mb-4" placeholder="Search by user name, action, or item...">
                        <div class="space-y-2" id="manager-log-list">
                            <!-- JS will populate this -->
                        </div>
                        <p id="manager-log-empty" class="text-gray-500 text-center hidden">No log entries found.</p>
                        <p id="manager-log-error" class="text-red-500 text-center hidden"></p>
                    </div>

                    <!-- Manager Bulk Import Page (Superuser only) -->
                    <div id="manager-import-page" class="hidden card">
                        <h2 class="page-header">Bulk Data Import (Superuser)</h2>
                        
                        <!-- Section 1: Bulk Item Import -->
                        <section class="mb-8">
                            <h3 class="section-header">1. Bulk Item Import</h3>
                            <p class="text-sm text-gray-600 mb-2">Import new inventory items. Paste your JSON array in the format specified in the guide.</p>
                            <textarea id="bulk-import-json" class="form-input w-full h-40" placeholder="[... Paste your item JSON here ...]"></textarea>
                            <button id="bulk-import-submit" class="btn btn-primary mt-2 w-auto">Import Items</button>
                            <p id="bulk-import-status" class="text-sm mt-2"></p>
                        </section>

                        <!-- REMOVED: Section 2: Bulk Stock Update -->
                        
                    </div>

                    <!-- Manager My Profile Page -->
                    <div id="manager-profile-page" class="hidden card">
                        <!-- Identical to user profile page, just uses a different ID -->
                        <h2 class="page-header">My Profile</h2>
                        <form id="manager-profile-form">
                            <div class="mb-4">
                                <label for="manager-profile-emp-id-display" class="form-label">Employee ID</label>
                                <input type="text" id="manager-profile-emp-id-display" class="form-input bg-gray-200" disabled>
                            </div>
                             <div class="mb-4">
                                <label for="manager-profile-name-display" class="form-label">Full Name</label>
                                <input type="text" id="manager-profile-name-display" class="form-input" required>
                            </div>
                             <div class="mb-4">
                                <label for="manager-profile-designation-display" class="form-label">Designation</label>
                                <input type="text" id="manager-profile-designation-display" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                            <p id="manager-profile-update-success" class="text-green-600 text-sm mt-2 text-center"></p>
                        </form>
                    </div>

                </div>
            </div>

            <!-- Withdrawal Slip Page -->
            <div id="withdrawal-slip-page" class="hidden">
                <div class="card max-w-2xl mx-auto">
                    <button id="withdrawal-slip-back-button" class="btn btn-secondary w-auto mb-4">← Back</button>
                    <h2 id="withdrawal-slip-title" class="page-header">Withdrawal Slip</h2>
                    <div id="withdrawal-slip-content" class="space-y-4">
                        <!-- JS will populate this -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-4 mt-6">
        <div class="container mx-auto max-w-6xl text-center text-sm">
            Designed by Rh. for ⚡ Team Sonic
        </div>
    </footer>

    <!-- Modals (Confirmation, Add Item, Item History, etc.) -->
    
    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="confirmation-title" class="text-lg font-bold mb-4">Are you sure?</h3>
            <p id="confirmation-message" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmation-cancel-btn" class="btn btn-secondary w-auto">Cancel</button>
                <button id="confirmation-confirm-btn" class="btn btn-primary w-auto">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="add-item-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="add-item-modal-title" class="text-lg font-bold mb-4">Add New Item</h3>
            <form id="add-item-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="item-name" class="form-label">Item Name</label>
                        <input type="text" id="item-name" class="form-input" required>
                    </div>
                    <div>
                        <label for="item-code" class="form-label">Item Code</label>
                        <input type="text" id="item-code" class="form-input" required>
                    </div>
                    <div>
                        <label for="item-category" class="form-label">Item Category</label>
                        <input type="text" id="item-category" class="form-input" required>
                    </div>
                    <div>
                        <label for="item-stock" class="form-label">Initial Stock</label>
                        <input type="number" id="item-stock" class="form-input" min="0" value="0" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="item-low-stock" class="form-label">Low Stock Threshold</label>
                        <input type="number" id="item-low-stock" class="form-input" min="0" value="0" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="add-item-cancel-btn" class="btn btn-secondary w-auto">Cancel</button>
                    <button type="submit" class="btn btn-primary w-auto">Save Item</button>
                </div>
                <p id="add-item-error" class="text-red-600 text-sm mt-2 text-center"></p>
            </form>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div id="add-stock-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Add Stock for <span id="add-stock-item-name" class="text-red-600"></span></h3>
            <form id="add-stock-form">
                <div>
                    <label for="add-stock-quantity" class="form-label">Quantity to Add</label>
                    <input type="number" id="add-stock-quantity" class="form-input" min="1" required>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="add-stock-cancel-btn" class="btn btn-secondary w-auto">Cancel</button>
                    <button type="submit" class="btn btn-primary w-auto">Add Stock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Item Name Modal -->
    <div id="edit-name-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Edit Item Details</h3>
            <form id="edit-name-form">
                <div>
                    <label for="edit-item-name" class="form-label">Item Name</label>
                    <input type="text" id="edit-item-name" class="form-input" required>
                </div>
                <div class="mt-4">
                    <label for="edit-item-code" class="form-label">Item Code</label>
                    <input type="text" id="edit-item-code" class="form-input" required>
                </div>
                <div class="mt-4">
                    <label for="edit-item-category" class="form-label">Item Category</label>
                    <input type="text" id="edit-item-category" class="form-input" required>
                </div>
                <div class="mt-4">
                    <label for="edit-item-low-stock" class="form-label">Low Stock Threshold</label>
                    <input type="number" id="edit-item-low-stock" class="form-input" min="0" required>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="edit-name-cancel-btn" class="btn btn-secondary w-auto">Cancel</button>
                    <button type="submit" class="btn btn-primary w-auto">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Item History Modal -->
    <div id="item-history-modal" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <h3 class="text-lg font-bold mb-4">History for <span id="item-history-item-name" class="text-red-600"></span></h3>
            <div id="item-history-list" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- JS will populate this -->
            </div>
            <p id="item-history-empty" class="text-gray-500 text-center hidden">No history found for this item.</p>
            <p id="item-history-error" class="text-red-500 text-center hidden"></p>
            <div class="flex justify-end mt-6">
                <button id="item-history-close-btn" class="btn btn-secondary w-auto">Close</button>
            </div>
        </div>
    </div>

    <!-- Generic Message/Toast -->
    <div id="toast-message" class="hidden fixed bottom-5 right-5 z-50 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg">
        <span id="toast-text"></span>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            addDoc,
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            Timestamp,
            writeBatch,
            runTransaction,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- USER'S FIREBASE CONFIG ---
        // This was provided by the user
        const firebaseConfig = {
          apiKey: "AIzaSyDmCSYXnlcXfxt-MvoEkGs0ilVW-E2_Ex4",
          authDomain: "hubli-store.firebaseapp.com",
          projectId: "hubli-store",
          storageBucket: "hubli-store.firebasestorage.app",
          messagingSenderId: "324782981287",
          appId: "1:324782981287:web:10f6b46d6a5f222a155b82"
        };
        // --- END OF USER'S CONFIG ---

        // App ID (must match in security rules)
        const appId = 'hubli-store';

        // Firebase instances
        let app, auth, db;

        // App state
        let currentUserId = null;
        let currentUserRole = null;
        let currentUserProfile = null;
        let globalInventory = []; // Cache for inventory
        let globalRequests = []; // Cache for requests
        let globalLogs = []; // Cache for logs
        let globalUsers = []; // Cache for users
        let inventoryListener = null;
        let cartListener = null;
        let requestsListener = null;
        let usersListener = null;
        let logListener = null;
        
        let activeConfirmationCallback = null; // For the generic confirmation modal

        // DOM Elements
        const $ = (selector) => document.getElementById(selector);

        const pages = {
            loading: $('loading-spinner'),
            auth: $('auth-page'),
            profileCompletion: $('profile-completion-page'),
            verification: $('verification-page'),
            publicInventory: $('public-inventory-page'),
            userInterface: $('user-interface'),
            managerInterface: $('manager-interface'),
            withdrawalSlip: $('withdrawal-slip-page')
        };
        
        const userPages = {
            inventory: $('user-inventory-page'),
            list: $('user-list-page'),
            requests: $('user-requests-page'),
            profile: $('user-profile-page')
        };

        const managerPages = {
            dashboard: $('manager-dashboard-page'),
            inventory: $('manager-inventory-page'),
            requests: $('manager-requests-page'),
            users: $('manager-users-page'),
            log: $('manager-log-page'),
            import: $('manager-import-page'),
            profile: $('manager-profile-page')
        };

        const userNav = {
            inventory: $('user-nav-inventory'),
            list: $('user-nav-list'),
            requests: $('user-nav-requests'),
            profile: $('user-nav-profile')
        };
        
        const managerNav = {
            dashboard: $('manager-nav-dashboard'),
            inventory: $('manager-nav-inventory'),
            requests: $('manager-nav-requests'),
            users: $('manager-nav-users'),
            log: $('manager-nav-log'),
            import: $('manager-nav-import'),
            profile: $('manager-nav-profile')
        };

        const confirmationModal = {
            modal: $('confirmation-modal'),
            title: $('confirmation-title'),
            message: $('confirmation-message'),
            cancelBtn: $('confirmation-cancel-btn'),
            confirmBtn: $('confirmation-confirm-btn')
        };

        const addItemModal = {
            modal: $('add-item-modal'),
            title: $('add-item-modal-title'),
            form: $('add-item-form'),
            name: $('item-name'),
            code: $('item-code'),
            category: $('item-category'),
            stock: $('item-stock'),
            lowStock: $('item-low-stock'),
            error: $('add-item-error'),
            cancelBtn: $('add-item-cancel-btn')
        };
        
        // --- Utility Functions ---
        
        function showPage(pageId) {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            if (pages[pageId]) {
                pages[pageId].classList.remove('hidden');
            } else {
                console.error(`Page not found: ${pageId}`);
            }
        }
        
        function showUserPage(pageId) {
            Object.values(userPages).forEach(page => page.classList.add('hidden'));
            if (userPages[pageId]) {
                userPages[pageId].classList.remove('hidden');
            }
            Object.values(userNav).forEach(nav => nav.classList.remove('active'));
            if (userNav[pageId]) {
                userNav[pageId].classList.add('active');
            }
        }

        function showManagerPage(pageId) {
            Object.values(managerPages).forEach(page => page.classList.add('hidden'));
            if (managerPages[pageId]) {
                managerPages[pageId].classList.remove('hidden');
            }
            Object.values(managerNav).forEach(nav => nav.classList.remove('active'));
            if (managerNav[pageId]) {
                managerNav[pageId].classList.add('active');
            }
        }

        function showToast(message, isError = false) {
            const toast = $('toast-message');
            const toastText = $('toast-text');
            toastText.textContent = message;
            toast.className = 'fixed bottom-5 right-5 z-50 px-6 py-3 rounded-lg shadow-lg'; // Reset classes
            if (isError) {
                toast.classList.add('bg-red-600', 'text-white');
            } else {
                toast.classList.add('bg-green-600', 'text-white');
            }
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            return timestamp.toDate().toLocaleString('en-IN', { 
                dateStyle: 'medium', 
                timeStyle: 'short' 
            });
        }
        
        function showConfirmation(title, message, onConfirm) {
            confirmationModal.title.textContent = title;
            confirmationModal.message.textContent = message;
            activeConfirmationCallback = onConfirm;
            confirmationModal.modal.classList.remove('hidden');
        }

        function hideConfirmation() {
            confirmationModal.modal.classList.add('hidden');
            activeConfirmationCallback = null;
        }

        function formatEmpId(empId) {
            return `user-${empId.trim()}@hubli-store.app`;
        }

        function formatPin(pin) {
            // Add prefix to meet 6-char minimum
            return `PIN-${pin.trim()}`;
        }
        
        async function logActivity(action, details = {}) {
            try {
                const logData = {
                    action: action,
                    userId: currentUserId || 'system',
                    userName: currentUserProfile?.name || 'System',
                    timestamp: Timestamp.now(),
                    ...details
                };
                await addDoc(getLogCollection(), logData);
            } catch (error) {
                console.error("Error logging activity: ", error);
            }
        }
        
        // Helper function to sort arrays by name
        function sortByName(arr) {
            return arr.sort((a, b) => {
                if (!a.name || !b.name) return 0;
                return a.name.localeCompare(b.name);
            });
        }

        // --- Firebase Collection References ---
        // These now use appId variable for path security
        
        const getInventoryCollection = () => collection(db, `artifacts/${appId}/public/data/inventory`);
        const getInventoryDoc = (id) => doc(db, `artifacts/${appId}/public/data/inventory`, id);
        
        const getUserRolesCollection = () => collection(db, `artifacts/${appId}/public/data/user_roles`);
        const getUserRoleDoc = (userId) => doc(db, `artifacts/${appId}/public/data/user_roles`, userId);
        
        const getRequestsCollection = () => collection(db, `artifacts/${appId}/public/data/requests`);
        const getRequestDoc = (id) => doc(db, `artifacts/${appId}/public/data/requests`, id);

        const getLogCollection = () => collection(db, `artifacts/${appId}/public/data/log`);
        const getLogDoc = (id) => doc(db, `artifacts/${appId}/public/data/log`, id);
        
        const getUserCartCollection = (userId) => collection(db, `artifacts/${appId}/users/${userId}/cart`);
        const getUserCartDoc = (userId, id) => doc(db, `artifacts/${appId}/users/${userId}/cart`, id);


        // --- Initialization ---

        window.onload = function() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Set up auth state listener
                onAuthStateChanged(auth, handleAuthStateChange);
                
                // Set up global event listeners
                setupGlobalListeners();
                
                // Initial render of public page (will be hidden if logged in)
                // This is to show *something* while auth check happens
                renderPublicInventory();
                
                // BUGFIX: Do NOT attach public listener here.
                // handleAuthStateChange(null) will do it.

            } catch (error) {
                console.error("Firebase initialization error:", error);
                pages.loading.innerHTML = '<p class="text-red-500">Error loading app. Please refresh.</p>';
            }
        };

        // --- Authentication ---
        
        async function handleAuthStateChange(user) {
            if (user) {
                // User is logged in
                currentUserId = user.uid;
                // Detach the public listener if it exists
                if (inventoryListener) inventoryListener();
                inventoryListener = null;
                
                await checkUserRole(user.uid);
            } else {
                // User is logged out or page is loading for first time
                currentUserId = null;
                currentUserRole = null;
                currentUserProfile = null;
                
                // Detach any logged-in listeners
                detachAllListeners(); 
                
                // BUGFIX: Attach the public listener *now*
                attachPublicInventoryListener();
                
                renderPublicInventory();
                showPage('publicInventory');
            }
            pages.loading.classList.add('hidden');
        }

        async function checkUserRole(userId) {
            try {
                const roleDoc = await getDoc(getUserRoleDoc(userId));
                if (roleDoc.exists()) {
                    const data = roleDoc.data();
                    currentUserProfile = data;
                    currentUserRole = data.role;
                    
                    if (!data.name || !data.designation) {
                        // Profile incomplete
                        showPage('profileCompletion');
                        $('profile-name').value = data.name || '';
                        $('profile-designation').value = data.designation || '';
                    } else if (data.status === 'pending') {
                        // User is pending verification
                        showPage('verification');
                    } else if (data.status === 'approved') {
                        // User is approved
                        setupUIForRole(currentUserRole);
                        attachDataListeners(userId, currentUserRole);
                        updateHeaderUI(true);
                    } else if (data.status === 'suspended') {
                        // User is suspended
                        await signOut(auth);
                        alert('Your account is suspended.');
                    }
                } else {
                    // This should not happen if registration is correct
                    console.error('User role document not found!');
                    await signOut(auth);
                }
            } catch (error) {
                console.error("Error checking user role: ", error);
                showPage('auth');
            }
        }

        function setupUIForRole(role) {
            if (role === 'manager' || role === 'superuser') {
                showPage('managerInterface');
                showManagerPage('dashboard'); // Default page
                
                // Show/hide superuser features
                if (role === 'superuser') {
                    managerNav.import.classList.remove('hidden');
                }
                
            } else if (role === 'user') {
                showPage('userInterface');
                showUserPage('inventory'); // Default page
            }
        }
        
        function updateHeaderUI(isLoggedIn) {
            if (isLoggedIn && currentUserProfile) {
                $('user-info-header').classList.remove('hidden');
                $('user-details-header').textContent = `User: ${currentUserProfile.name} (Emp ID: ${currentUserProfile.empId})`;
                $('user-role-header').textContent = `Role: ${currentUserRole}`;
                $('user-role-header').className = currentUserRole === 'superuser' ? 'font-bold ml-2 text-yellow-500' : 'font-bold ml-2 text-red-600';
            } else {
                $('user-info-header').classList.add('hidden');
            }
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const empId = $('login-emp-id').value;
            const pin = $('login-pin').value;
            const email = formatEmpId(empId);
            const password = formatPin(pin);
            
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Login error: ", error);
                    $('login-error').textContent = "Invalid Employee ID or PIN.";
                });
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            const empId = $('reg-emp-id').value;
            const pin = $('reg-pin').value;
            const name = $('reg-name').value;
            const designation = $('reg-designation').value;
            
            const email = formatEmpId(empId);
            const password = formatPin(pin);
            $('register-error').textContent = '';

            try {
                // Check if user (empId) already exists in roles
                const roleQuery = query(getUserRolesCollection(), where("empId", "==", empId));
                const querySnapshot = await getDocs(roleQuery);
                if (!querySnapshot.empty) {
                    $('register-error').textContent = 'Employee ID already registered.';
                    return;
                }

                // 1. Create auth user
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. Create user role document
                await setDoc(getUserRoleDoc(user.uid), {
                    uid: user.uid,
                    empId: empId,
                    name: name,
                    designation: designation,
                    role: 'user', // All new users are 'user'
                    status: 'pending', // All new users are 'pending'
                    joined: Timestamp.now()
                });
                
                // 3. Log activity
                await logActivity('User Registered', { 
                    newUserId: user.uid, 
                    newUserName: name, 
                    newUserEmpId: empId 
                });
                
                // Success, user is logged in but will be routed to pending page
                
            } catch (error) {
                console.error("Register error: ", error);
                if (error.code === 'auth/email-already-in-use') {
                    $('register-error').textContent = 'Employee ID already registered.';
                } else {
                    $('register-error').textContent = 'Registration failed. Try again.';
                }
            }
        }
        
        async function handleProfileCompletion(e) {
            e.preventDefault();
            const name = $('profile-name').value;
            const designation = $('profile-designation').value;
            
            if (!name || !designation) {
                $('profile-completion-error').textContent = 'Please fill out all fields.';
                return;
            }
            
            try {
                await updateDoc(getUserRoleDoc(currentUserId), {
                    name: name,
                    designation: designation
                });
                // Re-check role to proceed
                await checkUserRole(currentUserId);
            } catch (error) {
                console.error("Profile completion error: ", error);
                $('profile-completion-error').textContent = 'Error saving profile.';
            }
        }
        
        function handleLogout() {
            signOut(auth).catch(error => console.error("Logout error: ", error));
        }

        // --- Data Listeners ---
        
        function attachPublicInventoryListener() {
             // Detach old one if exists
            if (inventoryListener) inventoryListener();
            
            const q = query(getInventoryCollection()); 
            inventoryListener = onSnapshot(q, (snapshot) => {
                globalInventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                globalInventory = sortByName(globalInventory); // Sort public list
                renderPublicInventory();
            }, (error) => {
                console.error("Error fetching public inventory: ", error);
                $('public-inventory-empty').innerHTML = '<p class="text-red-500">Could not load inventory.</p>';
            });
        }
        
        function attachDataListeners(userId, role) {
            // Detach any existing listeners (e.g., the public one)
            detachAllListeners();

            // 1. Inventory Listener (everyone needs this)
            const invQuery = query(getInventoryCollection());
            inventoryListener = onSnapshot(invQuery, (snapshot) => {
                globalInventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort data *after* fetching
                globalInventory = sortByName(globalInventory);
                
                if (role === 'user') {
                    renderUserInventory();
                } else if (role === 'manager' || role === 'superuser') {
                    renderManagerInventory();
                    updateDashboardStats(); // Update dashboard
                }
                // No need to call renderPublicInventory, as we are logged in
            }, (error) => console.error("Inventory listener error: ", error));
            
            // 2. Cart Listener (User only)
            if (role === 'user') {
                const cartQuery = query(getUserCartCollection(userId));
                cartListener = onSnapshot(cartQuery, (snapshot) => {
                    const cartItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserCart(cartItems);
                }, (error) => console.error("Cart listener error: ", error));
            }
            
            // 3. Requests Listener
            let reqQuery;
            if (role === 'user') {
                // User sees their own requests
                reqQuery = query(getRequestsCollection(), where("userId", "==", userId), orderBy("timestamp", "desc"));
            } else {
                // Manager/Super sees all requests
                reqQuery = query(getRequestsCollection(), orderBy("timestamp", "desc"));
            }
            requestsListener = onSnapshot(reqQuery, (snapshot) => {
                globalRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (role === 'user') {
                    renderUserRequestHistory();
                } else {
                    renderManagerRequestList();
                    updateDashboardStats(); // Update dashboard
                }
            }, (error) => {
                console.error("Requests listener error: ", error);
                if (role === 'user') {
                    $('user-request-history-error').textContent = 'Error loading history. A one-time database index setup may be required by your admin (see guide).';
                    $('user-request-history-error').classList.remove('hidden');
                } else {
                     $('manager-request-list-error').textContent = 'Error loading requests. A one-time database index setup may be required (see guide).';
                     $('manager-request-list-error').classList.remove('hidden');
                }
            });

            // 4. Listeners for Manager/Superuser
            if (role === 'manager' || role === 'superuser') {
                // User Roles Listener
                const usersQuery = query(getUserRolesCollection());
                usersListener = onSnapshot(usersQuery, (snapshot) => {
                    globalUsers = snapshot.docs.map(doc => doc.data());
                    globalUsers = sortByName(globalUsers); // Sort manually
                    renderManagerUserList();
                    updateDashboardStats(); // Update dashboard
                }, (error) => console.error("Users listener error: ", error));

                // Activity Log Listener
                const logQuery = query(getLogCollection(), orderBy("timestamp", "desc"), limit(200)); // Get last 200 logs
                logListener = onSnapshot(logQuery, (snapshot) => {
                    globalLogs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderManagerLog();
                }, (error) => {
                    console.error("Log listener error: ", error);
                    $('manager-log-error').textContent = 'Error loading log. A one-time database index setup may be required (see guide).';
                    $('manager-log-error').classList.remove('hidden');
                });
            }
        }
        
        function detachAllListeners() {
            if (inventoryListener) inventoryListener();
            if (cartListener) cartListener();
            if (requestsListener) requestsListener();
            if (usersListener) usersListener();
            if (logListener) logListener();
            
            inventoryListener = null;
            cartListener = null;
            requestsListener = null;
            usersListener = null;
            logListener = null;
        }


        // --- Public Page ---
        
        function renderPublicInventory(filter = 'all') {
            const tableBody = $('public-inventory-table-body');
            const emptyMsg = $('public-inventory-empty');
            const lastUpdated = $('public-last-updated');

            if (globalInventory.length === 0) {
                tableBody.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                lastUpdated.textContent = 'N/A';
                return;
            }
            
            emptyMsg.classList.add('hidden');
            
            let filteredInventory = globalInventory;

            if (filter === 'in_stock') {
                filteredInventory = globalInventory.filter(item => item.stock > item.lowStockThreshold);
            } else if (filter === 'low_stock') {
                filteredInventory = globalInventory.filter(item => item.stock <= item.lowStockThreshold && item.stock > 0);
            } else if (filter === 'out_of_stock') {
                filteredInventory = globalInventory.filter(item => item.stock === 0);
            }
            
            // Find the most recent update
            const mostRecentUpdate = globalInventory.reduce((latest, item) => {
                return (item.lastUpdate && item.lastUpdate.timestamp > (latest?.timestamp || 0)) ? item.lastUpdate : latest;
            }, null);
            lastUpdated.textContent = mostRecentUpdate ? formatTimestamp(mostRecentUpdate.timestamp) : 'N/A';
            
            tableBody.innerHTML = filteredInventory.map(item => {
                let stockClass = 'text-gray-900';
                let stockStatus = '';
                if (item.stock === 0) {
                    stockClass = 'text-red-600 font-bold';
                    stockStatus = '(Out of Stock)';
                } else if (item.stock <= item.lowStockThreshold) {
                    stockClass = 'text-yellow-600 font-bold';
                    stockStatus = '(Low Stock)';
                }

                let lastUpdateHtml = 'N/A';
                if (item.lastUpdate) {
                    const verb = item.lastUpdate.type === 'add' ? 'Added' : 'Retrieved';
                    lastUpdateHtml = `${verb} ${item.lastUpdate.quantity} by ${item.lastUpdate.userName}<br><span class="text-xs text-gray-500">${formatTimestamp(item.lastUpdate.timestamp)}</span>`;
                }

                return `
                    <tr class="public-inventory-item" data-id="${item.id}">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${item.name}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm text-gray-700">${item.itemCode || 'N/A'}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm text-gray-700">${item.category || 'N/A'}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <div class="text-sm ${stockClass}">${item.stock} <span class="text-xs">${stockStatus}</span></div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm text-gray-700">${lastUpdateHtml}</div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function setupPublicFilterPills() {
            const pills = document.querySelectorAll('.filter-pill');
            const filters = {
                'filter-all': 'all',
                'filter-in-stock': 'in_stock',
                'filter-low-stock': 'low_stock',
                'filter-out-of-stock': 'out_of_stock'
            };

            pills.forEach(pill => {
                pill.addEventListener('click', (e) => {
                    // Update active class
                    pills.forEach(p => p.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Get filter value and re-render
                    const filterValue = filters[e.target.id];
                    renderPublicInventory(filterValue);
                });
            });
        }
        

        // --- Regular User Functions ---

        function renderUserInventory(searchTerm = '') {
            const list = $('user-inventory-list');
            const emptyMsg = $('user-inventory-empty');
            
            const lowerSearch = searchTerm.toLowerCase();
            const filtered = globalInventory.filter(item => 
                item.name.toLowerCase().includes(lowerSearch) ||
                (item.itemCode && item.itemCode.toLowerCase().includes(lowerSearch)) ||
                (item.category && item.category.toLowerCase().includes(lowerSearch))
            );

            if (filtered.length === 0) {
                list.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }
            
            emptyMsg.classList.add('hidden');
            list.innerHTML = filtered.map(item => {
                let stockClass = 'text-green-600';
                let stockText = `${item.stock} in stock`;
                let disabled = '';
                
                if (item.stock === 0) {
                    stockClass = 'text-red-600';
                    stockText = 'Out of stock';
                    disabled = 'disabled';
                } else if (item.stock <= item.lowStockThreshold) {
                    stockClass = 'text-yellow-600';
                    stockText = `${item.stock} in stock (Low)`;
                }
                
                return `
                    <div class="border rounded-lg p-4 bg-white shadow-sm">
                        <h3 class="font-bold text-lg">${item.name}</h3>
                        <p class="text-sm text-gray-500">${item.category || 'N/A'} (${item.itemCode || 'N/A'})</p>
                        <p class="text-sm font-medium mt-2 ${stockClass}">${stockText}</p>
                        
                        <div class="mt-4">
                            <label for="qty-${item.id}" class="text-xs font-medium text-gray-700">Quantity</label>
                            <input type="number" id="qty-${item.id}" class="form-input w-20 p-1.5" min="1" max="${item.stock}" value="1" ${disabled}>
                            <button data-id="${item.id}" class="add-to-cart-btn btn btn-primary py-1.5 px-3 ml-2 text-sm w-auto" ${disabled}>
                                Add to List
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function handleAddToCart(e) {
            const itemId = e.target.dataset.id;
            const item = globalInventory.find(i => i.id === itemId);
            const quantity = parseInt($(`qty-${itemId}`).value);
            
            if (!item) return;
            if (isNaN(quantity) || quantity <= 0) {
                showToast('Please enter a valid quantity.', true);
                return;
            }
            if (quantity > item.stock) {
                showToast('Not enough items in stock.', true);
                return;
            }
            
            try {
                // Check if item is already in cart
                const cartDocRef = getUserCartDoc(currentUserId, itemId);
                const cartDoc = await getDoc(cartDocRef);
                
                let newQuantity = quantity;
                if (cartDoc.exists()) {
                    newQuantity += cartDoc.data().quantity;
                }
                
                if (newQuantity > item.stock) {
                    showToast(`Cannot add ${quantity}. You have ${cartDoc.data().quantity} in your list and stock is ${item.stock}.`, true);
                    return;
                }
                
                await setDoc(cartDocRef, {
                    itemId: item.id,
                    name: item.name,
                    itemCode: item.itemCode || 'N/A',
                    category: item.category || 'N/A',
                    quantity: newQuantity,
                    remark: cartDoc.exists() ? cartDoc.data().remark : '' // Preserve existing remark
                });
                
                showToast(`${item.name} added to request list.`);
                
            } catch (error) {
                console.error("Error adding to cart: ", error);
                showToast('Could not add item.', true);
            }
        }
        
        function renderUserCart(cartItems) {
            const itemsContainer = $('user-cart-items');
            const emptyMsg = $('user-cart-empty');
            const checkoutSection = $('user-cart-checkout-section');
            $('user-cart-count').textContent = cartItems.length;

            if (cartItems.length === 0) {
                itemsContainer.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                checkoutSection.classList.add('hidden');
                return;
            }
            
            emptyMsg.classList.add('hidden');
            checkoutSection.classList.remove('hidden');
            
            itemsContainer.innerHTML = cartItems.map(item => {
                const inventoryItem = globalInventory.find(i => i.id === item.itemId);
                const stock = inventoryItem ? inventoryItem.stock : 0;
                
                return `
                    <div class="border-b py-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold">${item.name}</h4>
                                <p class="text-sm text-gray-500">${item.category} (${item.itemCode})</p>
                            </div>
                            <button data-id="${item.id}" class="remove-from-cart-btn text-red-500 hover:text-red-700 text-sm font-medium">Remove</button>
                        </div>
                        <div class="flex items-center mt-2">
                            <label for="cart-qty-${item.id}" class="text-sm mr-2">Qty:</label>
                            <input type="number" id="cart-qty-${item.id}" data-id="${item.id}" class="cart-qty-update form-input w-20 p-1.5" min="1" max="${stock}" value="${item.quantity}">
                        </div>
                        <div class="mt-2">
                            <label for="cart-remark-${item.id}" class="text-sm">Remark:</label>
                            <input type="text" id="cart-remark-${item.id}" data-id="${item.id}" class="cart-remark-update form-input p-1.5" value="${item.remark || ''}" placeholder="Add a remark...">
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateCartQuantity(itemId, newQuantity) {
            if (newQuantity <= 0) {
                await deleteDoc(getUserCartDoc(currentUserId, itemId));
            } else {
                await updateDoc(getUserCartDoc(currentUserId, itemId), { quantity: newQuantity });
            }
        }

        async function updateCartRemark(itemId, newRemark) {
            await updateDoc(getUserCartDoc(currentUserId, itemId), { remark: newRemark });
        }

        async function removeFromCart(itemId) {
            await deleteDoc(getUserCartDoc(currentUserId, itemId));
            showToast('Item removed from list.');
        }

        async function handleSubmitOrder(e) {
            e.preventDefault();
            const supervisor = $('checkout-supervisor').value;
            if (!supervisor) {
                showToast('Please enter the supervisor\'s name.', true);
                return;
            }

            try {
                // This transaction is critical. It must follow the "reads before writes" rule.
                const newOrderId = await runTransaction(db, async (transaction) => {
                    const cartCollectionRef = getUserCartCollection(currentUserId);
                    const cartSnapshot = await getDocs(cartCollectionRef);
                    
                    if (cartSnapshot.empty) {
                        throw new Error("Your request list is empty.");
                    }

                    const cartItems = cartSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // --- 1. READS ---
                    const stockChecks = [];
                    for (const item of cartItems) {
                        const invDocRef = getInventoryDoc(item.itemId);
                        stockChecks.push(transaction.get(invDocRef));
                    }
                    const inventoryDocs = await Promise.all(stockChecks);
                    
                    // --- 2. VALIDATION ---
                    const itemsToUpdate = [];
                    const orderItems = [];
                    
                    for (let i = 0; i < inventoryDocs.length; i++) {
                        const invDoc = inventoryDocs[i];
                        const cartItem = cartItems[i];
                        
                        if (!invDoc.exists()) {
                            throw new Error(`Item "${cartItem.name}" no longer exists.`);
                        }
                        
                        const invData = invDoc.data();
                        if (invData.stock < cartItem.quantity) {
                            throw new Error(`Not enough stock for "${cartItem.name}". Available: ${invData.stock}`);
                        }
                        
                        const newStock = invData.stock - cartItem.quantity;
                        itemsToUpdate.push({ ref: invDoc.ref, newStock: newStock });
                        
                        orderItems.push({
                            itemId: cartItem.itemId,
                            name: cartItem.name,
                            itemCode: cartItem.itemCode,
                            category: cartItem.category,
                            quantity: cartItem.quantity,
                            remark: cartItem.remark || ''
                        });
                    }

                    // --- 3. WRITES ---
                    
                    // a. Create the new request document
                    const orderData = {
                        userId: currentUserId,
                        userName: currentUserProfile.name,
                        userEmpId: currentUserProfile.empId,
                        userDesignation: currentUserProfile.designation,
                        items: orderItems,
                        supervisor: supervisor,
                        timestamp: Timestamp.now(),
                        status: 'Completed'
                    };
                    const newRequestRef = doc(collection(getRequestsCollection()));
                    transaction.set(newRequestRef, orderData);

                    // b. Update inventory stock
                    const lastUpdateInfo = {
                        type: 'retrieve',
                        userName: currentUserProfile.name,
                        timestamp: Timestamp.now()
                    };
                    
                    for (const item of itemsToUpdate) {
                        // Find the quantity for this item to log it
                        const matchingCartItem = cartItems.find(cartItem => cartItem.itemId === item.ref.id);
                        transaction.update(item.ref, { 
                            stock: item.newStock,
                            lastUpdate: { ...lastUpdateInfo, quantity: matchingCartItem.quantity }
                        });
                    }
                    
                    // c. Delete cart items
                    for (const doc of cartSnapshot.docs) {
                        transaction.delete(doc.ref);
                    }
                    
                    // d. Log activities
                    // We can't use await addDoc inside a transaction, so we log outside *after* success
                    
                    return { orderId: newRequestRef.id, orderData };
                });
                
                // --- 4. LOGGING (after successful transaction) ---
                
                // a. Log the main request
                await logActivity('Request Placed', {
                    requestId: newOrderId.orderId,
                    itemCount: newOrderId.orderData.items.length,
                    supervisor: supervisor
                });
                
                // b. Log each item withdrawal
                for (const item of newOrderId.orderData.items) {
                    await logActivity('Item Withdrawn', {
                        itemId: item.itemId,
                        itemName: item.name,
                        quantity: item.quantity,
                        requestId: newOrderId.orderId
                    });
                }

                // Show success
                showWithdrawalSlip(newOrderId.orderId, newOrderId.orderData, true);

            } catch (error) {
                console.error("Error submitting order: ", error);
                showToast(`Error: ${error.message}`, true);
            }
        }
        
        function renderUserRequestHistory(searchTerm = '') {
            const list = $('user-request-history-list');
            const emptyMsg = $('user-request-history-empty');
            const errorMsg = $('user-request-history-error');
            
            if (globalRequests.length === 0 && !errorMsg.textContent) {
                list.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }
            
            emptyMsg.classList.add('hidden');
            list.innerHTML = globalRequests.map(req => {
                return `
                    <div class="border rounded-lg p-4 bg-white shadow-sm">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-gray-800">Request ID: ${req.id.substring(0, 6)}...</p>
                            <p class="text-sm text-gray-500">${formatTimestamp(req.timestamp)}</p>
                        </div>
                        <p class="text-sm text-gray-600">${req.items.length} item(s) - Supervised by ${req.supervisor}</p>
                        <button data-id="${req.id}" class="view-request-btn btn btn-outline btn-sm w-auto py-1 px-3 mt-2 text-xs">View Slip</button>
                    </div>
                `;
            }).join('');
        }
        
        function handleProfileUpdate(e) {
            e.preventDefault();
            const formId = e.target.id;
            
            let name, designation, successMsg;
            if (formId === 'user-profile-form') {
                name = $('profile-name-display').value;
                designation = $('profile-designation-display').value;
                successMsg = $('profile-update-success');
            } else {
                name = $('manager-profile-name-display').value;
                designation = $('manager-profile-designation-display').value;
                successMsg = $('manager-profile-update-success');
            }
            
            updateDoc(getUserRoleDoc(currentUserId), {
                name: name,
                designation: designation
            })
            .then(() => {
                // Update local profile
                currentUserProfile.name = name;
                currentUserProfile.designation = designation;
                
                // Update header
                updateHeaderUI(true);
                
                successMsg.textContent = 'Profile updated successfully!';
                setTimeout(() => successMsg.textContent = '', 3000);
            })
            .catch(error => {
                console.error("Profile update error: ", error);
                successMsg.textContent = 'Error updating profile.';
            });
        }


        // --- Manager/Superuser Functions ---

        function updateDashboardStats() {
            $('dashboard-pending-users').textContent = globalUsers.filter(u => u.status === 'pending').length;
            $('dashboard-low-stock-items').textContent = globalInventory.filter(i => i.stock <= i.lowStockThreshold && i.stock > 0).length;
            $('dashboard-total-requests').textContent = globalRequests.length;
        }

        function renderManagerInventory(searchTerm = '') {
            const list = $('manager-inventory-list');
            const emptyMsg = $('manager-inventory-empty');
            
            const lowerSearch = searchTerm.toLowerCase();
            const filtered = globalInventory.filter(item => 
                item.name.toLowerCase().includes(lowerSearch) ||
                (item.itemCode && item.itemCode.toLowerCase().includes(lowerSearch)) ||
                (item.category && item.category.toLowerCase().includes(lowerSearch))
            );
            
            if (filtered.length === 0) {
                list.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }
            
            emptyMsg.classList.add('hidden');
            list.innerHTML = filtered.map(item => {
                 let stockClass = 'text-gray-900';
                if (item.stock === 0) {
                    stockClass = 'text-red-600 font-bold';
                } else if (item.stock <= item.lowStockThreshold) {
                    stockClass = 'text-yellow-600 font-bold';
                }
                
                return `
                    <div class="border rounded-lg p-3 bg-white shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-center">
                            <div>
                                <p class="font-bold text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.category || 'N/A'} (${item.itemCode || 'N/A'})</p>
                            </div>
                            <div>
                                <p class="text-sm">Stock: <span class="${stockClass}">${item.stock}</span></p>
                                <p class="text-xs text-gray-500">Low Stock at: ${item.lowStockThreshold}</p>
                            </div>
                            <!-- Actions -->
                            <div class="md:col-span-2 flex flex-wrap gap-2">
                                <button data-id="${item.id}" class="add-stock-btn btn btn-primary w-auto text-xs py-1.5 px-3">Add Stock</button>
                                <button data-id="${item.id}" class="edit-name-btn btn btn-outline w-auto text-xs py-1.5 px-3">Edit</button>
                                <button data-id="${item.id}" data-name="${item.name}" class="view-history-btn btn btn-secondary w-auto text-xs py-1.5 px-3">View History</button>
                                ${currentUserRole === 'superuser' ? `<button data-id="${item.id}" class="delete-item-btn btn btn-danger w-auto text-xs py-1.5 px-3">Delete</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function handleShowAddItemModal() {
            addItemModal.form.reset();
            addItemModal.title.textContent = 'Add New Item';
            addItemModal.error.textContent = '';
            addItemModal.form.dataset.editId = ''; // Clear edit ID
            addItemModal.modal.classList.remove('hidden');
        }

        async function handleAddItemForm(e) {
            e.preventDefault();
            const name = addItemModal.name.value;
            const code = addItemModal.code.value;
            const category = addItemModal.category.value;
            const stock = parseInt(addItemModal.stock.value);
            const lowStock = parseInt(addItemModal.lowStock.value);
            
            if (!name || !code || !category || isNaN(stock) || isNaN(lowStock)) {
                addItemModal.error.textContent = 'Please fill all fields correctly.';
                return;
            }

            const itemData = {
                name,
                itemCode: code,
                category,
                stock,
                lowStockThreshold: lowStock,
                lastUpdate: {
                    type: 'add',
                    quantity: stock,
                    userName: currentUserProfile.name,
                    timestamp: Timestamp.now()
                }
            };
            
            try {
                // Check if item code already exists
                const q = query(getInventoryCollection(), where("itemCode", "==", code));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    addItemModal.error.textContent = 'Item Code already exists.';
                    return;
                }
                
                const docRef = await addDoc(getInventoryCollection(), itemData);
                
                await logActivity('Item Added', { 
                    itemId: docRef.id, 
                    itemName: name,
                    itemCode: code,
                    quantity: stock 
                });
                
                addItemModal.modal.classList.add('hidden');
                showToast('Item added successfully.');
                
            } catch (error) {
                console.error("Error adding item: ", error);
                addItemModal.error.textContent = 'Error adding item.';
            }
        }
        
        function handleShowAddStockModal(e) {
            const itemId = e.target.dataset.id;
            const item = globalInventory.find(i => i.id === itemId);
            if (!item) return;
            
            $('add-stock-modal').classList.remove('hidden');
            $('add-stock-item-name').textContent = item.name;
            $('add-stock-form').dataset.itemId = itemId;
            $('add-stock-form').reset();
        }

        async function handleAddStockForm(e) {
            e.preventDefault();
            const itemId = e.target.dataset.itemId;
            const quantity = parseInt($('add-stock-quantity').value);
            const item = globalInventory.find(i => i.id === itemId);

            if (isNaN(quantity) || quantity <= 0) {
                showToast('Please enter a valid quantity.', true);
                return;
            }

            try {
                const newStock = item.stock + quantity;
                await updateDoc(getInventoryDoc(itemId), {
                    stock: newStock,
                    lastUpdate: {
                        type: 'add',
                        quantity: quantity,
                        userName: currentUserProfile.name,
                        timestamp: Timestamp.now()
                    }
                });
                
                await logActivity('Stock Added', {
                    itemId: itemId,
                    itemName: item.name,
                    quantity: quantity,
                    newStock: newStock
                });
                
                $('add-stock-modal').classList.add('hidden');
                showToast('Stock added successfully.');
                
            } catch (error) {
                console.error("Error adding stock: ", error);
                showToast('Error adding stock.', true);
            }
        }
        
        function handleShowEditNameModal(e) {
            const itemId = e.target.dataset.id;
            const item = globalInventory.find(i => i.id === itemId);
            if (!item) return;

            $('edit-name-modal').classList.remove('hidden');
            $('edit-name-form').dataset.itemId = itemId;
            $('edit-item-name').value = item.name;
            $('edit-item-code').value = item.itemCode || '';
            $('edit-item-category').value = item.category || '';
            $('edit-item-low-stock').value = item.lowStockThreshold;
        }

        async function handleEditNameForm(e) {
            e.preventDefault();
            const itemId = e.target.dataset.itemId;
            const item = globalInventory.find(i => i.id === itemId);
            
            const newName = $('edit-item-name').value;
            const newCode = $('edit-item-code').value;
            const newCategory = $('edit-item-category').value;
            const newLowStock = parseInt($('edit-item-low-stock').value);

            try {
                // Check if new item code already exists (and it's not this item)
                const q = query(getInventoryCollection(), where("itemCode", "==", newCode));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty && querySnapshot.docs[0].id !== itemId) {
                    showToast('That Item Code is already used by another item.', true);
                    return;
                }

                await updateDoc(getInventoryDoc(itemId), {
                    name: newName,
                    itemCode: newCode,
                    category: newCategory,
                    lowStockThreshold: newLowStock
                });
                
                await logActivity('Item Edited', {
                    itemId: itemId,
                    oldName: item.name,
                    newName: newName,
                    oldCode: item.itemCode,
                    newCode: newCode,
                    oldCategory: item.category,
                    newCategory: newCategory
                });
                
                $('edit-name-modal').classList.add('hidden');
                showToast('Item updated successfully.');
                
            } catch (error) {
                console.error("Error updating item: ", error);
                showToast('Error updating item.', true);
            }
        }

        async function handleShowItemHistory(e) {
            const itemId = e.target.dataset.id;
            const itemName = e.target.dataset.name;

            $('item-history-modal').classList.remove('hidden');
            $('item-history-item-name').textContent = itemName;
            const list = $('item-history-list');
            const emptyMsg = $('item-history-empty');
            const errorMsg = $('item-history-error');
            
            list.innerHTML = '<p class="text-gray-500 text-center">Loading...</p>';
            emptyMsg.classList.add('hidden');
            errorMsg.classList.add('hidden');

            try {
                // Query log for actions related to this itemId
                const q = query(
                    getLogCollection(), 
                    where("itemId", "==", itemId),
                    orderBy("timestamp", "desc")
                );
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    list.innerHTML = '';
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                
                const historyLogs = snapshot.docs.map(doc => doc.data());
                list.innerHTML = historyLogs.map(log => {
                    let actionText = '';
                    switch(log.action) {
                        case 'Item Added':
                            actionText = `<span class="font-medium text-green-600">Item Created</span> with ${log.quantity} stock.`;
                            break;
                        case 'Stock Added':
                            actionText = `<span class="font-medium text-green-600">Added ${log.quantity}</span> stock. (New total: ${log.newStock})`;
                            break;
                        case 'Item Withdrawn':
                            actionText = `<span class="font-medium text-red-600">Retrieved ${log.quantity}</span>. (Req ID: ${log.requestId.substring(0,6)}...)`;
                            break;
                        case 'Item Edited':
                            actionText = `<span class="font-medium text-blue-600">Item details edited.</span>`;
                            break;
                        default:
                            return ''; // Don't show other logs
                    }
                    
                    return `
                        <div class="border-b pb-2 text-sm">
                            <p>${actionText}</p>
                            <p class="text-xs text-gray-500">By: ${log.userName} on ${formatTimestamp(log.timestamp)}</p>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error("Error getting item history: ", error);
                list.innerHTML = '';
                errorMsg.textContent = 'Could not load history. Database index may be required (see guide).';
                errorMsg.classList.remove('hidden');
            }
        }
        
        function handleDeleteItem(e) {
            const itemId = e.target.dataset.id;
            const item = globalInventory.find(i => i.id === itemId);
            
            showConfirmation('Delete Item?', `Are you sure you want to delete "${item.name}"? This is permanent.`, async () => {
                try {
                    await deleteDoc(getInventoryDoc(itemId));
                    await logActivity('Item Deleted', { 
                        itemId: itemId, 
                        itemName: item.name 
                    });
                    showToast('Item deleted.');
                } catch (error) {
                    console.error("Error deleting item: ", error);
                    showToast('Error deleting item.', true);
                }
                hideConfirmation();
            });
        }
        
        function renderManagerRequestList(searchTerm = '') {
            const list = $('manager-request-list');
            const emptyMsg = $('manager-request-list-empty');
            const errorMsg = $('manager-request-list-error');

            const lowerSearch = searchTerm.toLowerCase();
            const filtered = globalRequests.filter(req =>
                req.userName.toLowerCase().includes(lowerSearch) ||
                req.userEmpId.toLowerCase().includes(lowerSearch) ||
                req.id.toLowerCase().includes(lowerSearch)
            );
            
            if (filtered.length === 0 && !errorMsg.textContent) {
                list.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }
            
            emptyMsg.classList.add('hidden');
            list.innerHTML = filtered.map(req => {
                return `
                    <div class="border rounded-lg p-4 bg-white shadow-sm">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-gray-800">User: ${req.userName} (ID: ${req.userEmpId})</p>
                            <p class="text-sm text-gray-500">${formatTimestamp(req.timestamp)}</p>
                        </div>
                        <p class="text-sm text-gray-600">${req.items.length} item(s) - Supervised by ${req.supervisor}</p>
                        <p class="text-xs text-gray-400 mt-1">Request ID: ${req.id}</p>
                        <button data-id="${req.id}" class="view-request-btn btn btn-outline btn-sm w-auto py-1 px-3 mt-2 text-xs">View Slip</button>
                        ${currentUserRole === 'superuser' ? `<button data-id="${req.id}" class="delete-request-btn btn btn-danger btn-sm w-auto py-1 px-3 mt-2 ml-2 text-xs">Delete</button>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function handleDeleteRequest(e) {
            const requestId = e.target.dataset.id;
            
            showConfirmation('Delete Request?', `Are you sure you want to delete this request slip (ID: ${requestId.substring(0,6)}...)? This is permanent.`, async () => {
                try {
                    await deleteDoc(getRequestDoc(requestId));
                    await logActivity('Request Deleted', { 
                        requestId: requestId
                    });
                    showToast('Request slip deleted.');
                } catch (error) {
                    console.error("Error deleting request: ", error);
                    showToast('Error deleting request.', true);
                }
                hideConfirmation();
            });
        }

        function renderManagerUserList(searchTerm = '') {
            const list = $('manager-user-list');
            
            const lowerSearch = searchTerm.toLowerCase();
            const filtered = globalUsers.filter(user =>
                user.name.toLowerCase().includes(lowerSearch) ||
                user.empId.toLowerCase().includes(lowerSearch)
            );
            
            list.innerHTML = filtered.map(user => {
                let statusBadge = '';
                if (user.status === 'pending') {
                    statusBadge = '<span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Pending</span>';
                } else if (user.status === 'approved') {
                    statusBadge = '<span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Approved</span>';
                } else if (user.status === 'suspended') {
                    statusBadge = '<span class="text-xs font-medium bg-red-100 text-red-800 px-2 py-0.5 rounded-full">Suspended</span>';
                }
                
                let roleSelect = '';
                if (currentUserRole === 'superuser' && user.uid !== currentUserId) {
                    roleSelect = `
                        <select data-id="${user.uid}" class="update-role-select form-input p-1.5 text-xs w-auto">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                            <option value="superuser" ${user.role === 'superuser' ? 'selected' : ''}>Superuser</option>
                        </select>
                    `;
                } else {
                    roleSelect = `<span class="text-sm font-medium">${user.role}</span>`;
                }
                
                return `
                    <div class="border rounded-lg p-3 bg-white shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-center">
                            <div>
                                <p class="font-bold text-gray-800">${user.name}</p>
                                <p class="text-sm text-gray-500">ID: ${user.empId}</p>
                                <p class="text-sm text-gray-500">${user.designation}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${statusBadge}
                                ${roleSelect}
                            </div>
                            <div class="md:col-span-2 flex flex-wrap gap-2">
                                ${user.status === 'pending' ? `<button data-id="${user.uid}" class="approve-user-btn btn btn-primary w-auto text-xs py-1.5 px-3">Approve</button>` : ''}
                                ${user.status === 'approved' && user.uid !== currentUserId ? `<button data-id="${user.uid}" class="suspend-user-btn btn btn-outline w-auto text-xs py-1.5 px-3">Suspend</button>` : ''}
                                ${user.status === 'suspended' && user.uid !== currentUserId ? `<button data-id="${user.uid}" class="approve-user-btn btn btn-primary w-auto text-xs py-1.5 px-3">Re-Approve</button>` : ''}
                                ${currentUserRole === 'superuser' && user.uid !== currentUserId ? `<button data-id="${user.uid}" class="delete-user-btn btn btn-danger w-auto text-xs py-1.5 px-3">Delete</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function handleApproveUser(e) {
            const userIdToApprove = e.target.dataset.id;
            const user = globalUsers.find(u => u.uid === userIdToApprove);
            
            try {
                await updateDoc(getUserRoleDoc(userIdToApprove), {
                    status: 'approved'
                });
                await logActivity('User Approved', { 
                    approvedUserId: userIdToApprove,
                    approvedUserName: user.name
                });
                showToast('User approved.');
            } catch (error) {
                console.error("Error approving user: ", error);
                showToast('Error approving user.', true);
            }
        }
        
        async function handleSuspendUser(e) {
            const userIdToSuspend = e.target.dataset.id;
            const user = globalUsers.find(u => u.uid === userIdToSuspend);

            showConfirmation('Suspend User?', `Are you sure you want to suspend ${user.name}? They will not be able to log in.`, async () => {
                try {
                    await updateDoc(getUserRoleDoc(userIdToSuspend), {
                        status: 'suspended'
                    });
                    await logActivity('User Suspended', { 
                        suspendedUserId: userIdToSuspend,
                        suspendedUserName: user.name
                    });
                    showToast('User suspended.');
                } catch (error) {
                    console.error("Error suspending user: ", error);
                    showToast('Error suspending user.', true);
                }
                hideConfirmation();
            });
        }
        
        async function handleUpdateRole(e) {
            const userIdToUpdate = e.target.dataset.id;
            const newRole = e.target.value;
            const user = globalUsers.find(u => u.uid === userIdToUpdate);
            
            showConfirmation('Change User Role?', `Are you sure you want to change ${user.name}'s role to ${newRole}?`, async () => {
                try {
                    await updateDoc(getUserRoleDoc(userIdToUpdate), {
                        role: newRole
                    });
                    await logActivity('User Role Changed', { 
                        updatedUserId: userIdToUpdate,
                        updatedUserName: user.name,
                        newRole: newRole
                    });
                    showToast('User role updated.');
                } catch (error) {
                    console.error("Error updating role: ", error);
                    showToast('Error updating role.', true);
                }
                hideConfirmation();
            });
        }

        function handleDeleteUser(e) {
            const userIdToDelete = e.target.dataset.id;
            const user = globalUsers.find(u => u.uid === userIdToDelete);
            
            showConfirmation('Delete User?', `This will delete all app data (profile, cart) for ${user.name}. You must *also* manually delete their login from the Firebase Authentication console.`, async () => {
                try {
                    // 1. Delete user role/profile
                    await deleteDoc(getUserRoleDoc(userIdToDelete));
                    
                    // 2. Delete user's cart (if any)
                    const cartCollectionRef = getUserCartCollection(userIdToDelete);
                    const cartSnapshot = await getDocs(cartCollectionRef);
                    const batch = writeBatch(db);
                    cartSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    
                    await logActivity('User Deleted', { 
                        deletedUserId: userIdToDelete,
                        deletedUserName: user.name
                    });
                    showToast('User app data deleted.');
                } catch (error) {
                    console.error("Error deleting user: ", error);
                    showToast('Error deleting user data.', true);
                }
                hideConfirmation();
            });
        }

        function renderManagerLog(searchTerm = '') {
            const list = $('manager-log-list');
            const emptyMsg = $('manager-log-empty');
            const errorMsg = $('manager-log-error');

            const lowerSearch = searchTerm.toLowerCase();
            const filtered = globalLogs.filter(log =>
                log.action.toLowerCase().includes(lowerSearch) ||
                log.userName.toLowerCase().includes(lowerSearch) ||
                (log.itemName && log.itemName.toLowerCase().includes(lowerSearch)) ||
                (log.newUserName && log.newUserName.toLowerCase().includes(lowerSearch))
            );

            if (filtered.length === 0 && !errorMsg.textContent) {
                list.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }
            
            emptyMsg.classList.add('hidden');
            list.innerHTML = filtered.map(log => {
                let details = '';
                switch(log.action) {
                    case 'User Registered':
                        details = `New user ${log.newUserName} (ID: ${log.newUserEmpId}) registered.`;
                        break;
                    case 'User Approved':
                        details = `Approved user ${log.approvedUserName}.`;
                        break;
                    case 'Item Added':
                        details = `Added item ${log.itemName} (Code: ${log.itemCode}) with ${log.quantity} stock.`;
                        break;
                    case 'Stock Added':
                        details = `Added ${log.quantity} to ${log.itemName}. New stock: ${log.newStock}.`;
                        break;
                    case 'Item Withdrawn':
                        details = `Retrieved ${log.quantity} of ${log.itemName} for request ${log.requestId.substring(0,6)}...`;
                        break;
                    case 'Request Placed':
                        details = `Placed request ${log.requestId.substring(0,6)}... (${log.itemCount} items) supervised by ${log.supervisor}.`;
                        break;
                    case 'Item Edited':
                        details = `Edited item ${log.oldName} (ID: ${log.itemId.substring(0,6)}...).`;
                        break;
                    case 'Item Deleted':
                        details = `Deleted item ${log.itemName} (ID: ${log.itemId.substring(0,6)}...).`;
                        break;
                    case 'User Suspended':
                        details = `Suspended user ${log.suspendedUserName}.`;
                        break;
                    case 'User Role Changed':
                        details = `Changed ${log.updatedUserName}'s role to ${log.newRole}.`;
                        break;
                    case 'User Deleted':
                        details = `Deleted app data for ${log.deletedUserName}.`;
                        break;
                    default:
                        details = `Performed action: ${log.action}`;
                }
                
                return `
                    <div class="border-b py-2 text-sm">
                        <p><span class="font-bold text-red-700">${log.action}</span> - ${details}</p>
                        <p class="text-xs text-gray-500">By: ${log.userName} on ${formatTimestamp(log.timestamp)}
                        ${currentUserRole === 'superuser' ? `<button data-id="${log.id}" class="delete-log-btn text-red-500 hover:underline ml-4">(Delete Log)</button>` : ''}
                        </p>
                    </div>
                `;
            }).join('');
        }
        
        function handleDeleteLog(e) {
            const logId = e.target.dataset.id;
            
            showConfirmation('Delete Log Entry?', `Are you sure you want to delete this log entry? This is permanent.`, async () => {
                try {
                    await deleteDoc(getLogDoc(logId));
                    showToast('Log entry deleted.');
                } catch (error) {
                    console.error("Error deleting log: ", error);
                    showToast('Error deleting log.', true);
                }
                hideConfirmation();
            });
        }
        
        async function handleBulkImport() {
            const jsonText = $('bulk-import-json').value;
            const status = $('bulk-import-status');
            
            let items;
            try {
                items = JSON.parse(jsonText);
                if (!Array.isArray(items)) throw new Error('Not an array.');
            } catch (err) {
                status.textContent = 'Error: Invalid JSON format. Must be an array [...].';
                status.className = 'text-sm mt-2 text-red-600';
                return;
            }
            
            status.textContent = `Importing 0 of ${items.length} items...`;
            status.className = 'text-sm mt-2 text-gray-600';
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const [index, item] of items.entries()) {
                if (!item.name || !item.itemCode || !item.category) {
                    console.error('Skipping item, missing required fields:', item);
                    errorCount++;
                    continue;
                }
                
                try {
                    // Check if itemCode already exists
                    const q = query(getInventoryCollection(), where("itemCode", "==", item.itemCode));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        const itemData = {
                            name: item.name,
                            itemCode: item.itemCode,
                            category: item.category,
                            stock: item.stock || 0,
                            lowStockThreshold: item.lowStockThreshold || 0,
                            lastUpdate: {
                                type: 'add',
                                quantity: item.stock || 0,
                                userName: 'Bulk Import',
                                timestamp: Timestamp.now()
                            }
                        };
                        const docRef = await addDoc(getInventoryCollection(), itemData);
                        
                        await logActivity('Item Added', { 
                            itemId: docRef.id, 
                            itemName: item.name,
                            itemCode: item.itemCode,
                            quantity: item.stock || 0,
                            userName: 'Bulk Import'
                        });
                        
                        successCount++;
                    } else {
                        console.warn(`Skipping item, itemCode ${item.itemCode} already exists.`);
                        errorCount++;
                    }
                    
                    status.textContent = `Importing ${index + 1} of ${items.length} items... (Success: ${successCount}, Failed: ${errorCount})`;

                } catch (err) {
                    console.error('Error importing item:', item, err);
                    errorCount++;
                }
            }
            
            status.textContent = `Import complete! ${successCount} items added, ${errorCount} items failed/skipped.`;
            status.className = 'text-sm mt-2 text-green-600';
            $('bulk-import-json').value = '';
        }

        // --- Withdrawal Slip ---
        
        async function handleViewRequest(e) {
            const requestId = e.target.dataset.id;
            // Find in cache first
            let request = globalRequests.find(r => r.id === requestId);
            
            if (!request) {
                // Not in cache, fetch from DB (should be rare)
                try {
                    const docSnap = await getDoc(getRequestDoc(requestId));
                    if (docSnap.exists()) {
                        request = { id: docSnap.id, ...docSnap.data() };
                    } else {
                        showToast('Error: Request not found.', true);
                        return;
                    }
                } catch (error) {
                    showToast('Error loading request.', true);
                    return;
                }
            }
            
            showWithdrawalSlip(requestId, request, false);
        }
        
        function showWithdrawalSlip(orderId, orderData, isNew = false) {
            const content = $('withdrawal-slip-content');
            const title = $('withdrawal-slip-title');
            
            if (isNew) {
                title.textContent = 'Request Placed Successfully!';
            } else {
                title.textContent = 'Withdrawal Slip';
            }
            
            content.innerHTML = `
                <div class="space-y-2 text-sm text-gray-700">
                    <p><strong>Request ID:</strong> ${orderId}</p>
                    <p><strong>Date:</strong> ${formatTimestamp(orderData.timestamp)}</p>
                    <p><strong>Requested by:</strong> ${orderData.userName} (ID: ${orderData.userEmpId})</p>
                    <p><strong>Designation:</strong> ${orderData.userDesignation}</p>
                    <p><strong>Supervised by:</strong> ${orderData.supervisor}</p>
                </div>
                
                <h4 class="section-header mt-6">Requested Items</h4>
                <div class="border rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Qty</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Remark</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${orderData.items.map(item => `
                                <tr>
                                    <td class="px-4 py-3 text-sm">${item.name}</td>
                                    <td class="px-4 py-3 text-sm">${item.itemCode}</td>
                                    <td class="px-4 py-3 text-sm text-center">${item.quantity}</td>
                                    <td class="px-4 py-3 text-sm">${item.remark || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            showPage('withdrawalSlip');
        }
        
        function handleBackToApp() {
            // Go back to the correct interface
            setupUIForRole(currentUserRole);
        }
        

        // --- Global Event Listeners Setup ---

        function setupGlobalListeners() {
            // Auth
            $('login-form').addEventListener('submit', handleLogin);
            $('register-form').addEventListener('submit', handleRegister);
            $('profile-completion-form').addEventListener('submit', handleProfileCompletion);
            $('show-register-form').addEventListener('click', () => {
                $('login-form-container').classList.add('hidden');
                $('register-form-container').classList.remove('hidden');
                $('login-error').textContent = '';
            });
            $('show-login-form').addEventListener('click', () => {
                $('login-form-container').classList.remove('hidden');
                $('register-form-container').classList.add('hidden');
                $('register-error').textContent = '';
            });
            $('logout-button').addEventListener('click', handleLogout);
            $('logout-button-verification').addEventListener('click', handleLogout);
            $('public-login-button').addEventListener('click', () => showPage('auth'));
            
            // Public filter
            setupPublicFilterPills();

            // Navigation
            Object.keys(userNav).forEach(key => {
                userNav[key].addEventListener('click', (e) => {
                    e.preventDefault();
                    showUserPage(key);
                });
            });
            Object.keys(managerNav).forEach(key => {
                managerNav[key].addEventListener('click', (e) => {
                    e.preventDefault();
                    showManagerPage(key);
                });
            });
            
            // Dashboard shortcuts
            $('dashboard-goto-users').addEventListener('click', () => showManagerPage('users'));
            $('dashboard-goto-inventory').addEventListener('click', () => showManagerPage('inventory'));
            $('dashboard-goto-requests').addEventListener('click', () => showManagerPage('requests'));

            // Confirmation Modal
            confirmationModal.cancelBtn.addEventListener('click', hideConfirmation);
            confirmationModal.confirmBtn.addEventListener('click', () => {
                if (activeConfirmationCallback) activeConfirmationCallback();
            });
            
            // Add Item Modal
            addItemModal.cancelBtn.addEventListener('click', () => addItemModal.modal.classList.add('hidden'));
            addItemModal.form.addEventListener('submit', handleAddItemForm);
            
            // Add Stock Modal
            $('add-stock-cancel-btn').addEventListener('click', () => $('add-stock-modal').classList.add('hidden'));
            $('add-stock-form').addEventListener('submit', handleAddStockForm);
            
            // Edit Name Modal
            $('edit-name-cancel-btn').addEventListener('click', () => $('edit-name-modal').classList.add('hidden'));
            $('edit-name-form').addEventListener('submit', handleEditNameForm);

            // Item History Modal
            $('item-history-close-btn').addEventListener('click', () => $('item-history-modal').classList.add('hidden'));
            
            // Profile Update
            $('user-profile-form').addEventListener('submit', handleProfileUpdate);
            $('manager-profile-form').addEventListener('submit', handleProfileUpdate);
            
            // User Inventory
            $('user-inventory-search').addEventListener('input', (e) => renderUserInventory(e.target.value));
            $('user-inventory-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    handleAddToCart(e);
                }
            });
            
            // User Cart
            $('user-list-page').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-from-cart-btn')) {
                    removeFromCart(e.target.dataset.id);
                }
            });
            $('user-list-page').addEventListener('change', (e) => {
                if (e.target.classList.contains('cart-qty-update')) {
                    updateCartQuantity(e.target.dataset.id, parseInt(e.target.value));
                }
                if (e.target.classList.contains('cart-remark-update')) {
                    updateCartRemark(e.target.dataset.id, e.target.value);
                }
            });
            $('checkout-form').addEventListener('submit', handleSubmitOrder);
            
            // User Requests
            $('user-requests-page').addEventListener('click', (e) => {
                if (e.target.classList.contains('view-request-btn')) {
                    handleViewRequest(e);
                }
            });

            // Withdrawal Slip
            $('withdrawal-slip-back-button').addEventListener('click', handleBackToApp);
            
            // Manager Inventory
            $('show-add-item-modal').addEventListener('click', handleShowAddItemModal);
            $('manager-inventory-search').addEventListener('input', (e) => renderManagerInventory(e.target.value));
            $('manager-inventory-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('add-stock-btn')) handleShowAddStockModal(e);
                if (e.target.classList.contains('edit-name-btn')) handleShowEditNameModal(e);
                if (e.target.classList.contains('view-history-btn')) handleShowItemHistory(e);
                if (e.target.classList.contains('delete-item-btn')) handleDeleteItem(e);
            });
            
            // Manager Requests
            $('manager-request-search').addEventListener('input', (e) => renderManagerRequestList(e.target.value));
            $('manager-requests-page').addEventListener('click', (e) => {
                if (e.target.classList.contains('view-request-btn')) handleViewRequest(e);
                if (e.target.classList.contains('delete-request-btn')) handleDeleteRequest(e);
            });
            
            // Manager Users
            $('manager-user-search').addEventListener('input', (e) => renderManagerUserList(e.target.value));
            $('manager-user-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('approve-user-btn')) handleApproveUser(e);
                if (e.target.classList.contains('suspend-user-btn')) handleSuspendUser(e);
                if (e.target.classList.contains('delete-user-btn')) handleDeleteUser(e);
            });
            $('manager-user-list').addEventListener('change', (e) => {
                 if (e.target.classList.contains('update-role-select')) handleUpdateRole(e);
            });
            
            // Manager Log
            $('manager-log-search').addEventListener('input', (e) => renderManagerLog(e.target.value));
            $('manager-log-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-log-btn')) handleDeleteLog(e);
            });
            
            // Manager Bulk Import
            $('bulk-import-submit').addEventListener('click', handleBulkImport);
            // REMOVED: Bulk Stock Update listener
        }

    </script>
</body>
</html>
